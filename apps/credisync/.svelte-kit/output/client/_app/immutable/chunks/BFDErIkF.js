import{c as a}from"./CanLVora.js";async function E(e={}){const t={enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4,...e};try{if(console.log("üìç [LOCATION] Iniciando captura de GPS..."),!navigator.geolocation)return console.warn("‚ö†Ô∏è [LOCATION] Geolocation no disponible en este navegador"),{location:null,error:"Geolocation no disponible",timestamp:Date.now()};if(navigator.permissions)try{const c=await navigator.permissions.query({name:"geolocation"});if(console.log("üìç [LOCATION] Estado de permisos:",c.state),c.state==="denied")return{location:null,error:"Permisos de ubicaci√≥n denegados",timestamp:Date.now()}}catch(c){console.warn("‚ö†Ô∏è [LOCATION] No se pudo verificar permisos:",c)}const o=await new Promise((c,i)=>{const s=setTimeout(()=>{i(new Error("Timeout capturando ubicaci√≥n"))},t.timeout);navigator.geolocation.getCurrentPosition(r=>{clearTimeout(s),c(r)},r=>{clearTimeout(s),i(r)},{enableHighAccuracy:t.enableHighAccuracy,timeout:t.timeout,maximumAge:t.maximumAge})}),n={latitude:o.coords.latitude,longitude:o.coords.longitude,accuracy:o.coords.accuracy,altitude:o.coords.altitude,altitudeAccuracy:o.coords.altitudeAccuracy,heading:o.coords.heading,speed:o.coords.speed,timestamp:o.timestamp};return console.log("‚úÖ [LOCATION] GPS capturado exitosamente:",{lat:n.latitude.toFixed(6),lng:n.longitude.toFixed(6),accuracy:n.accuracy}),{location:n,error:null,timestamp:Date.now()}}catch(o){console.warn("‚ö†Ô∏è [LOCATION] Error capturando GPS:",o.message);let n="Error desconocido capturando ubicaci√≥n";if(o.code)switch(o.code){case 1:n="Permisos de ubicaci√≥n denegados";break;case 2:n="Ubicaci√≥n no disponible";break;case 3:n="Timeout capturando ubicaci√≥n";break;default:n=o.message||"Error capturando ubicaci√≥n"}else o.message&&(n=o.message);return{location:null,error:n,timestamp:Date.now()}}}const L=Object.freeze(Object.defineProperty({__proto__:null,captureLocation:E},Symbol.toStringTag,{value:"Module"}));let m=null,u=null;function v(){if(m)return m;const e=localStorage.getItem("credisync_device_id");if(e)return m=e,m;m=h();try{localStorage.setItem("credisync_device_id",m)}catch(t){console.warn("‚ö†Ô∏è [DEVICE] No se pudo guardar device ID en localStorage:",t)}return console.log("üì± [DEVICE] Nuevo device ID generado:",m),m}function h(){const t=[navigator.userAgent,navigator.language,screen.width,screen.height,screen.colorDepth,new Date().getTimezoneOffset(),navigator.hardwareConcurrency||"unknown",navigator.deviceMemory||"unknown"].join("|");let o=0;for(let i=0;i<t.length;i++){const s=t.charCodeAt(i);o=(o<<5)-o+s,o=o&o}const n=Date.now().toString(36);return`device_${Math.abs(o).toString(36)}_${n}`}async function p(){if(u)return u;try{console.log("üì± [DEVICE] Capturando informaci√≥n del dispositivo...");const e={deviceId:v(),userAgent:navigator.userAgent,language:navigator.language,languages:navigator.languages||[navigator.language],platform:navigator.platform,cookieEnabled:navigator.cookieEnabled,onLine:navigator.onLine,timestamp:Date.now()},t={width:screen.width,height:screen.height,availWidth:screen.availWidth,availHeight:screen.availHeight,colorDepth:screen.colorDepth,pixelDepth:screen.pixelDepth,orientation:screen.orientation?.type||"unknown"},o={hardwareConcurrency:navigator.hardwareConcurrency||null,deviceMemory:navigator.deviceMemory||null,maxTouchPoints:navigator.maxTouchPoints||0},n=await f(),c=await y(),i={timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,timezoneOffset:new Date().getTimezoneOffset()},s=C();return u={...e,screen:t,hardware:o,connection:n,battery:c,timezone:i,deviceType:s,capabilities:await I()},console.log("‚úÖ [DEVICE] Informaci√≥n del dispositivo capturada:",{deviceId:u.deviceId,deviceType:u.deviceType,platform:u.platform,connection:u.connection.type,battery:u.battery.level?`${Math.round(u.battery.level*100)}%`:"unknown"}),u}catch(e){return console.error("‚ùå [DEVICE] Error capturando informaci√≥n del dispositivo:",e),{deviceId:v(),userAgent:navigator.userAgent,platform:navigator.platform,onLine:navigator.onLine,timestamp:Date.now(),error:e.message}}}async function f(){try{const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return e?{type:e.effectiveType||e.type||"unknown",downlink:e.downlink||null,rtt:e.rtt||null,saveData:e.saveData||!1,supported:!0}:{type:navigator.onLine?"online":"offline",downlink:null,rtt:null,saveData:!1,supported:!1}}catch(e){return console.warn("‚ö†Ô∏è [DEVICE] Error obteniendo informaci√≥n de conexi√≥n:",e),{type:navigator.onLine?"online":"offline",downlink:null,rtt:null,saveData:!1,supported:!1,error:e.message}}}async function y(){try{if("getBattery"in navigator){const e=await navigator.getBattery();return{level:e.level,charging:e.charging,chargingTime:e.chargingTime,dischargingTime:e.dischargingTime,supported:!0}}else return{level:null,charging:null,chargingTime:null,dischargingTime:null,supported:!1}}catch(e){return console.warn("‚ö†Ô∏è [DEVICE] Error obteniendo informaci√≥n de bater√≠a:",e),{level:null,charging:null,chargingTime:null,dischargingTime:null,supported:!1,error:e.message}}}function C(){const e=navigator.userAgent.toLowerCase();return/mobile|android|iphone|ipod|blackberry|iemobile|opera mini/i.test(e)?"mobile":/tablet|ipad/i.test(e)?"tablet":"desktop"}async function I(){const e={geolocation:"geolocation"in navigator,camera:!1,microphone:!1,notifications:"Notification"in window,serviceWorker:"serviceWorker"in navigator,indexedDB:"indexedDB"in window,localStorage:(()=>{try{return localStorage.setItem("test","test"),localStorage.removeItem("test"),!0}catch{return!1}})(),webGL:(()=>{try{const t=document.createElement("canvas");return!!(t.getContext("webgl")||t.getContext("experimental-webgl"))}catch{return!1}})(),touchScreen:"ontouchstart"in window||navigator.maxTouchPoints>0,vibration:"vibrate"in navigator,battery:"getBattery"in navigator,connection:!!(navigator.connection||navigator.mozConnection||navigator.webkitConnection)};if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{const t=await navigator.mediaDevices.enumerateDevices();e.camera=t.some(o=>o.kind==="videoinput"),e.microphone=t.some(o=>o.kind==="audioinput")}catch(t){console.warn("‚ö†Ô∏è [DEVICE] Error verificando dispositivos de media:",t)}return e}async function w(e){try{if(console.log("üë§ [CLIENTE] Iniciando creaci√≥n con Universal Infrastructure..."),console.log("üîç [CLIENTE] Validando datos b√°sicos..."),console.log("üîç [CLIENTE] Datos a validar:",e),!e.nombre||e.nombre.trim().length<2)throw new Error("El nombre es requerido y debe tener al menos 2 caracteres");if(!e.telefono||e.telefono.trim().length<7)throw new Error("El tel√©fono es requerido y debe tener al menos 7 d√≠gitos");console.log("‚úÖ [CLIENTE] Validaci√≥n b√°sica exitosa"),a.isStarted||(console.log("üîÑ [CLIENTE] Inicializando CrediSync..."),await a.start()),console.log("üìç [CLIENTE] Capturando contexto completo...");const t=await E(),o=await p(),n=await a.services.auth.getCurrentUser(),c=crypto.randomUUID(),i=Date.now(),s=o.deviceId,r={id:c,tenant_id:n?.tenant_id||"00000000-0000-0000-0000-000000000001",created_by:n?.id||"system",...e,created_at:i,updated_at:i,creditos_activos:0,saldo_total:0,dias_atraso_max:0,estado:"activo",score:null,version_vector:{[s]:1},field_versions:{nombre:{value:e.nombre,timestamp:i,device_id:s},numero_documento:{value:e.numero_documento,timestamp:i,device_id:s},telefono:{value:e.telefono,timestamp:i,device_id:s},direccion:{value:e.direccion,timestamp:i,device_id:s}},synced:!1,checksum:""};console.log("üë§ [CLIENTE] Datos preparados con contexto completo:",{id:r.id,nombre:r.nombre,location:t.location?"captured":"unavailable",deviceInfo:"captured"}),console.log("üíæ [CLIENTE] Iniciando almacenamiento at√≥mico en 3 capas...");try{const l=await a.services.storage.writeAtomic(r,{tableName:"credisync_clientes",recordId:c,skipBackup:!1});console.log("‚úÖ [CLIENTE] Almacenamiento at√≥mico completado:",{layersWritten:l.layersWritten,errors:l.errors})}catch(l){throw console.error("‚ùå [CLIENTE] Error en almacenamiento at√≥mico:",l),new Error(`Error en almacenamiento: ${l.message}`)}console.log("üìã [CLIENTE] Registrando en auditor√≠a inmutable..."),await a.services.audit.logEvent({tenant_id:r.tenant_id,user_id:r.created_by,device_id:s,event_type:"CREATE",aggregate_type:"cliente",aggregate_id:c,data:r,metadata:{ip_address:null,user_agent:navigator.userAgent,app_version:"1.0.0",latitude:t.location?.latitude||null,longitude:t.location?.longitude||null,connection_type:o.connection?.type||"unknown",battery_level:o.battery?.level?Math.round(o.battery.level*100):null}}),console.log("üîÑ [CLIENTE] Agregando a cola de sincronizaci√≥n..."),await a.services.syncQueue.addToQueue("credisync_clientes",c,"INSERT",{priority:3,data:r}),navigator.onLine?(console.log("üåê [CLIENTE] Iniciando sincronizaci√≥n inteligente..."),setTimeout(()=>{a.services.sync.sync({force:!1,onProgress:l=>{console.log(`üîÑ [SYNC] ${l.phase}: ${l.current}/${l.total} - ${l.message}`)}})},100)):console.log("üì¥ [CLIENTE] Offline - Cliente guardado localmente, se sincronizar√° cuando haya conexi√≥n"),console.log("üîê [CLIENTE] Verificando integridad de datos...");const d=await a.services.storage.readWithFallback({tableName:"credisync_clientes",recordId:c});if(!d.success||!d.data)throw new Error("Error de integridad: Cliente no encontrado despu√©s de guardar");const g=d.data;console.log(`‚úÖ [CLIENTE] Cliente verificado desde ${d.source}`);try{const l=await a.services.checksum.calculateChecksum(g);g.checksum?l!==g.checksum?console.warn("‚ö†Ô∏è [CLIENTE] Advertencia: Checksum no coincide"):console.log("‚úÖ [CLIENTE] Checksum verificado correctamente"):(await a.services.db.credisync_clientes.update(c,{checksum:l}),g.checksum=l,console.log("‚úÖ [CLIENTE] Checksum calculado y guardado"))}catch(l){console.warn("‚ö†Ô∏è [CLIENTE] Error calculando checksum:",l)}return console.log("‚úÖ [CLIENTE] Cliente creado exitosamente con Universal Infrastructure completa"),{...g,_metadata:{created_with_location:!!t.location,device_info_captured:!0,stored_in_layers:3,audit_logged:!0,queued_for_sync:!0}}}catch(t){if(console.error("‚ùå [CLIENTE] Error en creaci√≥n con Universal Infrastructure:",t),a.isStarted)try{const o=await p();await a.services.audit.logEvent({tenant_id:"00000000-0000-0000-0000-000000000001",user_id:"system",device_id:o.deviceId,event_type:"ERROR",aggregate_type:"cliente",aggregate_id:"unknown",data:{error:t.message,clienteData:e},metadata:{ip_address:null,user_agent:navigator.userAgent,app_version:"1.0.0",latitude:null,longitude:null,connection_type:o.connection?.type||"unknown",battery_level:o.battery?.level?Math.round(o.battery.level*100):null}})}catch(o){console.error("‚ùå [CLIENTE] Error logging audit event:",o)}throw t}}async function b(){try{console.log("üë• [CLIENTES] Obteniendo clientes usando @sync/core..."),a.isStarted||await a.start();const t=(await a.services.auth.getCurrentUser())?.tenant_id||"00000000-0000-0000-0000-000000000001";let o=[];try{o=await a.services.db.credisync_clientes.where("tenant_id").equals(t).toArray(),console.log(`‚úÖ [CLIENTES] ${o.length} clientes obtenidos desde IndexedDB`)}catch(r){return console.error("‚ùå [CLIENTES] Error obteniendo clientes desde IndexedDB:",r),[]}console.log("üîê [CLIENTES] Verificando integridad de datos...");const n=[];let c=0,i=0;for(const r of o)try{if(r.checksum){const d=await a.services.checksum.calculateChecksum(r);if(d===r.checksum)n.push(r);else{console.warn(`‚ö†Ô∏è [CLIENTES] Cliente ${r.id} tiene checksum inv√°lido`),c++;try{const g={...r,checksum:d};await a.services.db.credisync_clientes.update(r.id,{checksum:d}),n.push(g),i++,console.log(`‚úÖ [CLIENTES] Cliente ${r.id} reparado autom√°ticamente`)}catch(g){console.error(`‚ùå [CLIENTES] No se pudo reparar cliente ${r.id}:`,g),n.push(r)}}}else try{const d=await a.services.checksum.calculateChecksum(r);await a.services.db.credisync_clientes.update(r.id,{checksum:d}),n.push({...r,checksum:d}),i++}catch(d){console.warn(`‚ö†Ô∏è [CLIENTES] Error calculando checksum para ${r.id}:`,d),n.push(r)}}catch(d){console.error(`‚ùå [CLIENTES] Error procesando cliente ${r.id}:`,d),n.push(r)}c>0&&console.warn(`‚ö†Ô∏è [CLIENTES] ${c} clientes con datos corruptos detectados`),i>0&&console.log(`‚úÖ [CLIENTES] ${i} clientes reparados autom√°ticamente`);const s=await _(n);return console.log(`‚úÖ [CLIENTES] ${s.length} clientes procesados correctamente`),s}catch(e){return console.error("‚ùå [CLIENTES] Error obteniendo clientes:",e),[]}}async function T(e){try{console.log(`üë§ [CLIENTE] Obteniendo cliente ${e} usando @sync/core...`),a.isStarted||await a.start();const t=await a.services.storage.readWithFallback({tableName:"credisync_clientes",recordId:e});if(!t.success||!t.data)return console.log(`‚ùå [CLIENTE] Cliente ${e} no encontrado`),null;const o=t.data;if(console.log(`‚úÖ [CLIENTE] Cliente ${e} obtenido desde ${t.source}`),o.checksum)try{const n=await a.services.checksum.calculateChecksum(o);if(n!==o.checksum){console.warn(`‚ö†Ô∏è [CLIENTE] Cliente ${e} tiene checksum inv√°lido, reparando...`);const c={...o,checksum:n};return await a.services.db.credisync_clientes.update(e,{checksum:n}),console.log(`‚úÖ [CLIENTE] Cliente ${e} reparado autom√°ticamente`),c}else console.log(`‚úÖ [CLIENTE] Checksum verificado para ${e}`)}catch(n){console.warn(`‚ö†Ô∏è [CLIENTE] Error verificando checksum para ${e}:`,n)}else try{const n=await a.services.checksum.calculateChecksum(o);await a.services.db.credisync_clientes.update(e,{checksum:n}),o.checksum=n,console.log(`‚úÖ [CLIENTE] Checksum calculado para ${e}`)}catch(n){console.warn(`‚ö†Ô∏è [CLIENTE] Error calculando checksum para ${e}:`,n)}return o}catch(t){return console.error(`‚ùå [CLIENTE] Error obteniendo cliente ${e}:`,t),null}}async function _(e){try{return e.map(t=>({...t,saldoTotal:t.saldo_total||0,creditosActivos:t.creditos_activos||0,diasAtraso:t.dias_atraso_max||0,proximoPago:null}))}catch(t){return console.error("‚ùå [CLIENTES] Error enriqueciendo datos para UI:",t),e}}const N=Object.freeze(Object.defineProperty({__proto__:null,createCliente:w,getClienteById:T,getClientes:b},Symbol.toStringTag,{value:"Module"}));export{N as a,w as c,b as g,L as l};
