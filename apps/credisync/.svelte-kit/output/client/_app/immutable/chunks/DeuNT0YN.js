function cu(i,e){for(var t=0;t<e.length;t++){const r=e[t];if(typeof r!="string"&&!Array.isArray(r)){for(const s in r)if(s!=="default"&&!(s in i)){const a=Object.getOwnPropertyDescriptor(r,s);a&&Object.defineProperty(i,s,a.get?a:{enumerable:!0,get:()=>r[s]})}}}return Object.freeze(Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}))}var lu=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ua(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function vr(i){if(Object.prototype.hasOwnProperty.call(i,"__esModule"))return i;var e=i.default;if(typeof e=="function"){var t=function r(){var s=!1;try{s=this instanceof r}catch{}return s?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(r){var s=Object.getOwnPropertyDescriptor(i,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return i[r]}})}),t}var sn={exports:{}},hu=sn.exports,Ci;function du(){return Ci||(Ci=1,(function(i,e){(function(t,r){i.exports=r()})(hu,function(){var t=function(n,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(c,l){c.__proto__=l}||function(c,l){for(var h in l)Object.prototype.hasOwnProperty.call(l,h)&&(c[h]=l[h])})(n,o)},r=function(){return(r=Object.assign||function(n){for(var o,c=1,l=arguments.length;c<l;c++)for(var h in o=arguments[c])Object.prototype.hasOwnProperty.call(o,h)&&(n[h]=o[h]);return n}).apply(this,arguments)};function s(n,o,c){for(var l,h=0,f=o.length;h<f;h++)!l&&h in o||((l=l||Array.prototype.slice.call(o,0,h))[h]=o[h]);return n.concat(l||Array.prototype.slice.call(o))}var a=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:lu,u=Object.keys,d=Array.isArray;function p(n,o){return typeof o!="object"||u(o).forEach(function(c){n[c]=o[c]}),n}typeof Promise>"u"||a.Promise||(a.Promise=Promise);var y=Object.getPrototypeOf,v={}.hasOwnProperty;function _(n,o){return v.call(n,o)}function T(n,o){typeof o=="function"&&(o=o(y(n))),(typeof Reflect>"u"?u:Reflect.ownKeys)(o).forEach(function(c){I(n,c,o[c])})}var P=Object.defineProperty;function I(n,o,c,l){P(n,o,p(c&&_(c,"get")&&typeof c.get=="function"?{get:c.get,set:c.set,configurable:!0}:{value:c,configurable:!0,writable:!0},l))}function D(n){return{from:function(o){return n.prototype=Object.create(o.prototype),I(n.prototype,"constructor",n),{extend:T.bind(null,n.prototype)}}}}var B=Object.getOwnPropertyDescriptor,q=[].slice;function H(n,o,c){return q.call(n,o,c)}function L(n,o){return o(n)}function X(n){if(!n)throw new Error("Assertion Failed")}function ce(n){a.setImmediate?setImmediate(n):setTimeout(n,0)}function se(n,o){if(typeof o=="string"&&_(n,o))return n[o];if(!o)return n;if(typeof o!="string"){for(var c=[],l=0,h=o.length;l<h;++l){var f=se(n,o[l]);c.push(f)}return c}var g=o.indexOf(".");if(g!==-1){var m=n[o.substr(0,g)];return m==null?void 0:se(m,o.substr(g+1))}}function ae(n,o,c){if(n&&o!==void 0&&!("isFrozen"in Object&&Object.isFrozen(n)))if(typeof o!="string"&&"length"in o){X(typeof c!="string"&&"length"in c);for(var l=0,h=o.length;l<h;++l)ae(n,o[l],c[l])}else{var f,g,m=o.indexOf(".");m!==-1?(f=o.substr(0,m),(g=o.substr(m+1))===""?c===void 0?d(n)&&!isNaN(parseInt(f))?n.splice(f,1):delete n[f]:n[f]=c:ae(m=!(m=n[f])||!_(n,f)?n[f]={}:m,g,c)):c===void 0?d(n)&&!isNaN(parseInt(o))?n.splice(o,1):delete n[o]:n[o]=c}}function $e(n){var o,c={};for(o in n)_(n,o)&&(c[o]=n[o]);return c}var De=[].concat;function Vs(n){return De.apply([],n)}var ut="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Vs([8,16,32,64].map(function(n){return["Int","Uint","Float"].map(function(o){return o+n+"Array"})}))).filter(function(n){return a[n]}),Ws=new Set(ut.map(function(n){return a[n]})),Qt=null;function it(n){return Qt=new WeakMap,n=(function o(c){if(!c||typeof c!="object")return c;var l=Qt.get(c);if(l)return l;if(d(c)){l=[],Qt.set(c,l);for(var h=0,f=c.length;h<f;++h)l.push(o(c[h]))}else if(Ws.has(c.constructor))l=c;else{var g,m=y(c);for(g in l=m===Object.prototype?{}:Object.create(m),Qt.set(c,l),c)_(c,g)&&(l[g]=o(c[g]))}return l})(n),Qt=null,n}var Co={}.toString;function kn(n){return Co.call(n).slice(8,-1)}var On=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Ro=typeof On=="symbol"?function(n){var o;return n!=null&&(o=n[On])&&o.apply(n)}:function(){return null};function at(n,o){return o=n.indexOf(o),0<=o&&n.splice(o,1),0<=o}var Tt={};function Ve(n){var o,c,l,h;if(arguments.length===1){if(d(n))return n.slice();if(this===Tt&&typeof n=="string")return[n];if(h=Ro(n)){for(c=[];!(l=h.next()).done;)c.push(l.value);return c}if(n==null)return[n];if(typeof(o=n.length)!="number")return[n];for(c=new Array(o);o--;)c[o]=n[o];return c}for(o=arguments.length,c=new Array(o);o--;)c[o]=arguments[o];return c}var Tn=typeof Symbol<"u"?function(n){return n[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Zt=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],xe=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Zt),jo={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function At(n,o){this.name=n,this.message=o}function zs(n,o){return n+". Errors: "+Object.keys(o).map(function(c){return o[c].toString()}).filter(function(c,l,h){return h.indexOf(c)===l}).join(`
`)}function br(n,o,c,l){this.failures=o,this.failedKeys=l,this.successCount=c,this.message=zs(n,o)}function Pt(n,o){this.name="BulkError",this.failures=Object.keys(o).map(function(c){return o[c]}),this.failuresByPos=o,this.message=zs(n,this.failures)}D(At).from(Error).extend({toString:function(){return this.name+": "+this.message}}),D(br).from(At),D(Pt).from(At);var An=xe.reduce(function(n,o){return n[o]=o+"Error",n},{}),Io=At,Z=xe.reduce(function(n,o){var c=o+"Error";function l(h,f){this.name=c,h?typeof h=="string"?(this.message="".concat(h).concat(f?`
 `+f:""),this.inner=f||null):typeof h=="object"&&(this.message="".concat(h.name," ").concat(h.message),this.inner=h):(this.message=jo[o]||c,this.inner=null)}return D(l).from(Io),n[o]=l,n},{});Z.Syntax=SyntaxError,Z.Type=TypeError,Z.Range=RangeError;var Hs=Zt.reduce(function(n,o){return n[o+"Error"]=Z[o],n},{}),Er=xe.reduce(function(n,o){return["Syntax","Type","Range"].indexOf(o)===-1&&(n[o+"Error"]=Z[o]),n},{});function le(){}function Yt(n){return n}function xo(n,o){return n==null||n===Yt?o:function(c){return o(n(c))}}function ot(n,o){return function(){n.apply(this,arguments),o.apply(this,arguments)}}function $o(n,o){return n===le?o:function(){var c=n.apply(this,arguments);c!==void 0&&(arguments[0]=c);var l=this.onsuccess,h=this.onerror;this.onsuccess=null,this.onerror=null;var f=o.apply(this,arguments);return l&&(this.onsuccess=this.onsuccess?ot(l,this.onsuccess):l),h&&(this.onerror=this.onerror?ot(h,this.onerror):h),f!==void 0?f:c}}function Do(n,o){return n===le?o:function(){n.apply(this,arguments);var c=this.onsuccess,l=this.onerror;this.onsuccess=this.onerror=null,o.apply(this,arguments),c&&(this.onsuccess=this.onsuccess?ot(c,this.onsuccess):c),l&&(this.onerror=this.onerror?ot(l,this.onerror):l)}}function Bo(n,o){return n===le?o:function(c){var l=n.apply(this,arguments);p(c,l);var h=this.onsuccess,f=this.onerror;return this.onsuccess=null,this.onerror=null,c=o.apply(this,arguments),h&&(this.onsuccess=this.onsuccess?ot(h,this.onsuccess):h),f&&(this.onerror=this.onerror?ot(f,this.onerror):f),l===void 0?c===void 0?void 0:c:p(l,c)}}function No(n,o){return n===le?o:function(){return o.apply(this,arguments)!==!1&&n.apply(this,arguments)}}function Pn(n,o){return n===le?o:function(){var c=n.apply(this,arguments);if(c&&typeof c.then=="function"){for(var l=this,h=arguments.length,f=new Array(h);h--;)f[h]=arguments[h];return c.then(function(){return o.apply(l,f)})}return o.apply(this,arguments)}}Er.ModifyError=br,Er.DexieError=At,Er.BulkError=Pt;var qe=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Gs(n){qe=n}var Xt={},Js=100,ut=typeof Promise>"u"?[]:(function(){var n=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[n,y(n),n];var o=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[o,y(o),n]})(),Zt=ut[0],xe=ut[1],ut=ut[2],xe=xe&&xe.then,ct=Zt&&Zt.constructor,Cn=!!ut,er=function(n,o){tr.push([n,o]),Sr&&(queueMicrotask(Lo),Sr=!1)},Rn=!0,Sr=!0,lt=[],kr=[],jn=Yt,Qe={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:le,pgp:!1,env:{},finalize:le},Y=Qe,tr=[],ht=0,Or=[];function z(n){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var o=this._PSD=Y;if(typeof n!="function"){if(n!==Xt)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&xn(this,this._value))}this._state=null,this._value=null,++o.ref,(function c(l,h){try{h(function(f){if(l._state===null){if(f===l)throw new TypeError("A promise cannot be resolved with itself.");var g=l._lib&&Ct();f&&typeof f.then=="function"?c(l,function(m,b){f instanceof z?f._then(m,b):f.then(m,b)}):(l._state=!0,l._value=f,Ys(l)),g&&Rt()}},xn.bind(null,l))}catch(f){xn(l,f)}})(this,n)}var In={get:function(){var n=Y,o=Cr;function c(l,h){var f=this,g=!n.global&&(n!==Y||o!==Cr),m=g&&!Xe(),b=new z(function(E,A){$n(f,new Qs(Zs(l,n,g,m),Zs(h,n,g,m),E,A,n))});return this._consoleTask&&(b._consoleTask=this._consoleTask),b}return c.prototype=Xt,c},set:function(n){I(this,"then",n&&n.prototype===Xt?In:{get:function(){return n},set:In.set})}};function Qs(n,o,c,l,h){this.onFulfilled=typeof n=="function"?n:null,this.onRejected=typeof o=="function"?o:null,this.resolve=c,this.reject=l,this.psd=h}function xn(n,o){var c,l;kr.push(o),n._state===null&&(c=n._lib&&Ct(),o=jn(o),n._state=!1,n._value=o,l=n,lt.some(function(h){return h._value===l._value})||lt.push(l),Ys(n),c&&Rt())}function Ys(n){var o=n._listeners;n._listeners=[];for(var c=0,l=o.length;c<l;++c)$n(n,o[c]);var h=n._PSD;--h.ref||h.finalize(),ht===0&&(++ht,er(function(){--ht==0&&Dn()},[]))}function $n(n,o){if(n._state!==null){var c=n._state?o.onFulfilled:o.onRejected;if(c===null)return(n._state?o.resolve:o.reject)(n._value);++o.psd.ref,++ht,er(Uo,[c,n,o])}else n._listeners.push(o)}function Uo(n,o,c){try{var l,h=o._value;!o._state&&kr.length&&(kr=[]),l=qe&&o._consoleTask?o._consoleTask.run(function(){return n(h)}):n(h),o._state||kr.indexOf(h)!==-1||(function(f){for(var g=lt.length;g;)if(lt[--g]._value===f._value)return lt.splice(g,1)})(o),c.resolve(l)}catch(f){c.reject(f)}finally{--ht==0&&Dn(),--c.psd.ref||c.psd.finalize()}}function Lo(){dt(Qe,function(){Ct()&&Rt()})}function Ct(){var n=Rn;return Sr=Rn=!1,n}function Rt(){var n,o,c;do for(;0<tr.length;)for(n=tr,tr=[],c=n.length,o=0;o<c;++o){var l=n[o];l[0].apply(null,l[1])}while(0<tr.length);Sr=Rn=!0}function Dn(){var n=lt;lt=[],n.forEach(function(l){l._PSD.onunhandled.call(null,l._value,l)});for(var o=Or.slice(0),c=o.length;c;)o[--c]()}function Tr(n){return new z(Xt,!1,n)}function fe(n,o){var c=Y;return function(){var l=Ct(),h=Y;try{return Ze(c,!0),n.apply(this,arguments)}catch(f){o&&o(f)}finally{Ze(h,!1),l&&Rt()}}}T(z.prototype,{then:In,_then:function(n,o){$n(this,new Qs(null,null,n,o,Y))},catch:function(n){if(arguments.length===1)return this.then(null,n);var o=n,c=arguments[1];return typeof o=="function"?this.then(null,function(l){return(l instanceof o?c:Tr)(l)}):this.then(null,function(l){return(l&&l.name===o?c:Tr)(l)})},finally:function(n){return this.then(function(o){return z.resolve(n()).then(function(){return o})},function(o){return z.resolve(n()).then(function(){return Tr(o)})})},timeout:function(n,o){var c=this;return n<1/0?new z(function(l,h){var f=setTimeout(function(){return h(new Z.Timeout(o))},n);c.then(l,h).finally(clearTimeout.bind(null,f))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&I(z.prototype,Symbol.toStringTag,"Dexie.Promise"),Qe.env=Xs(),T(z,{all:function(){var n=Ve.apply(null,arguments).map(Rr);return new z(function(o,c){n.length===0&&o([]);var l=n.length;n.forEach(function(h,f){return z.resolve(h).then(function(g){n[f]=g,--l||o(n)},c)})})},resolve:function(n){return n instanceof z?n:n&&typeof n.then=="function"?new z(function(o,c){n.then(o,c)}):new z(Xt,!0,n)},reject:Tr,race:function(){var n=Ve.apply(null,arguments).map(Rr);return new z(function(o,c){n.map(function(l){return z.resolve(l).then(o,c)})})},PSD:{get:function(){return Y},set:function(n){return Y=n}},totalEchoes:{get:function(){return Cr}},newPSD:Ye,usePSD:dt,scheduler:{get:function(){return er},set:function(n){er=n}},rejectionMapper:{get:function(){return jn},set:function(n){jn=n}},follow:function(n,o){return new z(function(c,l){return Ye(function(h,f){var g=Y;g.unhandleds=[],g.onunhandled=f,g.finalize=ot(function(){var m,b=this;m=function(){b.unhandleds.length===0?h():f(b.unhandleds[0])},Or.push(function E(){m(),Or.splice(Or.indexOf(E),1)}),++ht,er(function(){--ht==0&&Dn()},[])},g.finalize),n()},o,c,l)})}}),ct&&(ct.allSettled&&I(z,"allSettled",function(){var n=Ve.apply(null,arguments).map(Rr);return new z(function(o){n.length===0&&o([]);var c=n.length,l=new Array(c);n.forEach(function(h,f){return z.resolve(h).then(function(g){return l[f]={status:"fulfilled",value:g}},function(g){return l[f]={status:"rejected",reason:g}}).then(function(){return--c||o(l)})})})}),ct.any&&typeof AggregateError<"u"&&I(z,"any",function(){var n=Ve.apply(null,arguments).map(Rr);return new z(function(o,c){n.length===0&&c(new AggregateError([]));var l=n.length,h=new Array(l);n.forEach(function(f,g){return z.resolve(f).then(function(m){return o(m)},function(m){h[g]=m,--l||c(new AggregateError(h))})})})}),ct.withResolvers&&(z.withResolvers=ct.withResolvers));var we={awaits:0,echoes:0,id:0},qo=0,Ar=[],Pr=0,Cr=0,Fo=0;function Ye(n,o,c,l){var h=Y,f=Object.create(h);return f.parent=h,f.ref=0,f.global=!1,f.id=++Fo,Qe.env,f.env=Cn?{Promise:z,PromiseProp:{value:z,configurable:!0,writable:!0},all:z.all,race:z.race,allSettled:z.allSettled,any:z.any,resolve:z.resolve,reject:z.reject}:{},o&&p(f,o),++h.ref,f.finalize=function(){--this.parent.ref||this.parent.finalize()},l=dt(f,n,c,l),f.ref===0&&f.finalize(),l}function jt(){return we.id||(we.id=++qo),++we.awaits,we.echoes+=Js,we.id}function Xe(){return!!we.awaits&&(--we.awaits==0&&(we.id=0),we.echoes=we.awaits*Js,!0)}function Rr(n){return we.echoes&&n&&n.constructor===ct?(jt(),n.then(function(o){return Xe(),o},function(o){return Xe(),ye(o)})):n}function Ko(){var n=Ar[Ar.length-1];Ar.pop(),Ze(n,!1)}function Ze(n,o){var c,l=Y;(o?!we.echoes||Pr++&&n===Y:!Pr||--Pr&&n===Y)||queueMicrotask(o?function(h){++Cr,we.echoes&&--we.echoes!=0||(we.echoes=we.awaits=we.id=0),Ar.push(Y),Ze(h,!0)}.bind(null,n):Ko),n!==Y&&(Y=n,l===Qe&&(Qe.env=Xs()),Cn&&(c=Qe.env.Promise,o=n.env,(l.global||n.global)&&(Object.defineProperty(a,"Promise",o.PromiseProp),c.all=o.all,c.race=o.race,c.resolve=o.resolve,c.reject=o.reject,o.allSettled&&(c.allSettled=o.allSettled),o.any&&(c.any=o.any))))}function Xs(){var n=a.Promise;return Cn?{Promise:n,PromiseProp:Object.getOwnPropertyDescriptor(a,"Promise"),all:n.all,race:n.race,allSettled:n.allSettled,any:n.any,resolve:n.resolve,reject:n.reject}:{}}function dt(n,o,c,l,h){var f=Y;try{return Ze(n,!0),o(c,l,h)}finally{Ze(f,!1)}}function Zs(n,o,c,l){return typeof n!="function"?n:function(){var h=Y;c&&jt(),Ze(o,!0);try{return n.apply(this,arguments)}finally{Ze(h,!1),l&&queueMicrotask(Xe)}}}function Bn(n){Promise===ct&&we.echoes===0?Pr===0?n():enqueueNativeMicroTask(n):setTimeout(n,0)}(""+xe).indexOf("[native code]")===-1&&(jt=Xe=le);var ye=z.reject,ft="ï¿¿",We="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",ei="String expected.",It=[],jr="__dbnames",Nn="readonly",Un="readwrite";function pt(n,o){return n?o?function(){return n.apply(this,arguments)&&o.apply(this,arguments)}:n:o}var ti={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Ir(n){return typeof n!="string"||/\./.test(n)?function(o){return o}:function(o){return o[n]===void 0&&n in o&&delete(o=it(o))[n],o}}function ri(){throw Z.Type("Entity instances must never be new:ed. Instances are generated by the framework bypassing the constructor.")}function oe(n,o){try{var c=ni(n),l=ni(o);if(c!==l)return c==="Array"?1:l==="Array"?-1:c==="binary"?1:l==="binary"?-1:c==="string"?1:l==="string"?-1:c==="Date"?1:l!=="Date"?NaN:-1;switch(c){case"number":case"Date":case"string":return o<n?1:n<o?-1:0;case"binary":return(function(h,f){for(var g=h.length,m=f.length,b=g<m?g:m,E=0;E<b;++E)if(h[E]!==f[E])return h[E]<f[E]?-1:1;return g===m?0:g<m?-1:1})(si(n),si(o));case"Array":return(function(h,f){for(var g=h.length,m=f.length,b=g<m?g:m,E=0;E<b;++E){var A=oe(h[E],f[E]);if(A!==0)return A}return g===m?0:g<m?-1:1})(n,o)}}catch{}return NaN}function ni(n){var o=typeof n;return o!="object"?o:ArrayBuffer.isView(n)?"binary":(n=kn(n),n==="ArrayBuffer"?"binary":n)}function si(n){return n instanceof Uint8Array?n:ArrayBuffer.isView(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n)}function xr(n,o,c){var l=n.schema.yProps;return l?(o&&0<c.numFailures&&(o=o.filter(function(h,f){return!c.failures[f]})),Promise.all(l.map(function(h){return h=h.updatesTable,o?n.db.table(h).where("k").anyOf(o).delete():n.db.table(h).clear()})).then(function(){return c})):c}var rr=(ii.prototype.execute=function(n){var o=this["@@propmod"];if(o.add!==void 0){var c=o.add;if(d(c))return s(s([],d(n)?n:[],!0),c).sort();if(typeof c=="number")return(Number(n)||0)+c;if(typeof c=="bigint")try{return BigInt(n)+c}catch{return BigInt(0)+c}throw new TypeError("Invalid term ".concat(c))}if(o.remove!==void 0){var l=o.remove;if(d(l))return d(n)?n.filter(function(h){return!l.includes(h)}).sort():[];if(typeof l=="number")return Number(n)-l;if(typeof l=="bigint")try{return BigInt(n)-l}catch{return BigInt(0)-l}throw new TypeError("Invalid subtrahend ".concat(l))}return c=(c=o.replacePrefix)===null||c===void 0?void 0:c[0],c&&typeof n=="string"&&n.startsWith(c)?o.replacePrefix[1]+n.substring(c.length):n},ii);function ii(n){this["@@propmod"]=n}function ai(n,o){for(var c=u(o),l=c.length,h=!1,f=0;f<l;++f){var g=c[f],m=o[g],b=se(n,g);m instanceof rr?(ae(n,g,m.execute(b)),h=!0):b!==m&&(ae(n,g,m),h=!0)}return h}var oi=(he.prototype._trans=function(n,o,c){var l=this._tx||Y.trans,h=this.name,f=qe&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(n==="readonly"?"read":"write"," ").concat(this.name));function g(E,A,w){if(!w.schema[h])throw new Z.NotFound("Table "+h+" not part of transaction");return o(w.idbtrans,w)}var m=Ct();try{var b=l&&l.db._novip===this.db._novip?l===Y.trans?l._promise(n,g,c):Ye(function(){return l._promise(n,g,c)},{trans:l,transless:Y.transless||Y}):(function E(A,w,R,S){if(A.idbdb&&(A._state.openComplete||Y.letThrough||A._vip)){var k=A._createTransaction(w,R,A._dbSchema);try{k.create(),A._state.PR1398_maxLoop=3}catch(O){return O.name===An.InvalidState&&A.isOpen()&&0<--A._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),A.close({disableAutoOpen:!1}),A.open().then(function(){return E(A,w,R,S)})):ye(O)}return k._promise(w,function(O,C){return Ye(function(){return Y.trans=k,S(O,C,k)})}).then(function(O){if(w==="readwrite")try{k.idbtrans.commit()}catch{}return w==="readonly"?O:k._completion.then(function(){return O})})}if(A._state.openComplete)return ye(new Z.DatabaseClosed(A._state.dbOpenError));if(!A._state.isBeingOpened){if(!A._state.autoOpen)return ye(new Z.DatabaseClosed);A.open().catch(le)}return A._state.dbReadyPromise.then(function(){return E(A,w,R,S)})})(this.db,n,[this.name],g);return f&&(b._consoleTask=f,b=b.catch(function(E){return console.trace(E),ye(E)})),b}finally{m&&Rt()}},he.prototype.get=function(n,o){var c=this;return n&&n.constructor===Object?this.where(n).first(o):n==null?ye(new Z.Type("Invalid argument to Table.get()")):this._trans("readonly",function(l){return c.core.get({trans:l,key:n}).then(function(h){return c.hook.reading.fire(h)})}).then(o)},he.prototype.where=function(n){if(typeof n=="string")return new this.db.WhereClause(this,n);if(d(n))return new this.db.WhereClause(this,"[".concat(n.join("+"),"]"));var o=u(n);if(o.length===1)return this.where(o[0]).equals(n[o[0]]);var c=this.schema.indexes.concat(this.schema.primKey).filter(function(m){if(m.compound&&o.every(function(E){return 0<=m.keyPath.indexOf(E)})){for(var b=0;b<o.length;++b)if(o.indexOf(m.keyPath[b])===-1)return!1;return!0}return!1}).sort(function(m,b){return m.keyPath.length-b.keyPath.length})[0];if(c&&this.db._maxKey!==ft){var f=c.keyPath.slice(0,o.length);return this.where(f).equals(f.map(function(b){return n[b]}))}!c&&qe&&console.warn("The query ".concat(JSON.stringify(n)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(o.join("+"),"]"));var l=this.schema.idxByName;function h(m,b){return oe(m,b)===0}var g=o.reduce(function(w,b){var E=w[0],A=w[1],w=l[b],R=n[b];return[E||w,E||!w?pt(A,w&&w.multi?function(S){return S=se(S,b),d(S)&&S.some(function(k){return h(R,k)})}:function(S){return h(R,se(S,b))}):A]},[null,null]),f=g[0],g=g[1];return f?this.where(f.name).equals(n[f.keyPath]).filter(g):c?this.filter(g):this.where(o).equals("")},he.prototype.filter=function(n){return this.toCollection().and(n)},he.prototype.count=function(n){return this.toCollection().count(n)},he.prototype.offset=function(n){return this.toCollection().offset(n)},he.prototype.limit=function(n){return this.toCollection().limit(n)},he.prototype.each=function(n){return this.toCollection().each(n)},he.prototype.toArray=function(n){return this.toCollection().toArray(n)},he.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},he.prototype.orderBy=function(n){return new this.db.Collection(new this.db.WhereClause(this,d(n)?"[".concat(n.join("+"),"]"):n))},he.prototype.reverse=function(){return this.toCollection().reverse()},he.prototype.mapToClass=function(n){var o,c=this.db,l=this.name;function h(){return o!==null&&o.apply(this,arguments)||this}(this.schema.mappedClass=n).prototype instanceof ri&&((function(b,E){if(typeof E!="function"&&E!==null)throw new TypeError("Class extends value "+String(E)+" is not a constructor or null");function A(){this.constructor=b}t(b,E),b.prototype=E===null?Object.create(E):(A.prototype=E.prototype,new A)})(h,o=n),Object.defineProperty(h.prototype,"db",{get:function(){return c},enumerable:!1,configurable:!0}),h.prototype.table=function(){return l},n=h);for(var f=new Set,g=n.prototype;g;g=y(g))Object.getOwnPropertyNames(g).forEach(function(b){return f.add(b)});function m(b){if(!b)return b;var E,A=Object.create(n.prototype);for(E in b)if(!f.has(E))try{A[E]=b[E]}catch{}return A}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=m,this.hook("reading",m),n},he.prototype.defineClass=function(){return this.mapToClass(function(n){p(this,n)})},he.prototype.add=function(n,o){var c=this,l=this.schema.primKey,h=l.auto,f=l.keyPath,g=n;return f&&h&&(g=Ir(f)(n)),this._trans("readwrite",function(m){return c.core.mutate({trans:m,type:"add",keys:o!=null?[o]:null,values:[g]})}).then(function(m){return m.numFailures?z.reject(m.failures[0]):m.lastResult}).then(function(m){if(f)try{ae(n,f,m)}catch{}return m})},he.prototype.upsert=function(n,o){var c=this,l=this.schema.primKey.keyPath;return this._trans("readwrite",function(h){return c.core.get({trans:h,key:n}).then(function(f){var g=f??{};return ai(g,o),l&&ae(g,l,n),c.core.mutate({trans:h,type:"put",values:[g],keys:[n],upsert:!0,updates:{keys:[n],changeSpecs:[o]}}).then(function(m){return m.numFailures?z.reject(m.failures[0]):!!f})})})},he.prototype.update=function(n,o){return typeof n!="object"||d(n)?this.where(":id").equals(n).modify(o):(n=se(n,this.schema.primKey.keyPath),n===void 0?ye(new Z.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(n).modify(o))},he.prototype.put=function(n,o){var c=this,l=this.schema.primKey,h=l.auto,f=l.keyPath,g=n;return f&&h&&(g=Ir(f)(n)),this._trans("readwrite",function(m){return c.core.mutate({trans:m,type:"put",values:[g],keys:o!=null?[o]:null})}).then(function(m){return m.numFailures?z.reject(m.failures[0]):m.lastResult}).then(function(m){if(f)try{ae(n,f,m)}catch{}return m})},he.prototype.delete=function(n){var o=this;return this._trans("readwrite",function(c){return o.core.mutate({trans:c,type:"delete",keys:[n]}).then(function(l){return xr(o,[n],l)}).then(function(l){return l.numFailures?z.reject(l.failures[0]):void 0})})},he.prototype.clear=function(){var n=this;return this._trans("readwrite",function(o){return n.core.mutate({trans:o,type:"deleteRange",range:ti}).then(function(c){return xr(n,null,c)})}).then(function(o){return o.numFailures?z.reject(o.failures[0]):void 0})},he.prototype.bulkGet=function(n){var o=this;return this._trans("readonly",function(c){return o.core.getMany({keys:n,trans:c}).then(function(l){return l.map(function(h){return o.hook.reading.fire(h)})})})},he.prototype.bulkAdd=function(n,o,c){var l=this,h=Array.isArray(o)?o:void 0,f=(c=c||(h?void 0:o))?c.allKeys:void 0;return this._trans("readwrite",function(g){var E=l.schema.primKey,m=E.auto,E=E.keyPath;if(E&&h)throw new Z.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(h&&h.length!==n.length)throw new Z.InvalidArgument("Arguments objects and keys must have the same length");var b=n.length,E=E&&m?n.map(Ir(E)):n;return l.core.mutate({trans:g,type:"add",keys:h,values:E,wantResults:f}).then(function(k){var w=k.numFailures,R=k.results,S=k.lastResult,k=k.failures;if(w===0)return f?R:S;throw new Pt("".concat(l.name,".bulkAdd(): ").concat(w," of ").concat(b," operations failed"),k)})})},he.prototype.bulkPut=function(n,o,c){var l=this,h=Array.isArray(o)?o:void 0,f=(c=c||(h?void 0:o))?c.allKeys:void 0;return this._trans("readwrite",function(g){var E=l.schema.primKey,m=E.auto,E=E.keyPath;if(E&&h)throw new Z.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(h&&h.length!==n.length)throw new Z.InvalidArgument("Arguments objects and keys must have the same length");var b=n.length,E=E&&m?n.map(Ir(E)):n;return l.core.mutate({trans:g,type:"put",keys:h,values:E,wantResults:f}).then(function(k){var w=k.numFailures,R=k.results,S=k.lastResult,k=k.failures;if(w===0)return f?R:S;throw new Pt("".concat(l.name,".bulkPut(): ").concat(w," of ").concat(b," operations failed"),k)})})},he.prototype.bulkUpdate=function(n){var o=this,c=this.core,l=n.map(function(g){return g.key}),h=n.map(function(g){return g.changes}),f=[];return this._trans("readwrite",function(g){return c.getMany({trans:g,keys:l,cache:"clone"}).then(function(m){var b=[],E=[];n.forEach(function(w,R){var S=w.key,k=w.changes,O=m[R];if(O){for(var C=0,j=Object.keys(k);C<j.length;C++){var x=j[C],$=k[x];if(x===o.schema.primKey.keyPath){if(oe($,S)!==0)throw new Z.Constraint("Cannot update primary key in bulkUpdate()")}else ae(O,x,$)}f.push(R),b.push(S),E.push(O)}});var A=b.length;return c.mutate({trans:g,type:"put",keys:b,values:E,updates:{keys:l,changeSpecs:h}}).then(function(w){var R=w.numFailures,S=w.failures;if(R===0)return A;for(var k=0,O=Object.keys(S);k<O.length;k++){var C,j=O[k],x=f[Number(j)];x!=null&&(C=S[j],delete S[j],S[x]=C)}throw new Pt("".concat(o.name,".bulkUpdate(): ").concat(R," of ").concat(A," operations failed"),S)})})})},he.prototype.bulkDelete=function(n){var o=this,c=n.length;return this._trans("readwrite",function(l){return o.core.mutate({trans:l,type:"delete",keys:n}).then(function(h){return xr(o,n,h)})}).then(function(g){var h=g.numFailures,f=g.lastResult,g=g.failures;if(h===0)return f;throw new Pt("".concat(o.name,".bulkDelete(): ").concat(h," of ").concat(c," operations failed"),g)})},he);function he(){}function nr(n){function o(g,m){if(m){for(var b=arguments.length,E=new Array(b-1);--b;)E[b-1]=arguments[b];return c[g].subscribe.apply(null,E),n}if(typeof g=="string")return c[g]}var c={};o.addEventType=f;for(var l=1,h=arguments.length;l<h;++l)f(arguments[l]);return o;function f(g,m,b){if(typeof g!="object"){var E;m=m||No;var A={subscribers:[],fire:b=b||le,subscribe:function(w){A.subscribers.indexOf(w)===-1&&(A.subscribers.push(w),A.fire=m(A.fire,w))},unsubscribe:function(w){A.subscribers=A.subscribers.filter(function(R){return R!==w}),A.fire=A.subscribers.reduce(m,b)}};return c[g]=o[g]=A}u(E=g).forEach(function(w){var R=E[w];if(d(R))f(w,E[w][0],E[w][1]);else{if(R!=="asap")throw new Z.InvalidArgument("Invalid event config");var S=f(w,Yt,function(){for(var k=arguments.length,O=new Array(k);k--;)O[k]=arguments[k];S.subscribers.forEach(function(C){ce(function(){C.apply(null,O)})})})}})}}function sr(n,o){return D(o).from({prototype:n}),o}function xt(n,o){return!(n.filter||n.algorithm||n.or)&&(o?n.justLimit:!n.replayFilter)}function Ln(n,o){n.filter=pt(n.filter,o)}function qn(n,o,c){var l=n.replayFilter;n.replayFilter=l?function(){return pt(l(),o())}:o,n.justLimit=c&&!l}function $r(n,o){if(n.isPrimKey)return o.primaryKey;var c=o.getIndexByKeyPath(n.index);if(!c)throw new Z.Schema("KeyPath "+n.index+" on object store "+o.name+" is not indexed");return c}function ui(n,o,c){var l=$r(n,o.schema);return o.openCursor({trans:c,values:!n.keysOnly,reverse:n.dir==="prev",unique:!!n.unique,query:{index:l,range:n.range}})}function Dr(n,o,c,l){var h=n.replayFilter?pt(n.filter,n.replayFilter()):n.filter;if(n.or){var f={},g=function(m,b,E){var A,w;h&&!h(b,E,function(R){return b.stop(R)},function(R){return b.fail(R)})||((w=""+(A=b.primaryKey))=="[object ArrayBuffer]"&&(w=""+new Uint8Array(A)),_(f,w)||(f[w]=!0,o(m,b,E)))};return Promise.all([n.or._iterate(g,c),ci(ui(n,l,c),n.algorithm,g,!n.keysOnly&&n.valueMapper)])}return ci(ui(n,l,c),pt(n.algorithm,h),o,!n.keysOnly&&n.valueMapper)}function ci(n,o,c,l){var h=fe(l?function(f,g,m){return c(l(f),g,m)}:c);return n.then(function(f){if(f)return f.start(function(){var g=function(){return f.continue()};o&&!o(f,function(m){return g=m},function(m){f.stop(m),g=le},function(m){f.fail(m),g=le})||h(f.value,f,function(m){return g=m}),g()})})}var Mo=(ue.prototype._read=function(n,o){var c=this._ctx;return c.error?c.table._trans(null,ye.bind(null,c.error)):c.table._trans("readonly",n).then(o)},ue.prototype._write=function(n){var o=this._ctx;return o.error?o.table._trans(null,ye.bind(null,o.error)):o.table._trans("readwrite",n,"locked")},ue.prototype._addAlgorithm=function(n){var o=this._ctx;o.algorithm=pt(o.algorithm,n)},ue.prototype._iterate=function(n,o){return Dr(this._ctx,n,o,this._ctx.table.core)},ue.prototype.clone=function(n){var o=Object.create(this.constructor.prototype),c=Object.create(this._ctx);return n&&p(c,n),o._ctx=c,o},ue.prototype.raw=function(){return this._ctx.valueMapper=null,this},ue.prototype.each=function(n){var o=this._ctx;return this._read(function(c){return Dr(o,n,c,o.table.core)})},ue.prototype.count=function(n){var o=this;return this._read(function(c){var l=o._ctx,h=l.table.core;if(xt(l,!0))return h.count({trans:c,query:{index:$r(l,h.schema),range:l.range}}).then(function(g){return Math.min(g,l.limit)});var f=0;return Dr(l,function(){return++f,!1},c,h).then(function(){return f})}).then(n)},ue.prototype.sortBy=function(n,o){var c=n.split(".").reverse(),l=c[0],h=c.length-1;function f(b,E){return E?f(b[c[E]],E-1):b[l]}var g=this._ctx.dir==="next"?1:-1;function m(b,E){return oe(f(b,h),f(E,h))*g}return this.toArray(function(b){return b.sort(m)}).then(o)},ue.prototype.toArray=function(n){var o=this;return this._read(function(c){var l=o._ctx;if(l.dir==="next"&&xt(l,!0)&&0<l.limit){var h=l.valueMapper,f=$r(l,l.table.core.schema);return l.table.core.query({trans:c,limit:l.limit,values:!0,query:{index:f,range:l.range}}).then(function(m){return m=m.result,h?m.map(h):m})}var g=[];return Dr(l,function(m){return g.push(m)},c,l.table.core).then(function(){return g})},n)},ue.prototype.offset=function(n){var o=this._ctx;return n<=0||(o.offset+=n,xt(o)?qn(o,function(){var c=n;return function(l,h){return c===0||(c===1?--c:h(function(){l.advance(c),c=0}),!1)}}):qn(o,function(){var c=n;return function(){return--c<0}})),this},ue.prototype.limit=function(n){return this._ctx.limit=Math.min(this._ctx.limit,n),qn(this._ctx,function(){var o=n;return function(c,l,h){return--o<=0&&l(h),0<=o}},!0),this},ue.prototype.until=function(n,o){return Ln(this._ctx,function(c,l,h){return!n(c.value)||(l(h),o)}),this},ue.prototype.first=function(n){return this.limit(1).toArray(function(o){return o[0]}).then(n)},ue.prototype.last=function(n){return this.reverse().first(n)},ue.prototype.filter=function(n){var o;return Ln(this._ctx,function(c){return n(c.value)}),(o=this._ctx).isMatch=pt(o.isMatch,n),this},ue.prototype.and=function(n){return this.filter(n)},ue.prototype.or=function(n){return new this.db.WhereClause(this._ctx.table,n,this)},ue.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},ue.prototype.desc=function(){return this.reverse()},ue.prototype.eachKey=function(n){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(c,l){n(l.key,l)})},ue.prototype.eachUniqueKey=function(n){return this._ctx.unique="unique",this.eachKey(n)},ue.prototype.eachPrimaryKey=function(n){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(c,l){n(l.primaryKey,l)})},ue.prototype.keys=function(n){var o=this._ctx;o.keysOnly=!o.isMatch;var c=[];return this.each(function(l,h){c.push(h.key)}).then(function(){return c}).then(n)},ue.prototype.primaryKeys=function(n){var o=this._ctx;if(o.dir==="next"&&xt(o,!0)&&0<o.limit)return this._read(function(l){var h=$r(o,o.table.core.schema);return o.table.core.query({trans:l,values:!1,limit:o.limit,query:{index:h,range:o.range}})}).then(function(l){return l.result}).then(n);o.keysOnly=!o.isMatch;var c=[];return this.each(function(l,h){c.push(h.primaryKey)}).then(function(){return c}).then(n)},ue.prototype.uniqueKeys=function(n){return this._ctx.unique="unique",this.keys(n)},ue.prototype.firstKey=function(n){return this.limit(1).keys(function(o){return o[0]}).then(n)},ue.prototype.lastKey=function(n){return this.reverse().firstKey(n)},ue.prototype.distinct=function(){var n=this._ctx,n=n.index&&n.table.schema.idxByName[n.index];if(!n||!n.multi)return this;var o={};return Ln(this._ctx,function(h){var l=h.primaryKey.toString(),h=_(o,l);return o[l]=!0,!h}),this},ue.prototype.modify=function(n){var o=this,c=this._ctx;return this._write(function(l){var h=typeof n=="function"?n:function(O){return ai(O,n)},f=c.table.core,E=f.schema.primaryKey,g=E.outbound,m=E.extractKey,b=200,E=o.db._options.modifyChunkSize;E&&(b=typeof E=="object"?E[f.name]||E["*"]||200:E);function A(O,x){var j=x.failures,x=x.numFailures;R+=O-x;for(var $=0,N=u(j);$<N.length;$++){var F=N[$];w.push(j[F])}}var w=[],R=0,S=[],k=n===li;return o.clone().primaryKeys().then(function(O){function C(x){var $=Math.min(b,O.length-x),N=O.slice(x,x+$);return(k?Promise.resolve([]):f.getMany({trans:l,keys:N,cache:"immutable"})).then(function(F){var V=[],U=[],K=g?[]:null,W=k?N:[];if(!k)for(var M=0;M<$;++M){var G=F[M],re={value:it(G),primKey:O[x+M]};h.call(re,re.value,re)!==!1&&(re.value==null?W.push(O[x+M]):g||oe(m(G),m(re.value))===0?(U.push(re.value),g&&K.push(O[x+M])):(W.push(O[x+M]),V.push(re.value)))}return Promise.resolve(0<V.length&&f.mutate({trans:l,type:"add",values:V}).then(function(ne){for(var ie in ne.failures)W.splice(parseInt(ie),1);A(V.length,ne)})).then(function(){return(0<U.length||j&&typeof n=="object")&&f.mutate({trans:l,type:"put",keys:K,values:U,criteria:j,changeSpec:typeof n!="function"&&n,isAdditionalChunk:0<x}).then(function(ne){return A(U.length,ne)})}).then(function(){return(0<W.length||j&&k)&&f.mutate({trans:l,type:"delete",keys:W,criteria:j,isAdditionalChunk:0<x}).then(function(ne){return xr(c.table,W,ne)}).then(function(ne){return A(W.length,ne)})}).then(function(){return O.length>x+$&&C(x+b)})})}var j=xt(c)&&c.limit===1/0&&(typeof n!="function"||k)&&{index:c.index,range:c.range};return C(0).then(function(){if(0<w.length)throw new br("Error modifying one or more objects",w,R,S);return O.length})})})},ue.prototype.delete=function(){var n=this._ctx,o=n.range;return!xt(n)||n.table.schema.yProps||!n.isPrimKey&&o.type!==3?this.modify(li):this._write(function(c){var l=n.table.core.schema.primaryKey,h=o;return n.table.core.count({trans:c,query:{index:l,range:h}}).then(function(f){return n.table.core.mutate({trans:c,type:"deleteRange",range:h}).then(function(b){var m=b.failures,b=b.numFailures;if(b)throw new br("Could not delete some values",Object.keys(m).map(function(E){return m[E]}),f-b);return f-b})})})},ue);function ue(){}var li=function(n,o){return o.value=null};function Vo(n,o){return n<o?-1:n===o?0:1}function Wo(n,o){return o<n?-1:n===o?0:1}function Re(n,o,c){return n=n instanceof di?new n.Collection(n):n,n._ctx.error=new(c||TypeError)(o),n}function $t(n){return new n.Collection(n,function(){return hi("")}).limit(0)}function Br(n,o,c,l){var h,f,g,m,b,E,A,w=c.length;if(!c.every(function(k){return typeof k=="string"}))return Re(n,ei);function R(k){h=k==="next"?function(C){return C.toUpperCase()}:function(C){return C.toLowerCase()},f=k==="next"?function(C){return C.toLowerCase()}:function(C){return C.toUpperCase()},g=k==="next"?Vo:Wo;var O=c.map(function(C){return{lower:f(C),upper:h(C)}}).sort(function(C,j){return g(C.lower,j.lower)});m=O.map(function(C){return C.upper}),b=O.map(function(C){return C.lower}),A=(E=k)==="next"?"":l}R("next"),n=new n.Collection(n,function(){return et(m[0],b[w-1]+l)}),n._ondirectionchange=function(k){R(k)};var S=0;return n._addAlgorithm(function(k,O,C){var j=k.key;if(typeof j!="string")return!1;var x=f(j);if(o(x,b,S))return!0;for(var $=null,N=S;N<w;++N){var F=(function(V,U,K,W,M,G){for(var re=Math.min(V.length,W.length),ne=-1,ie=0;ie<re;++ie){var je=U[ie];if(je!==W[ie])return M(V[ie],K[ie])<0?V.substr(0,ie)+K[ie]+K.substr(ie+1):M(V[ie],W[ie])<0?V.substr(0,ie)+W[ie]+K.substr(ie+1):0<=ne?V.substr(0,ne)+U[ne]+K.substr(ne+1):null;M(V[ie],je)<0&&(ne=ie)}return re<W.length&&G==="next"?V+K.substr(V.length):re<V.length&&G==="prev"?V.substr(0,K.length):ne<0?null:V.substr(0,ne)+W[ne]+K.substr(ne+1)})(j,x,m[N],b[N],g,E);F===null&&$===null?S=N+1:($===null||0<g($,F))&&($=F)}return O($!==null?function(){k.continue($+A)}:C),!1}),n}function et(n,o,c,l){return{type:2,lower:n,upper:o,lowerOpen:c,upperOpen:l}}function hi(n){return{type:1,lower:n,upper:n}}var di=(Object.defineProperty(_e.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),_e.prototype.between=function(n,o,c,l){c=c!==!1,l=l===!0;try{return 0<this._cmp(n,o)||this._cmp(n,o)===0&&(c||l)&&(!c||!l)?$t(this):new this.Collection(this,function(){return et(n,o,!c,!l)})}catch{return Re(this,We)}},_e.prototype.equals=function(n){return n==null?Re(this,We):new this.Collection(this,function(){return hi(n)})},_e.prototype.above=function(n){return n==null?Re(this,We):new this.Collection(this,function(){return et(n,void 0,!0)})},_e.prototype.aboveOrEqual=function(n){return n==null?Re(this,We):new this.Collection(this,function(){return et(n,void 0,!1)})},_e.prototype.below=function(n){return n==null?Re(this,We):new this.Collection(this,function(){return et(void 0,n,!1,!0)})},_e.prototype.belowOrEqual=function(n){return n==null?Re(this,We):new this.Collection(this,function(){return et(void 0,n)})},_e.prototype.startsWith=function(n){return typeof n!="string"?Re(this,ei):this.between(n,n+ft,!0,!0)},_e.prototype.startsWithIgnoreCase=function(n){return n===""?this.startsWith(n):Br(this,function(o,c){return o.indexOf(c[0])===0},[n],ft)},_e.prototype.equalsIgnoreCase=function(n){return Br(this,function(o,c){return o===c[0]},[n],"")},_e.prototype.anyOfIgnoreCase=function(){var n=Ve.apply(Tt,arguments);return n.length===0?$t(this):Br(this,function(o,c){return c.indexOf(o)!==-1},n,"")},_e.prototype.startsWithAnyOfIgnoreCase=function(){var n=Ve.apply(Tt,arguments);return n.length===0?$t(this):Br(this,function(o,c){return c.some(function(l){return o.indexOf(l)===0})},n,ft)},_e.prototype.anyOf=function(){var n=this,o=Ve.apply(Tt,arguments),c=this._cmp;try{o.sort(c)}catch{return Re(this,We)}if(o.length===0)return $t(this);var l=new this.Collection(this,function(){return et(o[0],o[o.length-1])});l._ondirectionchange=function(f){c=f==="next"?n._ascending:n._descending,o.sort(c)};var h=0;return l._addAlgorithm(function(f,g,m){for(var b=f.key;0<c(b,o[h]);)if(++h===o.length)return g(m),!1;return c(b,o[h])===0||(g(function(){f.continue(o[h])}),!1)}),l},_e.prototype.notEqual=function(n){return this.inAnyRange([[-1/0,n],[n,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},_e.prototype.noneOf=function(){var n=Ve.apply(Tt,arguments);if(n.length===0)return new this.Collection(this);try{n.sort(this._ascending)}catch{return Re(this,We)}var o=n.reduce(function(c,l){return c?c.concat([[c[c.length-1][1],l]]):[[-1/0,l]]},null);return o.push([n[n.length-1],this.db._maxKey]),this.inAnyRange(o,{includeLowers:!1,includeUppers:!1})},_e.prototype.inAnyRange=function(j,o){var c=this,l=this._cmp,h=this._ascending,f=this._descending,g=this._min,m=this._max;if(j.length===0)return $t(this);if(!j.every(function(x){return x[0]!==void 0&&x[1]!==void 0&&h(x[0],x[1])<=0}))return Re(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",Z.InvalidArgument);var b=!o||o.includeLowers!==!1,E=o&&o.includeUppers===!0,A,w=h;function R(x,$){return w(x[0],$[0])}try{(A=j.reduce(function(x,$){for(var N=0,F=x.length;N<F;++N){var V=x[N];if(l($[0],V[1])<0&&0<l($[1],V[0])){V[0]=g(V[0],$[0]),V[1]=m(V[1],$[1]);break}}return N===F&&x.push($),x},[])).sort(R)}catch{return Re(this,We)}var S=0,k=E?function(x){return 0<h(x,A[S][1])}:function(x){return 0<=h(x,A[S][1])},O=b?function(x){return 0<f(x,A[S][0])}:function(x){return 0<=f(x,A[S][0])},C=k,j=new this.Collection(this,function(){return et(A[0][0],A[A.length-1][1],!b,!E)});return j._ondirectionchange=function(x){w=x==="next"?(C=k,h):(C=O,f),A.sort(R)},j._addAlgorithm(function(x,$,N){for(var F,V=x.key;C(V);)if(++S===A.length)return $(N),!1;return!k(F=V)&&!O(F)||(c._cmp(V,A[S][1])===0||c._cmp(V,A[S][0])===0||$(function(){w===h?x.continue(A[S][0]):x.continue(A[S][1])}),!1)}),j},_e.prototype.startsWithAnyOf=function(){var n=Ve.apply(Tt,arguments);return n.every(function(o){return typeof o=="string"})?n.length===0?$t(this):this.inAnyRange(n.map(function(o){return[o,o+ft]})):Re(this,"startsWithAnyOf() only works with strings")},_e);function _e(){}function Fe(n){return fe(function(o){return ir(o),n(o.target.error),!1})}function ir(n){n.stopPropagation&&n.stopPropagation(),n.preventDefault&&n.preventDefault()}var ar="storagemutated",Fn="x-storagemutated-1",tt=nr(null,ar),zo=(Ke.prototype._lock=function(){return X(!Y.global),++this._reculock,this._reculock!==1||Y.global||(Y.lockOwnerFor=this),this},Ke.prototype._unlock=function(){if(X(!Y.global),--this._reculock==0)for(Y.global||(Y.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var n=this._blockedFuncs.shift();try{dt(n[1],n[0])}catch{}}return this},Ke.prototype._locked=function(){return this._reculock&&Y.lockOwnerFor!==this},Ke.prototype.create=function(n){var o=this;if(!this.mode)return this;var c=this.db.idbdb,l=this.db._state.dbOpenError;if(X(!this.idbtrans),!n&&!c)switch(l&&l.name){case"DatabaseClosedError":throw new Z.DatabaseClosed(l);case"MissingAPIError":throw new Z.MissingAPI(l.message,l);default:throw new Z.OpenFailed(l)}if(!this.active)throw new Z.TransactionInactive;return X(this._completion._state===null),(n=this.idbtrans=n||(this.db.core||c).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=fe(function(h){ir(h),o._reject(n.error)}),n.onabort=fe(function(h){ir(h),o.active&&o._reject(new Z.Abort(n.error)),o.active=!1,o.on("abort").fire(h)}),n.oncomplete=fe(function(){o.active=!1,o._resolve(),"mutatedParts"in n&&tt.storagemutated.fire(n.mutatedParts)}),this},Ke.prototype._promise=function(n,o,c){var l=this;if(n==="readwrite"&&this.mode!=="readwrite")return ye(new Z.ReadOnly("Transaction is readonly"));if(!this.active)return ye(new Z.TransactionInactive);if(this._locked())return new z(function(f,g){l._blockedFuncs.push([function(){l._promise(n,o,c).then(f,g)},Y])});if(c)return Ye(function(){var f=new z(function(g,m){l._lock();var b=o(g,m,l);b&&b.then&&b.then(g,m)});return f.finally(function(){return l._unlock()}),f._lib=!0,f});var h=new z(function(f,g){var m=o(f,g,l);m&&m.then&&m.then(f,g)});return h._lib=!0,h},Ke.prototype._root=function(){return this.parent?this.parent._root():this},Ke.prototype.waitFor=function(n){var o,c=this._root(),l=z.resolve(n);c._waitingFor?c._waitingFor=c._waitingFor.then(function(){return l}):(c._waitingFor=l,c._waitingQueue=[],o=c.idbtrans.objectStore(c.storeNames[0]),(function f(){for(++c._spinCount;c._waitingQueue.length;)c._waitingQueue.shift()();c._waitingFor&&(o.get(-1/0).onsuccess=f)})());var h=c._waitingFor;return new z(function(f,g){l.then(function(m){return c._waitingQueue.push(fe(f.bind(null,m)))},function(m){return c._waitingQueue.push(fe(g.bind(null,m)))}).finally(function(){c._waitingFor===h&&(c._waitingFor=null)})})},Ke.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new Z.Abort))},Ke.prototype.table=function(n){var o=this._memoizedTables||(this._memoizedTables={});if(_(o,n))return o[n];var c=this.schema[n];if(!c)throw new Z.NotFound("Table "+n+" not part of transaction");return c=new this.db.Table(n,c,this),c.core=this.db.core.table(n),o[n]=c},Ke);function Ke(){}function Kn(n,o,c,l,h,f,g,m){return{name:n,keyPath:o,unique:c,multi:l,auto:h,compound:f,src:(c&&!g?"&":"")+(l?"*":"")+(h?"++":"")+fi(o),type:m}}function fi(n){return typeof n=="string"?n:n?"["+[].join.call(n,"+")+"]":""}function Mn(n,o,c){return{name:n,primKey:o,indexes:c,mappedClass:null,idxByName:(l=function(h){return[h.name,h]},c.reduce(function(h,f,g){return g=l(f,g),g&&(h[g[0]]=g[1]),h},{}))};var l}var or=function(n){try{return n.only([[]]),or=function(){return[[]]},[[]]}catch{return or=function(){return ft},ft}};function Vn(n){return n==null?function(){}:typeof n=="string"?(o=n).split(".").length===1?function(c){return c[o]}:function(c){return se(c,o)}:function(c){return se(c,n)};var o}function pi(n){return[].slice.call(n)}var Ho=0;function ur(n){return n==null?":id":typeof n=="string"?n:"[".concat(n.join("+"),"]")}function Go(n,o,b){function l(C){if(C.type===3)return null;if(C.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var S=C.lower,k=C.upper,O=C.lowerOpen,C=C.upperOpen;return S===void 0?k===void 0?null:o.upperBound(k,!!C):k===void 0?o.lowerBound(S,!!O):o.bound(S,k,!!O,!!C)}function h(R){var S,k=R.name;return{name:k,schema:R,mutate:function(O){var C=O.trans,j=O.type,x=O.keys,$=O.values,N=O.range;return new Promise(function(F,V){F=fe(F);var U=C.objectStore(k),K=U.keyPath==null,W=j==="put"||j==="add";if(!W&&j!=="delete"&&j!=="deleteRange")throw new Error("Invalid operation type: "+j);var M,G=(x||$||{length:1}).length;if(x&&$&&x.length!==$.length)throw new Error("Given keys array must have same length as given values array.");if(G===0)return F({numFailures:0,failures:{},results:[],lastResult:void 0});function re(Ae){++je,ir(Ae)}var ne=[],ie=[],je=0;if(j==="deleteRange"){if(N.type===4)return F({numFailures:je,failures:ie,results:[],lastResult:void 0});N.type===3?ne.push(M=U.clear()):ne.push(M=U.delete(l(N)))}else{var K=W?K?[$,x]:[$,null]:[x,null],te=K[0],ke=K[1];if(W)for(var Oe=0;Oe<G;++Oe)ne.push(M=ke&&ke[Oe]!==void 0?U[j](te[Oe],ke[Oe]):U[j](te[Oe])),M.onerror=re;else for(Oe=0;Oe<G;++Oe)ne.push(M=U[j](te[Oe])),M.onerror=re}function Gr(Ae){Ae=Ae.target.result,ne.forEach(function(mt,us){return mt.error!=null&&(ie[us]=mt.error)}),F({numFailures:je,failures:ie,results:j==="delete"?x:ne.map(function(mt){return mt.result}),lastResult:Ae})}M.onerror=function(Ae){re(Ae),Gr(Ae)},M.onsuccess=Gr})},getMany:function(O){var C=O.trans,j=O.keys;return new Promise(function(x,$){x=fe(x);for(var N,F=C.objectStore(k),V=j.length,U=new Array(V),K=0,W=0,M=function(ne){ne=ne.target,U[ne._pos]=ne.result,++W===K&&x(U)},G=Fe($),re=0;re<V;++re)j[re]!=null&&((N=F.get(j[re]))._pos=re,N.onsuccess=M,N.onerror=G,++K);K===0&&x(U)})},get:function(O){var C=O.trans,j=O.key;return new Promise(function(x,$){x=fe(x);var N=C.objectStore(k).get(j);N.onsuccess=function(F){return x(F.target.result)},N.onerror=Fe($)})},query:(S=E,function(O){return new Promise(function(C,j){C=fe(C);var x,$,N,K=O.trans,F=O.values,V=O.limit,M=O.query,U=V===1/0?void 0:V,W=M.index,M=M.range,K=K.objectStore(k),W=W.isPrimaryKey?K:K.index(W.name),M=l(M);if(V===0)return C({result:[]});S?((U=F?W.getAll(M,U):W.getAllKeys(M,U)).onsuccess=function(G){return C({result:G.target.result})},U.onerror=Fe(j)):(x=0,$=!F&&"openKeyCursor"in W?W.openKeyCursor(M):W.openCursor(M),N=[],$.onsuccess=function(G){var re=$.result;return re?(N.push(F?re.value:re.primaryKey),++x===V?C({result:N}):void re.continue()):C({result:N})},$.onerror=Fe(j))})}),openCursor:function(O){var C=O.trans,j=O.values,x=O.query,$=O.reverse,N=O.unique;return new Promise(function(F,V){F=fe(F);var W=x.index,U=x.range,K=C.objectStore(k),K=W.isPrimaryKey?K:K.index(W.name),W=$?N?"prevunique":"prev":N?"nextunique":"next",M=!j&&"openKeyCursor"in K?K.openKeyCursor(l(U),W):K.openCursor(l(U),W);M.onerror=Fe(V),M.onsuccess=fe(function(G){var re,ne,ie,je,te=M.result;te?(te.___id=++Ho,te.done=!1,re=te.continue.bind(te),ne=(ne=te.continuePrimaryKey)&&ne.bind(te),ie=te.advance.bind(te),je=function(){throw new Error("Cursor not stopped")},te.trans=C,te.stop=te.continue=te.continuePrimaryKey=te.advance=function(){throw new Error("Cursor not started")},te.fail=fe(V),te.next=function(){var ke=this,Oe=1;return this.start(function(){return Oe--?ke.continue():ke.stop()}).then(function(){return ke})},te.start=function(ke){function Oe(){if(M.result)try{ke()}catch(Ae){te.fail(Ae)}else te.done=!0,te.start=function(){throw new Error("Cursor behind last entry")},te.stop()}var Gr=new Promise(function(Ae,mt){Ae=fe(Ae),M.onerror=Fe(mt),te.fail=mt,te.stop=function(us){te.stop=te.continue=te.continuePrimaryKey=te.advance=je,Ae(us)}});return M.onsuccess=fe(function(Ae){M.onsuccess=Oe,Oe()}),te.continue=re,te.continuePrimaryKey=ne,te.advance=ie,Oe(),Gr},F(te)):F(null)},V)})},count:function(O){var C=O.query,j=O.trans,x=C.index,$=C.range;return new Promise(function(N,F){var V=j.objectStore(k),U=x.isPrimaryKey?V:V.index(x.name),V=l($),U=V?U.count(V):U.count();U.onsuccess=fe(function(K){return N(K.target.result)}),U.onerror=Fe(F)})}}}var f,g,m,A=(g=b,m=pi((f=n).objectStoreNames),{schema:{name:f.name,tables:m.map(function(R){return g.objectStore(R)}).map(function(R){var S=R.keyPath,C=R.autoIncrement,k=d(S),O={},C={name:R.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:S==null,compound:k,keyPath:S,autoIncrement:C,unique:!0,extractKey:Vn(S)},indexes:pi(R.indexNames).map(function(j){return R.index(j)}).map(function(N){var x=N.name,$=N.unique,F=N.multiEntry,N=N.keyPath,F={name:x,compound:d(N),keyPath:N,unique:$,multiEntry:F,extractKey:Vn(N)};return O[ur(N)]=F}),getIndexByKeyPath:function(j){return O[ur(j)]}};return O[":id"]=C.primaryKey,S!=null&&(O[ur(S)]=C.primaryKey),C})},hasGetAll:0<m.length&&"getAll"in g.objectStore(m[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),b=A.schema,E=A.hasGetAll,A=b.tables.map(h),w={};return A.forEach(function(R){return w[R.name]=R}),{stack:"dbcore",transaction:n.transaction.bind(n),table:function(R){if(!w[R])throw new Error("Table '".concat(R,"' not found"));return w[R]},MIN_KEY:-1/0,MAX_KEY:or(o),schema:b}}function Jo(n,o,c,l){var h=c.IDBKeyRange;return c.indexedDB,{dbcore:(l=Go(o,h,l),n.dbcore.reduce(function(f,g){return g=g.create,r(r({},f),g(f))},l))}}function Nr(n,l){var c=l.db,l=Jo(n._middlewares,c,n._deps,l);n.core=l.dbcore,n.tables.forEach(function(h){var f=h.name;n.core.schema.tables.some(function(g){return g.name===f})&&(h.core=n.core.table(f),n[f]instanceof n.Table&&(n[f].core=h.core))})}function Ur(n,o,c,l){c.forEach(function(h){var f=l[h];o.forEach(function(g){var m=(function b(E,A){return B(E,A)||(E=y(E))&&b(E,A)})(g,h);(!m||"value"in m&&m.value===void 0)&&(g===n.Transaction.prototype||g instanceof n.Transaction?I(g,h,{get:function(){return this.table(h)},set:function(b){P(this,h,{value:b,writable:!0,configurable:!0,enumerable:!0})}}):g[h]=new n.Table(h,f))})})}function Wn(n,o){o.forEach(function(c){for(var l in c)c[l]instanceof n.Table&&delete c[l]})}function Qo(n,o){return n._cfg.version-o._cfg.version}function Yo(n,o,c,l){var h=n._dbSchema;c.objectStoreNames.contains("$meta")&&!h.$meta&&(h.$meta=Mn("$meta",gi("")[0],[]),n._storeNames.push("$meta"));var f=n._createTransaction("readwrite",n._storeNames,h);f.create(c),f._completion.catch(l);var g=f._reject.bind(f),m=Y.transless||Y;Ye(function(){return Y.trans=f,Y.transless=m,o!==0?(Nr(n,c),E=o,((b=f).storeNames.includes("$meta")?b.table("$meta").get("version").then(function(A){return A??E}):z.resolve(E)).then(function(A){return R=A,S=f,k=c,O=[],A=(w=n)._versions,C=w._dbSchema=qr(0,w.idbdb,k),(A=A.filter(function(j){return j._cfg.version>=R})).length!==0?(A.forEach(function(j){O.push(function(){var x=C,$=j._cfg.dbschema;Fr(w,x,k),Fr(w,$,k),C=w._dbSchema=$;var N=zn(x,$);N.add.forEach(function(W){Hn(k,W[0],W[1].primKey,W[1].indexes)}),N.change.forEach(function(W){if(W.recreate)throw new Z.Upgrade("Not yet support for changing primary key");var M=k.objectStore(W.name);W.add.forEach(function(G){return Lr(M,G)}),W.change.forEach(function(G){M.deleteIndex(G.name),Lr(M,G)}),W.del.forEach(function(G){return M.deleteIndex(G)})});var F=j._cfg.contentUpgrade;if(F&&j._cfg.version>R){Nr(w,k),S._memoizedTables={};var V=$e($);N.del.forEach(function(W){V[W]=x[W]}),Wn(w,[w.Transaction.prototype]),Ur(w,[w.Transaction.prototype],u(V),V),S.schema=V;var U,K=Tn(F);return K&&jt(),N=z.follow(function(){var W;(U=F(S))&&K&&(W=Xe.bind(null,null),U.then(W,W))}),U&&typeof U.then=="function"?z.resolve(U):N.then(function(){return U})}}),O.push(function(x){var $,N,F=j._cfg.dbschema;$=F,N=x,[].slice.call(N.db.objectStoreNames).forEach(function(V){return $[V]==null&&N.db.deleteObjectStore(V)}),Wn(w,[w.Transaction.prototype]),Ur(w,[w.Transaction.prototype],w._storeNames,w._dbSchema),S.schema=w._dbSchema}),O.push(function(x){w.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(w.idbdb.version/10)===j._cfg.version?(w.idbdb.deleteObjectStore("$meta"),delete w._dbSchema.$meta,w._storeNames=w._storeNames.filter(function($){return $!=="$meta"})):x.objectStore("$meta").put(j._cfg.version,"version"))})}),(function j(){return O.length?z.resolve(O.shift()(S.idbtrans)).then(j):z.resolve()})().then(function(){yi(C,k)})):z.resolve();var w,R,S,k,O,C}).catch(g)):(u(h).forEach(function(A){Hn(c,A,h[A].primKey,h[A].indexes)}),Nr(n,c),void z.follow(function(){return n.on.populate.fire(f)}).catch(g));var b,E})}function Xo(n,o){yi(n._dbSchema,o),o.db.version%10!=0||o.objectStoreNames.contains("$meta")||o.db.createObjectStore("$meta").add(Math.ceil(o.db.version/10-1),"version");var c=qr(0,n.idbdb,o);Fr(n,n._dbSchema,o);for(var l=0,h=zn(c,n._dbSchema).change;l<h.length;l++){var f=(function(g){if(g.change.length||g.recreate)return console.warn("Unable to patch indexes of table ".concat(g.name," because it has changes on the type of index or primary key.")),{value:void 0};var m=o.objectStore(g.name);g.add.forEach(function(b){qe&&console.debug("Dexie upgrade patch: Creating missing index ".concat(g.name,".").concat(b.src)),Lr(m,b)})})(h[l]);if(typeof f=="object")return f.value}}function zn(n,o){var c,l={del:[],add:[],change:[]};for(c in n)o[c]||l.del.push(c);for(c in o){var h=n[c],f=o[c];if(h){var g={name:c,def:f,recreate:!1,del:[],add:[],change:[]};if(""+(h.primKey.keyPath||"")!=""+(f.primKey.keyPath||"")||h.primKey.auto!==f.primKey.auto)g.recreate=!0,l.change.push(g);else{var m=h.idxByName,b=f.idxByName,E=void 0;for(E in m)b[E]||g.del.push(E);for(E in b){var A=m[E],w=b[E];A?A.src!==w.src&&g.change.push(w):g.add.push(w)}(0<g.del.length||0<g.add.length||0<g.change.length)&&l.change.push(g)}}else l.add.push([c,f])}return l}function Hn(n,o,c,l){var h=n.db.createObjectStore(o,c.keyPath?{keyPath:c.keyPath,autoIncrement:c.auto}:{autoIncrement:c.auto});return l.forEach(function(f){return Lr(h,f)}),h}function yi(n,o){u(n).forEach(function(c){o.db.objectStoreNames.contains(c)||(qe&&console.debug("Dexie: Creating missing table",c),Hn(o,c,n[c].primKey,n[c].indexes))})}function Lr(n,o){n.createIndex(o.name,o.keyPath,{unique:o.unique,multiEntry:o.multi})}function qr(n,o,c){var l={};return H(o.objectStoreNames,0).forEach(function(h){for(var f=c.objectStore(h),g=Kn(fi(E=f.keyPath),E||"",!0,!1,!!f.autoIncrement,E&&typeof E!="string",!0),m=[],b=0;b<f.indexNames.length;++b){var A=f.index(f.indexNames[b]),E=A.keyPath,A=Kn(A.name,E,!!A.unique,!!A.multiEntry,!1,E&&typeof E!="string",!1);m.push(A)}l[h]=Mn(h,g,m)}),l}function Fr(n,o,c){for(var l=c.db.objectStoreNames,h=0;h<l.length;++h){var f=l[h],g=c.objectStore(f);n._hasGetAll="getAll"in g;for(var m=0;m<g.indexNames.length;++m){var b=g.indexNames[m],E=g.index(b).keyPath,A=typeof E=="string"?E:"["+H(E).join("+")+"]";!o[f]||(E=o[f].idxByName[A])&&(E.name=b,delete o[f].idxByName[A],o[f].idxByName[b]=E)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&a.WorkerGlobalScope&&a instanceof a.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(n._hasGetAll=!1)}function gi(n){return n.split(",").map(function(o,c){var f=o.split(":"),l=(h=f[1])===null||h===void 0?void 0:h.trim(),h=(o=f[0].trim()).replace(/([&*]|\+\+)/g,""),f=/^\[/.test(h)?h.match(/^\[(.*)\]$/)[1].split("+"):h;return Kn(h,f||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),d(f),c===0,l)})}var Zo=(Dt.prototype._createTableSchema=Mn,Dt.prototype._parseIndexSyntax=gi,Dt.prototype._parseStoresSpec=function(n,o){var c=this;u(n).forEach(function(l){if(n[l]!==null){var h=c._parseIndexSyntax(n[l]),f=h.shift();if(!f)throw new Z.Schema("Invalid schema for table "+l+": "+n[l]);if(f.unique=!0,f.multi)throw new Z.Schema("Primary key cannot be multiEntry*");h.forEach(function(g){if(g.auto)throw new Z.Schema("Only primary key can be marked as autoIncrement (++)");if(!g.keyPath)throw new Z.Schema("Index must have a name and cannot be an empty string")}),h=c._createTableSchema(l,f,h),o[l]=h}})},Dt.prototype.stores=function(c){var o=this.db;this._cfg.storesSource=this._cfg.storesSource?p(this._cfg.storesSource,c):c;var c=o._versions,l={},h={};return c.forEach(function(f){p(l,f._cfg.storesSource),h=f._cfg.dbschema={},f._parseStoresSpec(l,h)}),o._dbSchema=h,Wn(o,[o._allTables,o,o.Transaction.prototype]),Ur(o,[o._allTables,o,o.Transaction.prototype,this._cfg.tables],u(h),h),o._storeNames=u(h),this},Dt.prototype.upgrade=function(n){return this._cfg.contentUpgrade=Pn(this._cfg.contentUpgrade||le,n),this},Dt);function Dt(){}function Gn(n,o){var c=n._dbNamesDB;return c||(c=n._dbNamesDB=new ze(jr,{addons:[],indexedDB:n,IDBKeyRange:o})).version(1).stores({dbnames:"name"}),c.table("dbnames")}function Jn(n){return n&&typeof n.databases=="function"}function Qn(n){return Ye(function(){return Y.letThrough=!0,n()})}function Yn(n){return!("from"in n)}var Se=function(n,o){if(!this){var c=new Se;return n&&"d"in n&&p(c,n),c}p(this,arguments.length?{d:1,from:n,to:1<arguments.length?o:n}:{d:0})};function cr(n,o,c){var l=oe(o,c);if(!isNaN(l)){if(0<l)throw RangeError();if(Yn(n))return p(n,{from:o,to:c,d:1});var h=n.l,l=n.r;if(oe(c,n.from)<0)return h?cr(h,o,c):n.l={from:o,to:c,d:1,l:null,r:null},vi(n);if(0<oe(o,n.to))return l?cr(l,o,c):n.r={from:o,to:c,d:1,l:null,r:null},vi(n);oe(o,n.from)<0&&(n.from=o,n.l=null,n.d=l?l.d+1:1),0<oe(c,n.to)&&(n.to=c,n.r=null,n.d=n.l?n.l.d+1:1),c=!n.r,h&&!n.l&&lr(n,h),l&&c&&lr(n,l)}}function lr(n,o){Yn(o)||(function c(l,b){var f=b.from,g=b.to,m=b.l,b=b.r;cr(l,f,g),m&&c(l,m),b&&c(l,b)})(n,o)}function mi(n,o){var c=Kr(o),l=c.next();if(l.done)return!1;for(var h=l.value,f=Kr(n),g=f.next(h.from),m=g.value;!l.done&&!g.done;){if(oe(m.from,h.to)<=0&&0<=oe(m.to,h.from))return!0;oe(h.from,m.from)<0?h=(l=c.next(m.from)).value:m=(g=f.next(h.from)).value}return!1}function Kr(n){var o=Yn(n)?null:{s:0,n};return{next:function(c){for(var l=0<arguments.length;o;)switch(o.s){case 0:if(o.s=1,l)for(;o.n.l&&oe(c,o.n.from)<0;)o={up:o,n:o.n.l,s:1};else for(;o.n.l;)o={up:o,n:o.n.l,s:1};case 1:if(o.s=2,!l||oe(c,o.n.to)<=0)return{value:o.n,done:!1};case 2:if(o.n.r){o.s=3,o={up:o,n:o.n.r,s:0};continue}case 3:o=o.up}return{done:!0}}}}function vi(n){var o,c,l=(((o=n.r)===null||o===void 0?void 0:o.d)||0)-(((c=n.l)===null||c===void 0?void 0:c.d)||0),h=1<l?"r":l<-1?"l":"";h&&(o=h=="r"?"l":"r",c=r({},n),l=n[h],n.from=l.from,n.to=l.to,n[h]=l[h],c[h]=l[o],(n[o]=c).d=wi(c)),n.d=wi(n)}function wi(c){var o=c.r,c=c.l;return(o?c?Math.max(o.d,c.d):o.d:c?c.d:0)+1}function Mr(n,o){return u(o).forEach(function(c){n[c]?lr(n[c],o[c]):n[c]=(function l(h){var f,g,m={};for(f in h)_(h,f)&&(g=h[f],m[f]=!g||typeof g!="object"||Ws.has(g.constructor)?g:l(g));return m})(o[c])}),n}function Xn(n,o){return n.all||o.all||Object.keys(n).some(function(c){return o[c]&&mi(o[c],n[c])})}T(Se.prototype,((xe={add:function(n){return lr(this,n),this},addKey:function(n){return cr(this,n,n),this},addKeys:function(n){var o=this;return n.forEach(function(c){return cr(o,c,c)}),this},hasKey:function(n){var o=Kr(this).next(n).value;return o&&oe(o.from,n)<=0&&0<=oe(o.to,n)}})[On]=function(){return Kr(this)},xe));var yt={},Zn={},es=!1;function Vr(n){Mr(Zn,n),es||(es=!0,setTimeout(function(){es=!1,ts(Zn,!(Zn={}))},0))}function ts(n,o){o===void 0&&(o=!1);var c=new Set;if(n.all)for(var l=0,h=Object.values(yt);l<h.length;l++)_i(g=h[l],n,c,o);else for(var f in n){var g,m=/^idb\:\/\/(.*)\/(.*)\//.exec(f);m&&(f=m[1],m=m[2],(g=yt["idb://".concat(f,"/").concat(m)])&&_i(g,n,c,o))}c.forEach(function(b){return b()})}function _i(n,o,c,l){for(var h=[],f=0,g=Object.entries(n.queries.query);f<g.length;f++){for(var m=g[f],b=m[0],E=[],A=0,w=m[1];A<w.length;A++){var R=w[A];Xn(o,R.obsSet)?R.subscribers.forEach(function(C){return c.add(C)}):l&&E.push(R)}l&&h.push([b,E])}if(l)for(var S=0,k=h;S<k.length;S++){var O=k[S],b=O[0],E=O[1];n.queries.query[b]=E}}function eu(n){var o=n._state,c=n._deps.indexedDB;if(o.isBeingOpened||n.idbdb)return o.dbReadyPromise.then(function(){return o.dbOpenError?ye(o.dbOpenError):n});o.isBeingOpened=!0,o.dbOpenError=null,o.openComplete=!1;var l=o.openCanceller,h=Math.round(10*n.verno),f=!1;function g(){if(o.openCanceller!==l)throw new Z.DatabaseClosed("db.open() was cancelled")}function m(){return new z(function(R,S){if(g(),!c)throw new Z.MissingAPI;var k=n.name,O=o.autoSchema||!h?c.open(k):c.open(k,h);if(!O)throw new Z.MissingAPI;O.onerror=Fe(S),O.onblocked=fe(n._fireOnBlocked),O.onupgradeneeded=fe(function(C){var j;A=O.transaction,o.autoSchema&&!n._options.allowEmptyDB?(O.onerror=ir,A.abort(),O.result.close(),(j=c.deleteDatabase(k)).onsuccess=j.onerror=fe(function(){S(new Z.NoSuchDatabase("Database ".concat(k," doesnt exist")))})):(A.onerror=Fe(S),C=C.oldVersion>Math.pow(2,62)?0:C.oldVersion,w=C<1,n.idbdb=O.result,f&&Xo(n,A),Yo(n,C/10,A,S))},S),O.onsuccess=fe(function(){A=null;var C,j,x,$,N,F=n.idbdb=O.result,V=H(F.objectStoreNames);if(0<V.length)try{var U=F.transaction(($=V).length===1?$[0]:$,"readonly");if(o.autoSchema)j=F,x=U,(C=n).verno=j.version/10,x=C._dbSchema=qr(0,j,x),C._storeNames=H(j.objectStoreNames,0),Ur(C,[C._allTables],u(x),x);else if(Fr(n,n._dbSchema,U),((N=zn(qr(0,(N=n).idbdb,U),N._dbSchema)).add.length||N.change.some(function(K){return K.add.length||K.change.length}))&&!f)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),F.close(),h=F.version+1,f=!0,R(m());Nr(n,U)}catch{}It.push(n),F.onversionchange=fe(function(K){o.vcFired=!0,n.on("versionchange").fire(K)}),F.onclose=fe(function(){n.close({disableAutoOpen:!1})}),w&&(N=n._deps,U=k,F=N.indexedDB,N=N.IDBKeyRange,Jn(F)||U===jr||Gn(F,N).put({name:U}).catch(le)),R()},S)}).catch(function(R){switch(R?.name){case"UnknownError":if(0<o.PR1398_maxLoop)return o.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),m();break;case"VersionError":if(0<h)return h=0,m()}return z.reject(R)})}var b,E=o.dbReadyResolve,A=null,w=!1;return z.race([l,(typeof navigator>"u"?z.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(R){function S(){return indexedDB.databases().finally(R)}b=setInterval(S,100),S()}).finally(function(){return clearInterval(b)}):Promise.resolve()).then(m)]).then(function(){return g(),o.onReadyBeingFired=[],z.resolve(Qn(function(){return n.on.ready.fire(n.vip)})).then(function R(){if(0<o.onReadyBeingFired.length){var S=o.onReadyBeingFired.reduce(Pn,le);return o.onReadyBeingFired=[],z.resolve(Qn(function(){return S(n.vip)})).then(R)}})}).finally(function(){o.openCanceller===l&&(o.onReadyBeingFired=null,o.isBeingOpened=!1)}).catch(function(R){o.dbOpenError=R;try{A&&A.abort()}catch{}return l===o.openCanceller&&n._close(),ye(R)}).finally(function(){o.openComplete=!0,E()}).then(function(){var R;return w&&(R={},n.tables.forEach(function(S){S.schema.indexes.forEach(function(k){k.name&&(R["idb://".concat(n.name,"/").concat(S.name,"/").concat(k.name)]=new Se(-1/0,[[[]]]))}),R["idb://".concat(n.name,"/").concat(S.name,"/")]=R["idb://".concat(n.name,"/").concat(S.name,"/:dels")]=new Se(-1/0,[[[]]])}),tt(ar).fire(R),ts(R,!0)),n})}function rs(n){function o(f){return n.next(f)}var c=h(o),l=h(function(f){return n.throw(f)});function h(f){return function(b){var m=f(b),b=m.value;return m.done?b:b&&typeof b.then=="function"?b.then(c,l):d(b)?Promise.all(b).then(c,l):c(b)}}return h(o)()}function Wr(n,o,c){for(var l=d(n)?n.slice():[n],h=0;h<c;++h)l.push(o);return l}var tu={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(n){return r(r({},n),{table:function(o){var c=n.table(o),l=c.schema,h={},f=[];function g(w,R,S){var k=ur(w),O=h[k]=h[k]||[],C=w==null?0:typeof w=="string"?1:w.length,j=0<R,j=r(r({},S),{name:j?"".concat(k,"(virtual-from:").concat(S.name,")"):S.name,lowLevelIndex:S,isVirtual:j,keyTail:R,keyLength:C,extractKey:Vn(w),unique:!j&&S.unique});return O.push(j),j.isPrimaryKey||f.push(j),1<C&&g(C===2?w[0]:w.slice(0,C-1),R+1,S),O.sort(function(x,$){return x.keyTail-$.keyTail}),j}o=g(l.primaryKey.keyPath,0,l.primaryKey),h[":id"]=[o];for(var m=0,b=l.indexes;m<b.length;m++){var E=b[m];g(E.keyPath,0,E)}function A(w){var R,S=w.query.index;return S.isVirtual?r(r({},w),{query:{index:S.lowLevelIndex,range:(R=w.query.range,S=S.keyTail,{type:R.type===1?2:R.type,lower:Wr(R.lower,R.lowerOpen?n.MAX_KEY:n.MIN_KEY,S),lowerOpen:!0,upper:Wr(R.upper,R.upperOpen?n.MIN_KEY:n.MAX_KEY,S),upperOpen:!0})}}):w}return r(r({},c),{schema:r(r({},l),{primaryKey:o,indexes:f,getIndexByKeyPath:function(w){return(w=h[ur(w)])&&w[0]}}),count:function(w){return c.count(A(w))},query:function(w){return c.query(A(w))},openCursor:function(w){var R=w.query.index,S=R.keyTail,k=R.isVirtual,O=R.keyLength;return k?c.openCursor(A(w)).then(function(j){return j&&C(j)}):c.openCursor(w);function C(j){return Object.create(j,{continue:{value:function(x){x!=null?j.continue(Wr(x,w.reverse?n.MAX_KEY:n.MIN_KEY,S)):w.unique?j.continue(j.key.slice(0,O).concat(w.reverse?n.MIN_KEY:n.MAX_KEY,S)):j.continue()}},continuePrimaryKey:{value:function(x,$){j.continuePrimaryKey(Wr(x,n.MAX_KEY,S),$)}},primaryKey:{get:function(){return j.primaryKey}},key:{get:function(){var x=j.key;return O===1?x[0]:x.slice(0,O)}},value:{get:function(){return j.value}}})}}})}})}};function ns(n,o,c,l){return c=c||{},l=l||"",u(n).forEach(function(h){var f,g,m;_(o,h)?(f=n[h],g=o[h],typeof f=="object"&&typeof g=="object"&&f&&g?(m=kn(f))!==kn(g)?c[l+h]=o[h]:m==="Object"?ns(f,g,c,l+h+"."):f!==g&&(c[l+h]=o[h]):f!==g&&(c[l+h]=o[h])):c[l+h]=void 0}),u(o).forEach(function(h){_(n,h)||(c[l+h]=o[h])}),c}function ss(n,o){return o.type==="delete"?o.keys:o.keys||o.values.map(n.extractKey)}var ru={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(n){return r(r({},n),{table:function(o){var c=n.table(o),l=c.schema.primaryKey;return r(r({},c),{mutate:function(h){var f=Y.trans,g=f.table(o).hook,m=g.deleting,b=g.creating,E=g.updating;switch(h.type){case"add":if(b.fire===le)break;return f._promise("readwrite",function(){return A(h)},!0);case"put":if(b.fire===le&&E.fire===le)break;return f._promise("readwrite",function(){return A(h)},!0);case"delete":if(m.fire===le)break;return f._promise("readwrite",function(){return A(h)},!0);case"deleteRange":if(m.fire===le)break;return f._promise("readwrite",function(){return(function w(R,S,k){return c.query({trans:R,values:!1,query:{index:l,range:S},limit:k}).then(function(O){var C=O.result;return A({type:"delete",keys:C,trans:R}).then(function(j){return 0<j.numFailures?Promise.reject(j.failures[0]):C.length<k?{failures:[],numFailures:0,lastResult:void 0}:w(R,r(r({},S),{lower:C[C.length-1],lowerOpen:!0}),k)})})})(h.trans,h.range,1e4)},!0)}return c.mutate(h);function A(w){var R,S,k,O=Y.trans,C=w.keys||ss(l,w);if(!C)throw new Error("Keys missing");return(w=w.type==="add"||w.type==="put"?r(r({},w),{keys:C}):r({},w)).type!=="delete"&&(w.values=s([],w.values)),w.keys&&(w.keys=s([],w.keys)),R=c,k=C,((S=w).type==="add"?Promise.resolve([]):R.getMany({trans:S.trans,keys:k,cache:"immutable"})).then(function(j){var x=C.map(function($,N){var F,V,U,K=j[N],W={onerror:null,onsuccess:null};return w.type==="delete"?m.fire.call(W,$,K,O):w.type==="add"||K===void 0?(F=b.fire.call(W,$,w.values[N],O),$==null&&F!=null&&(w.keys[N]=$=F,l.outbound||ae(w.values[N],l.keyPath,$))):(F=ns(K,w.values[N]),(V=E.fire.call(W,F,$,K,O))&&(U=w.values[N],Object.keys(V).forEach(function(M){_(U,M)?U[M]=V[M]:ae(U,M,V[M])}))),W});return c.mutate(w).then(function($){for(var N=$.failures,F=$.results,V=$.numFailures,$=$.lastResult,U=0;U<C.length;++U){var K=(F||C)[U],W=x[U];K==null?W.onerror&&W.onerror(N[U]):W.onsuccess&&W.onsuccess(w.type==="put"&&j[U]?w.values[U]:K)}return{failures:N,results:F,numFailures:V,lastResult:$}}).catch(function($){return x.forEach(function(N){return N.onerror&&N.onerror($)}),Promise.reject($)})})}}})}})}};function bi(n,o,c){try{if(!o||o.keys.length<n.length)return null;for(var l=[],h=0,f=0;h<o.keys.length&&f<n.length;++h)oe(o.keys[h],n[f])===0&&(l.push(c?it(o.values[h]):o.values[h]),++f);return l.length===n.length?l:null}catch{return null}}var nu={stack:"dbcore",level:-1,create:function(n){return{table:function(o){var c=n.table(o);return r(r({},c),{getMany:function(l){if(!l.cache)return c.getMany(l);var h=bi(l.keys,l.trans._cache,l.cache==="clone");return h?z.resolve(h):c.getMany(l).then(function(f){return l.trans._cache={keys:l.keys,values:l.cache==="clone"?it(f):f},f})},mutate:function(l){return l.type!=="add"&&(l.trans._cache=null),c.mutate(l)}})}}}};function Ei(n,o){return n.trans.mode==="readonly"&&!!n.subscr&&!n.trans.explicit&&n.trans.db._options.cache!=="disabled"&&!o.schema.primaryKey.outbound}function Si(n,o){switch(n){case"query":return o.values&&!o.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var su={stack:"dbcore",level:0,name:"Observability",create:function(n){var o=n.schema.name,c=new Se(n.MIN_KEY,n.MAX_KEY);return r(r({},n),{transaction:function(l,h,f){if(Y.subscr&&h!=="readonly")throw new Z.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(Y.querier));return n.transaction(l,h,f)},table:function(l){var h=n.table(l),f=h.schema,g=f.primaryKey,w=f.indexes,m=g.extractKey,b=g.outbound,E=g.autoIncrement&&w.filter(function(S){return S.compound&&S.keyPath.includes(g.keyPath)}),A=r(r({},h),{mutate:function(S){function k(M){return M="idb://".concat(o,"/").concat(l,"/").concat(M),$[M]||($[M]=new Se)}var O,C,j,x=S.trans,$=S.mutatedParts||(S.mutatedParts={}),N=k(""),F=k(":dels"),V=S.type,W=S.type==="deleteRange"?[S.range]:S.type==="delete"?[S.keys]:S.values.length<50?[ss(g,S).filter(function(M){return M}),S.values]:[],U=W[0],K=W[1],W=S.trans._cache;return d(U)?(N.addKeys(U),(W=V==="delete"||U.length===K.length?bi(U,W):null)||F.addKeys(U),(W||K)&&(O=k,C=W,j=K,f.indexes.forEach(function(M){var G=O(M.name||"");function re(ie){return ie!=null?M.extractKey(ie):null}function ne(ie){return M.multiEntry&&d(ie)?ie.forEach(function(je){return G.addKey(je)}):G.addKey(ie)}(C||j).forEach(function(ie,ke){var te=C&&re(C[ke]),ke=j&&re(j[ke]);oe(te,ke)!==0&&(te!=null&&ne(te),ke!=null&&ne(ke))})}))):U?(K={from:(K=U.lower)!==null&&K!==void 0?K:n.MIN_KEY,to:(K=U.upper)!==null&&K!==void 0?K:n.MAX_KEY},F.add(K),N.add(K)):(N.add(c),F.add(c),f.indexes.forEach(function(M){return k(M.name).add(c)})),h.mutate(S).then(function(M){return!U||S.type!=="add"&&S.type!=="put"||(N.addKeys(M.results),E&&E.forEach(function(G){for(var re=S.values.map(function(te){return G.extractKey(te)}),ne=G.keyPath.findIndex(function(te){return te===g.keyPath}),ie=0,je=M.results.length;ie<je;++ie)re[ie][ne]=M.results[ie];k(G.name).addKeys(re)})),x.mutatedParts=Mr(x.mutatedParts||{},$),M})}}),w=function(k){var O=k.query,k=O.index,O=O.range;return[k,new Se((k=O.lower)!==null&&k!==void 0?k:n.MIN_KEY,(O=O.upper)!==null&&O!==void 0?O:n.MAX_KEY)]},R={get:function(S){return[g,new Se(S.key)]},getMany:function(S){return[g,new Se().addKeys(S.keys)]},count:w,query:w,openCursor:w};return u(R).forEach(function(S){A[S]=function(k){var O=Y.subscr,C=!!O,j=Ei(Y,h)&&Si(S,k)?k.obsSet={}:O;if(C){var x=function(K){return K="idb://".concat(o,"/").concat(l,"/").concat(K),j[K]||(j[K]=new Se)},$=x(""),N=x(":dels"),O=R[S](k),C=O[0],O=O[1];if((S==="query"&&C.isPrimaryKey&&!k.values?N:x(C.name||"")).add(O),!C.isPrimaryKey){if(S!=="count"){var F=S==="query"&&b&&k.values&&h.query(r(r({},k),{values:!1}));return h[S].apply(this,arguments).then(function(K){if(S==="query"){if(b&&k.values)return F.then(function(re){return re=re.result,$.addKeys(re),K});var W=k.values?K.result.map(m):K.result;(k.values?$:N).addKeys(W)}else if(S==="openCursor"){var M=K,G=k.values;return M&&Object.create(M,{key:{get:function(){return N.addKey(M.primaryKey),M.key}},primaryKey:{get:function(){var re=M.primaryKey;return N.addKey(re),re}},value:{get:function(){return G&&$.addKey(M.primaryKey),M.value}}})}return K})}N.add(c)}}return h[S].apply(this,arguments)}}),A}})}};function ki(n,o,c){if(c.numFailures===0)return o;if(o.type==="deleteRange")return null;var l=o.keys?o.keys.length:"values"in o&&o.values?o.values.length:1;return c.numFailures===l?null:(o=r({},o),d(o.keys)&&(o.keys=o.keys.filter(function(h,f){return!(f in c.failures)})),"values"in o&&d(o.values)&&(o.values=o.values.filter(function(h,f){return!(f in c.failures)})),o)}function is(n,o){return c=n,((l=o).lower===void 0||(l.lowerOpen?0<oe(c,l.lower):0<=oe(c,l.lower)))&&(n=n,(o=o).upper===void 0||(o.upperOpen?oe(n,o.upper)<0:oe(n,o.upper)<=0));var c,l}function Oi(n,o,R,l,h,f){if(!R||R.length===0)return n;var g=o.query.index,m=g.multiEntry,b=o.query.range,E=l.schema.primaryKey.extractKey,A=g.extractKey,w=(g.lowLevelIndex||g).extractKey,R=R.reduce(function(S,k){var O=S,C=[];if(k.type==="add"||k.type==="put")for(var j=new Se,x=k.values.length-1;0<=x;--x){var $,N=k.values[x],F=E(N);j.hasKey(F)||($=A(N),(m&&d($)?$.some(function(M){return is(M,b)}):is($,b))&&(j.addKey(F),C.push(N)))}switch(k.type){case"add":var V=new Se().addKeys(o.values?S.map(function(G){return E(G)}):S),O=S.concat(o.values?C.filter(function(G){return G=E(G),!V.hasKey(G)&&(V.addKey(G),!0)}):C.map(function(G){return E(G)}).filter(function(G){return!V.hasKey(G)&&(V.addKey(G),!0)}));break;case"put":var U=new Se().addKeys(k.values.map(function(G){return E(G)}));O=S.filter(function(G){return!U.hasKey(o.values?E(G):G)}).concat(o.values?C:C.map(function(G){return E(G)}));break;case"delete":var K=new Se().addKeys(k.keys);O=S.filter(function(G){return!K.hasKey(o.values?E(G):G)});break;case"deleteRange":var W=k.range;O=S.filter(function(G){return!is(E(G),W)})}return O},n);return R===n?n:(R.sort(function(S,k){return oe(w(S),w(k))||oe(E(S),E(k))}),o.limit&&o.limit<1/0&&(R.length>o.limit?R.length=o.limit:n.length===o.limit&&R.length<o.limit&&(h.dirty=!0)),f?Object.freeze(R):R)}function Ti(n,o){return oe(n.lower,o.lower)===0&&oe(n.upper,o.upper)===0&&!!n.lowerOpen==!!o.lowerOpen&&!!n.upperOpen==!!o.upperOpen}function iu(n,o){return(function(c,l,h,f){if(c===void 0)return l!==void 0?-1:0;if(l===void 0)return 1;if((l=oe(c,l))===0){if(h&&f)return 0;if(h)return 1;if(f)return-1}return l})(n.lower,o.lower,n.lowerOpen,o.lowerOpen)<=0&&0<=(function(c,l,h,f){if(c===void 0)return l!==void 0?1:0;if(l===void 0)return-1;if((l=oe(c,l))===0){if(h&&f)return 0;if(h)return-1;if(f)return 1}return l})(n.upper,o.upper,n.upperOpen,o.upperOpen)}function au(n,o,c,l){n.subscribers.add(c),l.addEventListener("abort",function(){var h,f;n.subscribers.delete(c),n.subscribers.size===0&&(h=n,f=o,setTimeout(function(){h.subscribers.size===0&&at(f,h)},3e3))})}var ou={stack:"dbcore",level:0,name:"Cache",create:function(n){var o=n.schema.name;return r(r({},n),{transaction:function(c,l,h){var f,g,m=n.transaction(c,l,h);return l==="readwrite"&&(g=(f=new AbortController).signal,h=function(b){return function(){if(f.abort(),l==="readwrite"){for(var E=new Set,A=0,w=c;A<w.length;A++){var R=w[A],S=yt["idb://".concat(o,"/").concat(R)];if(S){var k=n.table(R),O=S.optimisticOps.filter(function(G){return G.trans===m});if(m._explicit&&b&&m.mutatedParts)for(var C=0,j=Object.values(S.queries.query);C<j.length;C++)for(var x=0,$=(V=j[C]).slice();x<$.length;x++)Xn((U=$[x]).obsSet,m.mutatedParts)&&(at(V,U),U.subscribers.forEach(function(G){return E.add(G)}));else if(0<O.length){S.optimisticOps=S.optimisticOps.filter(function(G){return G.trans!==m});for(var N=0,F=Object.values(S.queries.query);N<F.length;N++)for(var V,U,K,W=0,M=(V=F[N]).slice();W<M.length;W++)(U=M[W]).res!=null&&m.mutatedParts&&(b&&!U.dirty?(K=Object.isFrozen(U.res),K=Oi(U.res,U.req,O,k,U,K),U.dirty?(at(V,U),U.subscribers.forEach(function(G){return E.add(G)})):K!==U.res&&(U.res=K,U.promise=z.resolve({result:K}))):(U.dirty&&at(V,U),U.subscribers.forEach(function(G){return E.add(G)})))}}}E.forEach(function(G){return G()})}}},m.addEventListener("abort",h(!1),{signal:g}),m.addEventListener("error",h(!1),{signal:g}),m.addEventListener("complete",h(!0),{signal:g})),m},table:function(c){var l=n.table(c),h=l.schema.primaryKey;return r(r({},l),{mutate:function(f){var g=Y.trans;if(h.outbound||g.db._options.cache==="disabled"||g.explicit||g.idbtrans.mode!=="readwrite")return l.mutate(f);var m=yt["idb://".concat(o,"/").concat(c)];return m?(g=l.mutate(f),f.type!=="add"&&f.type!=="put"||!(50<=f.values.length||ss(h,f).some(function(b){return b==null}))?(m.optimisticOps.push(f),f.mutatedParts&&Vr(f.mutatedParts),g.then(function(b){0<b.numFailures&&(at(m.optimisticOps,f),(b=ki(0,f,b))&&m.optimisticOps.push(b),f.mutatedParts&&Vr(f.mutatedParts))}),g.catch(function(){at(m.optimisticOps,f),f.mutatedParts&&Vr(f.mutatedParts)})):g.then(function(b){var E=ki(0,r(r({},f),{values:f.values.map(function(A,w){var R;return b.failures[w]?A:(A=(R=h.keyPath)!==null&&R!==void 0&&R.includes(".")?it(A):r({},A),ae(A,h.keyPath,b.results[w]),A)})}),b);m.optimisticOps.push(E),queueMicrotask(function(){return f.mutatedParts&&Vr(f.mutatedParts)})}),g):l.mutate(f)},query:function(f){if(!Ei(Y,l)||!Si("query",f))return l.query(f);var g=((E=Y.trans)===null||E===void 0?void 0:E.db._options.cache)==="immutable",w=Y,m=w.requery,b=w.signal,E=(function(k,O,C,j){var x=yt["idb://".concat(k,"/").concat(O)];if(!x)return[];if(!(O=x.queries[C]))return[null,!1,x,null];var $=O[(j.query?j.query.index.name:null)||""];if(!$)return[null,!1,x,null];switch(C){case"query":var N=$.find(function(F){return F.req.limit===j.limit&&F.req.values===j.values&&Ti(F.req.query.range,j.query.range)});return N?[N,!0,x,$]:[$.find(function(F){return("limit"in F.req?F.req.limit:1/0)>=j.limit&&(!j.values||F.req.values)&&iu(F.req.query.range,j.query.range)}),!1,x,$];case"count":return N=$.find(function(F){return Ti(F.req.query.range,j.query.range)}),[N,!!N,x,$]}})(o,c,"query",f),A=E[0],w=E[1],R=E[2],S=E[3];return A&&w?A.obsSet=f.obsSet:(w=l.query(f).then(function(k){var O=k.result;if(A&&(A.res=O),g){for(var C=0,j=O.length;C<j;++C)Object.freeze(O[C]);Object.freeze(O)}else k.result=it(O);return k}).catch(function(k){return S&&A&&at(S,A),Promise.reject(k)}),A={obsSet:f.obsSet,promise:w,subscribers:new Set,type:"query",req:f,dirty:!1},S?S.push(A):(S=[A],(R=R||(yt["idb://".concat(o,"/").concat(c)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[f.query.index.name||""]=S)),au(A,S,m,b),A.promise.then(function(k){return{result:Oi(k.result,f,R?.optimisticOps,l,A,g)}})}})}})}};function zr(n,o){return new Proxy(n,{get:function(c,l,h){return l==="db"?o:Reflect.get(c,l,h)}})}var ze=(ge.prototype.version=function(n){if(isNaN(n)||n<.1)throw new Z.Type("Given version is not a positive number");if(n=Math.round(10*n)/10,this.idbdb||this._state.isBeingOpened)throw new Z.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,n);var o=this._versions,c=o.filter(function(l){return l._cfg.version===n})[0];return c||(c=new this.Version(n),o.push(c),o.sort(Qo),c.stores({}),this._state.autoSchema=!1,c)},ge.prototype._whenReady=function(n){var o=this;return this.idbdb&&(this._state.openComplete||Y.letThrough||this._vip)?n():new z(function(c,l){if(o._state.openComplete)return l(new Z.DatabaseClosed(o._state.dbOpenError));if(!o._state.isBeingOpened){if(!o._state.autoOpen)return void l(new Z.DatabaseClosed);o.open().catch(le)}o._state.dbReadyPromise.then(c,l)}).then(n)},ge.prototype.use=function(n){var o=n.stack,c=n.create,l=n.level,h=n.name;return h&&this.unuse({stack:o,name:h}),n=this._middlewares[o]||(this._middlewares[o]=[]),n.push({stack:o,create:c,level:l??10,name:h}),n.sort(function(f,g){return f.level-g.level}),this},ge.prototype.unuse=function(n){var o=n.stack,c=n.name,l=n.create;return o&&this._middlewares[o]&&(this._middlewares[o]=this._middlewares[o].filter(function(h){return l?h.create!==l:!!c&&h.name!==c})),this},ge.prototype.open=function(){var n=this;return dt(Qe,function(){return eu(n)})},ge.prototype._close=function(){this.on.close.fire(new CustomEvent("close"));var n=this._state,o=It.indexOf(this);if(0<=o&&It.splice(o,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}n.isBeingOpened||(n.dbReadyPromise=new z(function(c){n.dbReadyResolve=c}),n.openCanceller=new z(function(c,l){n.cancelOpen=l}))},ge.prototype.close=function(c){var o=(c===void 0?{disableAutoOpen:!0}:c).disableAutoOpen,c=this._state;o?(c.isBeingOpened&&c.cancelOpen(new Z.DatabaseClosed),this._close(),c.autoOpen=!1,c.dbOpenError=new Z.DatabaseClosed):(this._close(),c.autoOpen=this._options.autoOpen||c.isBeingOpened,c.openComplete=!1,c.dbOpenError=null)},ge.prototype.delete=function(n){var o=this;n===void 0&&(n={disableAutoOpen:!0});var c=0<arguments.length&&typeof arguments[0]!="object",l=this._state;return new z(function(h,f){function g(){o.close(n);var m=o._deps.indexedDB.deleteDatabase(o.name);m.onsuccess=fe(function(){var b,E,A;b=o._deps,E=o.name,A=b.indexedDB,b=b.IDBKeyRange,Jn(A)||E===jr||Gn(A,b).delete(E).catch(le),h()}),m.onerror=Fe(f),m.onblocked=o._fireOnBlocked}if(c)throw new Z.InvalidArgument("Invalid closeOptions argument to db.delete()");l.isBeingOpened?l.dbReadyPromise.then(g):g()})},ge.prototype.backendDB=function(){return this.idbdb},ge.prototype.isOpen=function(){return this.idbdb!==null},ge.prototype.hasBeenClosed=function(){var n=this._state.dbOpenError;return n&&n.name==="DatabaseClosed"},ge.prototype.hasFailed=function(){return this._state.dbOpenError!==null},ge.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(ge.prototype,"tables",{get:function(){var n=this;return u(this._allTables).map(function(o){return n._allTables[o]})},enumerable:!1,configurable:!0}),ge.prototype.transaction=function(){var n=function(o,c,l){var h=arguments.length;if(h<2)throw new Z.InvalidArgument("Too few arguments");for(var f=new Array(h-1);--h;)f[h-1]=arguments[h];return l=f.pop(),[o,Vs(f),l]}.apply(this,arguments);return this._transaction.apply(this,n)},ge.prototype._transaction=function(n,o,c){var l=this,h=Y.trans;h&&h.db===this&&n.indexOf("!")===-1||(h=null);var f,g,m=n.indexOf("?")!==-1;n=n.replace("!","").replace("?","");try{if(g=o.map(function(E){if(E=E instanceof l.Table?E.name:E,typeof E!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return E}),n=="r"||n===Nn)f=Nn;else{if(n!="rw"&&n!=Un)throw new Z.InvalidArgument("Invalid transaction mode: "+n);f=Un}if(h){if(h.mode===Nn&&f===Un){if(!m)throw new Z.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");h=null}h&&g.forEach(function(E){if(h&&h.storeNames.indexOf(E)===-1){if(!m)throw new Z.SubTransaction("Table "+E+" not included in parent transaction.");h=null}}),m&&h&&!h.active&&(h=null)}}catch(E){return h?h._promise(null,function(A,w){w(E)}):ye(E)}var b=function E(A,w,R,S,k){return z.resolve().then(function(){var O=Y.transless||Y,C=A._createTransaction(w,R,A._dbSchema,S);if(C.explicit=!0,O={trans:C,transless:O},S)C.idbtrans=S.idbtrans;else try{C.create(),C.idbtrans._explicit=!0,A._state.PR1398_maxLoop=3}catch($){return $.name===An.InvalidState&&A.isOpen()&&0<--A._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),A.close({disableAutoOpen:!1}),A.open().then(function(){return E(A,w,R,null,k)})):ye($)}var j,x=Tn(k);return x&&jt(),O=z.follow(function(){var $;(j=k.call(C,C))&&(x?($=Xe.bind(null,null),j.then($,$)):typeof j.next=="function"&&typeof j.throw=="function"&&(j=rs(j)))},O),(j&&typeof j.then=="function"?z.resolve(j).then(function($){return C.active?$:ye(new Z.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):O.then(function(){return j})).then(function($){return S&&C._resolve(),C._completion.then(function(){return $})}).catch(function($){return C._reject($),ye($)})})}.bind(null,this,f,g,h,c);return h?h._promise(f,b,"lock"):Y.trans?dt(Y.transless,function(){return l._whenReady(b)}):this._whenReady(b)},ge.prototype.table=function(n){if(!_(this._allTables,n))throw new Z.InvalidTable("Table ".concat(n," does not exist"));return this._allTables[n]},ge);function ge(n,o){var c=this;this._middlewares={},this.verno=0;var l=ge.dependencies;this._options=o=r({addons:ge.addons,autoOpen:!0,indexedDB:l.indexedDB,IDBKeyRange:l.IDBKeyRange,cache:"cloned"},o),this._deps={indexedDB:o.indexedDB,IDBKeyRange:o.IDBKeyRange},l=o.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var h,f,g,m,b,E={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:le,dbReadyPromise:null,cancelOpen:le,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:o.autoOpen};E.dbReadyPromise=new z(function(w){E.dbReadyResolve=w}),E.openCanceller=new z(function(w,R){E.cancelOpen=R}),this._state=E,this.name=n,this.on=nr(this,"populate","blocked","versionchange","close",{ready:[Pn,le]}),this.once=function(w,R){var S=function(){for(var k=[],O=0;O<arguments.length;O++)k[O]=arguments[O];c.on(w).unsubscribe(S),R.apply(c,k)};return c.on(w,S)},this.on.ready.subscribe=L(this.on.ready.subscribe,function(w){return function(R,S){ge.vip(function(){var k,O=c._state;O.openComplete?(O.dbOpenError||z.resolve().then(R),S&&w(R)):O.onReadyBeingFired?(O.onReadyBeingFired.push(R),S&&w(R)):(w(R),k=c,S||w(function C(){k.on.ready.unsubscribe(R),k.on.ready.unsubscribe(C)}))})}}),this.Collection=(h=this,sr(Mo.prototype,function(j,C){this.db=h;var S=ti,k=null;if(C)try{S=C()}catch(x){k=x}var O=j._ctx,C=O.table,j=C.hook.reading.fire;this._ctx={table:C,index:O.index,isPrimKey:!O.index||C.schema.primKey.keyPath&&O.index===C.schema.primKey.name,range:S,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:k,or:O.or,valueMapper:j!==Yt?j:null}})),this.Table=(f=this,sr(oi.prototype,function(w,R,S){this.db=f,this._tx=S,this.name=w,this.schema=R,this.hook=f._allTables[w]?f._allTables[w].hook:nr(null,{creating:[$o,le],reading:[xo,Yt],updating:[Bo,le],deleting:[Do,le]})})),this.Transaction=(g=this,sr(zo.prototype,function(w,R,S,k,O){var C=this;w!=="readonly"&&R.forEach(function(j){j=(j=S[j])===null||j===void 0?void 0:j.yProps,j&&(R=R.concat(j.map(function(x){return x.updatesTable})))}),this.db=g,this.mode=w,this.storeNames=R,this.schema=S,this.chromeTransactionDurability=k,this.idbtrans=null,this.on=nr(this,"complete","error","abort"),this.parent=O||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new z(function(j,x){C._resolve=j,C._reject=x}),this._completion.then(function(){C.active=!1,C.on.complete.fire()},function(j){var x=C.active;return C.active=!1,C.on.error.fire(j),C.parent?C.parent._reject(j):x&&C.idbtrans&&C.idbtrans.abort(),ye(j)})})),this.Version=(m=this,sr(Zo.prototype,function(w){this.db=m,this._cfg={version:w,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(b=this,sr(di.prototype,function(w,R,S){if(this.db=b,this._ctx={table:w,index:R===":id"?null:R,or:S},this._cmp=this._ascending=oe,this._descending=function(k,O){return oe(O,k)},this._max=function(k,O){return 0<oe(k,O)?k:O},this._min=function(k,O){return oe(k,O)<0?k:O},this._IDBKeyRange=b._deps.IDBKeyRange,!this._IDBKeyRange)throw new Z.MissingAPI})),this.on("versionchange",function(w){0<w.newVersion?console.warn("Another connection wants to upgrade database '".concat(c.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(c.name,"'. Closing db now to resume the delete request.")),c.close({disableAutoOpen:!1})}),this.on("blocked",function(w){!w.newVersion||w.newVersion<w.oldVersion?console.warn("Dexie.delete('".concat(c.name,"') was blocked")):console.warn("Upgrade '".concat(c.name,"' blocked by other connection holding version ").concat(w.oldVersion/10))}),this._maxKey=or(o.IDBKeyRange),this._createTransaction=function(w,R,S,k){return new c.Transaction(w,R,S,c._options.chromeTransactionDurability,k)},this._fireOnBlocked=function(w){c.on("blocked").fire(w),It.filter(function(R){return R.name===c.name&&R!==c&&!R._state.vcFired}).map(function(R){return R.on("versionchange").fire(w)})},this.use(nu),this.use(ou),this.use(su),this.use(tu),this.use(ru);var A=new Proxy(this,{get:function(w,R,S){if(R==="_vip")return!0;if(R==="table")return function(O){return zr(c.table(O),A)};var k=Reflect.get(w,R,S);return k instanceof oi?zr(k,A):R==="tables"?k.map(function(O){return zr(O,A)}):R==="_createTransaction"?function(){return zr(k.apply(this,arguments),A)}:k}});this.vip=A,l.forEach(function(w){return w(c)})}var Hr,xe=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",uu=(as.prototype.subscribe=function(n,o,c){return this._subscribe(n&&typeof n!="function"?n:{next:n,error:o,complete:c})},as.prototype[xe]=function(){return this},as);function as(n){this._subscribe=n}try{Hr={indexedDB:a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,IDBKeyRange:a.IDBKeyRange||a.webkitIDBKeyRange}}catch{Hr={indexedDB:null,IDBKeyRange:null}}function Ai(n){var o,c=!1,l=new uu(function(h){var f=Tn(n),g,m=!1,b={},E={},A={get closed(){return m},unsubscribe:function(){m||(m=!0,g&&g.abort(),w&&tt.storagemutated.unsubscribe(S))}};h.start&&h.start(A);var w=!1,R=function(){return Bn(k)},S=function(O){Mr(b,O),Xn(E,b)&&R()},k=function(){var O,C,j;!m&&Hr.indexedDB&&(b={},O={},g&&g.abort(),g=new AbortController,j=(function(x){var $=Ct();try{f&&jt();var N=Ye(n,x);return N=f?N.finally(Xe):N}finally{$&&Rt()}})(C={subscr:O,signal:g.signal,requery:R,querier:n,trans:null}),Promise.resolve(j).then(function(x){c=!0,o=x,m||C.signal.aborted||(b={},(function($){for(var N in $)if(_($,N))return;return 1})(E=O)||w||(tt(ar,S),w=!0),Bn(function(){return!m&&h.next&&h.next(x)}))},function(x){c=!1,["DatabaseClosedError","AbortError"].includes(x?.name)||m||Bn(function(){m||h.error&&h.error(x)})}))};return setTimeout(R,0),A});return l.hasValue=function(){return c},l.getValue=function(){return o},l}var gt=ze;function os(n){var o=rt;try{rt=!0,tt.storagemutated.fire(n),ts(n,!0)}finally{rt=o}}T(gt,r(r({},Er),{delete:function(n){return new gt(n,{addons:[]}).delete()},exists:function(n){return new gt(n,{addons:[]}).open().then(function(o){return o.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(n){try{return o=gt.dependencies,c=o.indexedDB,o=o.IDBKeyRange,(Jn(c)?Promise.resolve(c.databases()).then(function(l){return l.map(function(h){return h.name}).filter(function(h){return h!==jr})}):Gn(c,o).toCollection().primaryKeys()).then(n)}catch{return ye(new Z.MissingAPI)}var o,c},defineClass:function(){return function(n){p(this,n)}},ignoreTransaction:function(n){return Y.trans?dt(Y.transless,n):n()},vip:Qn,async:function(n){return function(){try{var o=rs(n.apply(this,arguments));return o&&typeof o.then=="function"?o:z.resolve(o)}catch(c){return ye(c)}}},spawn:function(n,o,c){try{var l=rs(n.apply(c,o||[]));return l&&typeof l.then=="function"?l:z.resolve(l)}catch(h){return ye(h)}},currentTransaction:{get:function(){return Y.trans||null}},waitFor:function(n,o){return o=z.resolve(typeof n=="function"?gt.ignoreTransaction(n):n).timeout(o||6e4),Y.trans?Y.trans.waitFor(o):o},Promise:z,debug:{get:function(){return qe},set:function(n){Gs(n)}},derive:D,extend:p,props:T,override:L,Events:nr,on:tt,liveQuery:Ai,extendObservabilitySet:Mr,getByKeyPath:se,setByKeyPath:ae,delByKeyPath:function(n,o){typeof o=="string"?ae(n,o,void 0):"length"in o&&[].map.call(o,function(c){ae(n,c,void 0)})},shallowClone:$e,deepClone:it,getObjectDiff:ns,cmp:oe,asap:ce,minKey:-1/0,addons:[],connections:It,errnames:An,dependencies:Hr,cache:yt,semVer:"4.2.1",version:"4.2.1".split(".").map(function(n){return parseInt(n)}).reduce(function(n,o,c){return n+o/Math.pow(10,2*c)})})),gt.maxKey=or(gt.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(tt(ar,function(n){rt||(n=new CustomEvent(Fn,{detail:n}),rt=!0,dispatchEvent(n),rt=!1)}),addEventListener(Fn,function(n){n=n.detail,rt||os(n)}));var Bt,rt=!1,Pi=function(){};return typeof BroadcastChannel<"u"&&((Pi=function(){(Bt=new BroadcastChannel(Fn)).onmessage=function(n){return n.data&&os(n.data)}})(),typeof Bt.unref=="function"&&Bt.unref(),tt(ar,function(n){rt||Bt.postMessage(n)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(n){if(!ze.disableBfCache&&n.persisted){qe&&console.debug("Dexie: handling persisted pagehide"),Bt?.close();for(var o=0,c=It;o<c.length;o++)c[o].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(n){!ze.disableBfCache&&n.persisted&&(qe&&console.debug("Dexie: handling persisted pageshow"),Pi(),os({all:new Se(-1/0,[[]])}))})),z.rejectionMapper=function(n,o){return!n||n instanceof At||n instanceof TypeError||n instanceof SyntaxError||!n.name||!Hs[n.name]?n:(o=new Hs[n.name](o||n.message,n),"stack"in n&&I(o,"stack",{get:function(){return this.inner.stack}}),o)},Gs(qe),r(ze,Object.freeze({__proto__:null,Dexie:ze,liveQuery:Ai,Entity:ri,cmp:oe,PropModification:rr,replacePrefix:function(n,o){return new rr({replacePrefix:[n,o]})},add:function(n){return new rr({add:n})},remove:function(n){return new rr({remove:n})},default:ze,RangeSet:Se,mergeRanges:lr,rangesOverlap:mi}),{default:ze}),ze})})(sn)),sn.exports}var fu=du();const ms=ua(fu),Ri=Symbol.for("Dexie"),ln=globalThis[Ri]||(globalThis[Ri]=ms);if(ms.semVer!==ln.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${ms.semVer} and ${ln.semVer}`);const{liveQuery:Cl,mergeRanges:Rl,rangesOverlap:jl,RangeSet:Il,cmp:xl,Entity:$l,PropModification:Dl,replacePrefix:Bl,add:Nl,remove:Ul,DexieYProvider:Ll}=ln;class pu extends ln{constructor(){super("microcreditos_db"),this.version(1).stores({tenants:"id, nombre, activo",users:"id, tenant_id, email, [tenant_id+activo]",rutas:"id, tenant_id, nombre, activa, [tenant_id+activa]",productos_credito:"id, tenant_id, activo, [tenant_id+activo]",clientes:`
        id,
        tenant_id,
        ruta_id,
        numero_documento,
        estado,
        [tenant_id+ruta_id],
        [tenant_id+estado],
        [tenant_id+numero_documento]
      `,creditos:`
        id,
        tenant_id,
        cliente_id,
        cobrador_id,
        ruta_id,
        estado,
        [tenant_id+estado],
        [cliente_id+estado],
        [cobrador_id+estado],
        [tenant_id+ruta_id+estado]
      `,cuotas:`
        id,
        credito_id,
        tenant_id,
        numero,
        estado,
        fecha_programada,
        [credito_id+numero],
        [credito_id+estado],
        [tenant_id+estado+fecha_programada]
      `,pagos:`
        id,
        tenant_id,
        credito_id,
        cliente_id,
        cobrador_id,
        fecha,
        synced,
        [tenant_id+fecha],
        [credito_id+fecha],
        [cobrador_id+fecha],
        [synced+fecha]
      `,sync_queue:`
        ++id,
        timestamp,
        table_name,
        record_id,
        operation,
        synced,
        priority,
        [synced+priority+timestamp]
      `,audit_log:`
        ++id,
        timestamp,
        sequence,
        event_type,
        aggregate_type,
        aggregate_id,
        user_id,
        [aggregate_type+aggregate_id+timestamp],
        [user_id+timestamp]
      `,change_log:`
        ++id,
        timestamp,
        table_name,
        record_id,
        synced,
        [synced+timestamp],
        [table_name+record_id]
      `,checksums:"record_key, checksum, timestamp",app_state:"key, value, updated_at"})}async initialize(){try{if(!("indexedDB"in window))throw new Error("IndexedDB no estÃ¡ soportado en este navegador");await this.open(),console.log("â IndexedDB inicializado exitosamente")}catch(e){throw console.error("â FallÃ³ la inicializaciÃ³n de IndexedDB:",e),e}}async getStats(){return{tenants:await this.tenants.count(),users:await this.users.count(),rutas:await this.rutas.count(),productos_credito:await this.productos_credito.count(),clientes:await this.clientes.count(),creditos:await this.creditos.count(),cuotas:await this.cuotas.count(),pagos:await this.pagos.count(),sync_queue:await this.sync_queue.count(),audit_log:await this.audit_log.count(),change_log:await this.change_log.count(),checksums:await this.checksums.count(),app_state:await this.app_state.count()}}async clearAll(){await this.transaction("rw",[this.tenants,this.users,this.rutas,this.productos_credito,this.clientes,this.creditos,this.cuotas,this.pagos,this.sync_queue,this.audit_log,this.change_log,this.checksums,this.app_state],async()=>{await this.tenants.clear(),await this.users.clear(),await this.rutas.clear(),await this.productos_credito.clear(),await this.clientes.clear(),await this.creditos.clear(),await this.cuotas.clear(),await this.pagos.clear(),await this.sync_queue.clear(),await this.audit_log.clear(),await this.change_log.clear(),await this.checksums.clear(),await this.app_state.clear()}),console.log("â Todos los datos limpiados de IndexedDB")}}function yu(i){return new pu}class ca{constructor(e){this.MAX_ATTEMPTS=10,this.INITIAL_BACKOFF_MS=1e3,this.MAX_BACKOFF_MS=3e5,this.db=e}setDatabase(e){this.db=e}async addToQueue(e,t,r,s={}){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");const{priority:a=this.getDefaultPriority(e),data:u=null}=s,d={timestamp:Date.now(),table_name:e,record_id:t,operation:r,data:u,synced:!1,priority:a,attempts:0,last_attempt:null,error:null};return await this.db.sync_queue.add(d)}async getPendingOperations(e){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");const r=(await this.db.sync_queue.toArray()).filter(s=>{if(s.synced)return!1;if(s.attempts===0)return!0;if(s.attempts>=this.MAX_ATTEMPTS)return!1;const a=this.calculateBackoff(s.attempts),u=(s.last_attempt||0)+a;return Date.now()>=u});return r.sort((s,a)=>s.priority!==a.priority?s.priority-a.priority:s.timestamp-a.timestamp),e?r.slice(0,e):r}async markAsSynced(e){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");await this.db.sync_queue.update(e,{synced:!0,error:null})}async markAsFailed(e,t){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");const r=await this.db.sync_queue.get(e);r&&await this.db.sync_queue.update(e,{attempts:r.attempts+1,last_attempt:Date.now(),error:t})}async getStats(){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");const e=await this.db.sync_queue.toArray(),t=e.filter(u=>!u.synced&&u.attempts<this.MAX_ATTEMPTS),r=e.filter(u=>u.synced),s=e.filter(u=>!u.synced&&u.attempts>=this.MAX_ATTEMPTS),a=t.length>0?Math.min(...t.map(u=>u.timestamp)):null;return{total:e.length,pending:t.length,synced:r.length,failed:s.length,oldestPending:a}}async getQueueSize(){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");return await this.db.sync_queue.filter(e=>!e.synced&&e.attempts<this.MAX_ATTEMPTS).count()}async getFailedOperations(){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");return await this.db.sync_queue.filter(e=>!e.synced&&e.attempts>=this.MAX_ATTEMPTS).toArray()}async retryFailedOperation(e){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");await this.db.sync_queue.update(e,{attempts:0,last_attempt:null,error:null})}async clearOldSyncedOperations(e=7){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");const t=Date.now()-e*24*60*60*1e3,s=(await this.db.sync_queue.filter(a=>a.synced&&a.timestamp<t).toArray()).map(a=>a.id);return await this.db.sync_queue.bulkDelete(s),s.length}async clearAll(){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");await this.db.sync_queue.clear()}calculateBackoff(e){const t=this.INITIAL_BACKOFF_MS*Math.pow(2,e-1);return Math.min(t,this.MAX_BACKOFF_MS)}getDefaultPriority(e){switch(e){case"pagos":return 1;case"creditos":case"cuotas":return 2;case"clientes":return 3;default:return 4}}getNextRetryTime(e){if(e.attempts===0)return Date.now();if(e.attempts>=this.MAX_ATTEMPTS)return null;const t=this.calculateBackoff(e.attempts);return(e.last_attempt||0)+t}isReadyToRetry(e){if(e.synced||e.attempts>=this.MAX_ATTEMPTS)return!1;if(e.attempts===0)return!0;const t=this.getNextRetryTime(e);return t!==null&&Date.now()>=t}}class la{constructor(e){this.db=e}setDatabase(e){this.db=e}async getAllPendingChanges(){if(!this.db)throw new Error("Base de datos no configurada en ChangeTracker");return await this.db.change_log.filter(e=>!e.synced).toArray()}async compressChanges(e){return e}async createUploadBatches(e){const t=e.reduce((s,a)=>(s[a.table_name]||(s[a.table_name]=[]),s[a.table_name].push(a),s),{}),r=[];for(const[s,a]of Object.entries(t))r.push({table:s,priority:this.getTablePriority(s),changes:a});return r.sort((s,a)=>s.priority-a.priority),r}async applyDeltas(e){console.log("Aplicando deltas:",e.length)}getTablePriority(e){switch(e){case"pagos":return 1;case"creditos":case"cuotas":return 2;case"clientes":return 3;default:return 4}}}class ha{resolveConflict(e,t,r){return r==="pago"?{resolved:e,strategy:"append_only",conflicts_detected:[],metadata:{}}:this.resolveCRDT(e,t)}resolveCRDT(e,t){const r=e.version_vector||{},s=t.version_vector||{},a=this.dominatesVector(r,s),u=this.dominatesVector(s,r);return a&&!u?{resolved:e,strategy:"local_wins",conflicts_detected:[],metadata:{local_version:r,remote_version:s}}:u&&!a?{resolved:t,strategy:"remote_wins",conflicts_detected:[],metadata:{local_version:r,remote_version:s}}:this.mergeFields(e,t)}mergeFields(e,t){const r={...e},s=[],a=[],u=e.field_versions||{},d=t.field_versions||{},p=new Set([...Object.keys(u),...Object.keys(d)]);for(const y of p){const v=u[y],_=d[y];if(!_)r[y]=v?.value;else if(!v)r[y]=_.value,a.push(y);else{const T=this.resolveFieldConflict(v,_);r[y]=T.value,T!==v&&a.push(y),v.timestamp===_.timestamp&&s.push(y)}}r.field_versions={};for(const y of p){const v=u[y],_=d[y];v&&_?r.field_versions[y]=this.resolveFieldConflict(v,_):r.field_versions[y]=v||_}return r.version_vector=this.mergeVersionVectors(e.version_vector||{},t.version_vector||{}),{resolved:r,strategy:"merged",conflicts_detected:s,metadata:{local_version:e.version_vector,remote_version:t.version_vector,merged_fields:a}}}resolveFieldConflict(e,t){return e.timestamp>t.timestamp?e:t.timestamp>e.timestamp?t:e.device_id>t.device_id?e:t}dominatesVector(e,t){let r=!1;for(const s in t){const a=e[s]||0,u=t[s];if(a<u)return!1;a>u&&(r=!0)}for(const s in e)!(s in t)&&e[s]>0&&(r=!0);return r}mergeVersionVectors(e,t){const r={...e};for(const s in t)r[s]=Math.max(r[s]||0,t[s]);return r}incrementVersion(e,t){return{...e,[t]:(e[t]||0)+1}}createFieldVersion(e,t,r=Date.now()){return{value:e,timestamp:r,device_id:t}}updateRecord(e,t,r){const s=Date.now(),a={...e};a.field_versions||(a.field_versions={});for(const[u,d]of Object.entries(t))a[u]=d,a.field_versions[u]=this.createFieldVersion(d,r,s);return a.version_vector=this.incrementVersion(a.version_vector||{},r),a.updated_at=s,a}areConcurrent(e,t){const r=e.version_vector||{},s=t.version_vector||{},a=this.dominatesVector(r,s),u=this.dominatesVector(s,r);return!a&&!u}}class gu{constructor(e){this.isSyncing=!1,this.lastSyncTimestamp=0,this.syncAbortController=null,this.db=e,this.syncQueue=new ca(e),this.changeTracker=new la(e),this.conflictResolver=new ha}setDatabase(e){this.db=e,this.syncQueue.setDatabase(e),this.changeTracker.setDatabase(e)}getConnectionStatus(){if(typeof navigator>"u"||!navigator.onLine)return{online:!1,type:"none",effectiveType:"unknown"};const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return{online:navigator.onLine,type:e?.type||"unknown",effectiveType:e?.effectiveType||"unknown"}}isOnline(){return this.getConnectionStatus().online}isCurrentlySyncing(){return this.isSyncing}getLastSyncTimestamp(){return this.lastSyncTimestamp}async getQueueSize(){return await this.syncQueue.getQueueSize()}async getPendingOperations(){return await this.syncQueue.getPendingOperations()}async cancelSync(){this.syncAbortController&&(this.syncAbortController.abort(),this.syncAbortController=null),this.isSyncing=!1}async sync(e={}){if(this.isSyncing&&!e.force)return{success:!1,uploaded:0,downloaded:0,conflicts:0,errors:["SincronizaciÃ³n ya en progreso"],timestamp:Date.now()};if(!this.isOnline())return{success:!1,uploaded:0,downloaded:0,conflicts:0,errors:["Sin conexiÃ³n a internet"],timestamp:Date.now()};this.isSyncing=!0,this.syncAbortController=new AbortController;const t={success:!0,uploaded:0,downloaded:0,conflicts:0,errors:[],timestamp:Date.now()};try{e.onProgress?.({phase:"upload",current:0,total:100,message:"Subiendo cambios locales..."}),t.uploaded=await this.syncUpload(e),e.onProgress?.({phase:"download",current:50,total:100,message:"Descargando cambios remotos..."});const r=await this.syncDownload(e);t.downloaded=r.downloaded,t.conflicts=r.conflicts,e.onProgress?.({phase:"verify",current:90,total:100,message:"Verificando integridad..."}),await this.verifyIntegrity(),e.onProgress?.({phase:"complete",current:100,total:100,message:"SincronizaciÃ³n completada"}),this.lastSyncTimestamp=Date.now(),await this.updateLastSyncTimestamp()}catch(r){t.success=!1,t.errors.push(r instanceof Error?r.message:"Error desconocido")}finally{this.isSyncing=!1,this.syncAbortController=null}return t}async syncUpload(e={}){let t=0;try{const r=await this.changeTracker.getAllPendingChanges();if(r.length===0)return 0;const s=await this.changeTracker.compressChanges(r),a=await this.changeTracker.createUploadBatches(s);for(const u of a){if(this.syncAbortController?.signal.aborted)break;try{if(await this.uploadBatch(u),this.db)for(const d of u.changes)await this.db.change_log.update(d.id,{synced:!0});t+=u.changes.length}catch{try{await this.syncQueue.addToQueue(u.table,"batch-"+Date.now(),"UPDATE",{data:u.changes,priority:u.priority})}catch{}}}}catch(r){return console.error("Error de sincronizaciÃ³n de subida:",r),0}return t}async syncDownload(e={}){let t=0,r=0;try{const s=await this.getLastSyncTimestampFromDB(),a=await this.fetchRemoteChanges(s);if(a.length===0)return{downloaded:0,conflicts:0};for(const u of a){if(this.syncAbortController?.signal.aborted)break;try{const d=await this.getLocalRecord(u.table,u.record_id);if(d&&!d.synced){const p=this.conflictResolver.resolveConflict(d,u.new_value,u.table);await this.applyResolution(u.table,u.record_id,p.resolved),r++}else await this.changeTracker.applyDeltas([u]);t++}catch(d){console.error(`FallÃ³ aplicar delta para ${u.table}:${u.record_id}`,d)}}}catch(s){return console.error("Error de sincronizaciÃ³n de descarga:",s),{downloaded:0,conflicts:0}}return{downloaded:t,conflicts:r}}async verifyIntegrity(){return Promise.resolve()}async updateLastSyncTimestamp(){this.db&&await this.db.app_state.put({key:"last_sync_timestamp",value:this.lastSyncTimestamp.toString(),updated_at:Date.now()})}async getLastSyncTimestampFromDB(){if(!this.db)return 0;const e=await this.db.app_state.get("last_sync_timestamp");return e?parseInt(e.value):0}async uploadBatch(e){return new Promise(t=>setTimeout(t,100))}async fetchRemoteChanges(e){return Promise.resolve([])}async getLocalRecord(e,t){if(!this.db)return null;try{const r=this.db[e];return r?await r.get(t):null}catch{return null}}async applyResolution(e,t,r){if(!this.db)return;const s=this.db[e];s&&await s.put(r)}}class mu{constructor(e){this.CACHE_NAME="pwa-data-backup",this.LOCALSTORAGE_PREFIX="pwa_backup_",this.db=e}setDatabase(e){this.db=e}async writeAtomic(e,t){const r={success:!1,layersWritten:[],errors:[]},{tableName:s,recordId:a,skipBackup:u=!1}=t;try{if(await this.writeToIndexedDB(s,a,e),r.layersWritten.push("indexeddb"),!u){try{await this.writeToLocalStorage(s,a,e),r.layersWritten.push("localstorage")}catch(d){r.errors.push(`LocalStorage: ${d}`),console.warn("â ï¸ Escritura a LocalStorage fallÃ³:",d)}try{await this.writeToCache(s,a,e),r.layersWritten.push("cache")}catch(d){r.errors.push(`Cache API: ${d}`),console.warn("â ï¸ Escritura a Cache API fallÃ³:",d)}}return r.success=!0,console.log(`â Datos escritos a ${r.layersWritten.length} capa(s):`,r.layersWritten),r}catch(d){throw r.errors.push(`IndexedDB: ${d}`),console.error("â Escritura atÃ³mica fallÃ³:",d),await this.rollback(s,a,r.layersWritten),new Error(`Escritura atÃ³mica fallÃ³: ${d}`)}}async readWithFallback(e){const{tableName:t,recordId:r}=e;try{const s=await this.readFromIndexedDB(t,r);if(s!==null)return{success:!0,data:s,source:"indexeddb"}}catch(s){console.warn("â ï¸ Lectura de IndexedDB fallÃ³, intentando LocalStorage:",s)}try{const s=await this.readFromLocalStorage(t,r);if(s!==null)return console.log("ð¦ Datos recuperados de LocalStorage"),this.db&&await this.writeToIndexedDB(t,r,s),{success:!0,data:s,source:"localstorage"}}catch(s){console.warn("â ï¸ Lectura de LocalStorage fallÃ³, intentando Cache API:",s)}try{const s=await this.readFromCache(t,r);if(s!==null)return console.log("ð¾ Datos recuperados de Cache API"),this.db&&await this.writeToIndexedDB(t,r,s),await this.writeToLocalStorage(t,r,s),{success:!0,data:s,source:"cache"}}catch(s){console.error("â Todas las capas de almacenamiento fallaron:",s)}return{success:!1,data:null,source:null,error:"Datos no encontrados en ninguna capa de almacenamiento"}}async writeToIndexedDB(e,t,r){if(!this.db)throw new Error("Base de datos no configurada en StorageManager");const s=this.db[e];if(!s)throw new Error(`Tabla ${e} no encontrada en IndexedDB`);await s.put({...r,id:t})}async readFromIndexedDB(e,t){if(!this.db)throw new Error("Base de datos no configurada en StorageManager");const r=this.db[e];if(!r)throw new Error(`Tabla ${e} no encontrada en IndexedDB`);return await r.get(t)||null}async writeToLocalStorage(e,t,r){const s=this.getLocalStorageKey(e,t),a=JSON.stringify({data:r,timestamp:Date.now(),version:1});if(new Blob([a]).size>5*1024*1024)throw new Error("Datos demasiado grandes para LocalStorage");try{localStorage.setItem(s,a)}catch(d){if(d instanceof DOMException&&d.name==="QuotaExceededError")console.warn("â ï¸ Cuota de LocalStorage excedida, limpiando entradas antiguas"),await this.cleanOldLocalStorageEntries(),localStorage.setItem(s,a);else throw d}}async readFromLocalStorage(e,t){const r=this.getLocalStorageKey(e,t),s=localStorage.getItem(r);if(!s)return null;try{return JSON.parse(s).data}catch(a){return console.error("â FallÃ³ parsear datos de LocalStorage:",a),null}}getLocalStorageKey(e,t){return`${this.LOCALSTORAGE_PREFIX}${e}_${t}`}async cleanOldLocalStorageEntries(){const r=Object.keys(localStorage).filter(a=>a.startsWith(this.LOCALSTORAGE_PREFIX)).map(a=>{try{const u=JSON.parse(localStorage.getItem(a)||"{}");return{key:a,timestamp:u.timestamp||0}}catch{return{key:a,timestamp:0}}}).sort((a,u)=>a.timestamp-u.timestamp),s=Math.ceil(r.length*.25);for(let a=0;a<s;a++)localStorage.removeItem(r[a].key);console.log(`ð§¹ Limpiadas ${s} entradas antiguas de LocalStorage`)}async writeToCache(e,t,r){if(!("caches"in window))throw new Error("Cache API no soportada");const s=await caches.open(this.CACHE_NAME),a=this.getCacheUrl(e,t),u=new Response(JSON.stringify({data:r,timestamp:Date.now(),version:1}),{headers:{"Content-Type":"application/json","X-Backup-Layer":"cache-api"}});await s.put(a,u)}async readFromCache(e,t){if(!("caches"in window))throw new Error("Cache API no soportada");const r=await caches.open(this.CACHE_NAME),s=this.getCacheUrl(e,t),a=await r.match(s);if(!a)return null;try{return(await a.json()).data}catch(u){return console.error("â FallÃ³ parsear datos de Cache API:",u),null}}getCacheUrl(e,t){return`https://pwa-backup/${e}/${t}`}async rollback(e,t,r){console.warn("ð Haciendo rollback de escritura parcial...");for(const s of r)try{switch(s){case"indexeddb":if(this.db){const u=this.db[e];u&&await u.delete(t)}break;case"localstorage":const a=this.getLocalStorageKey(e,t);localStorage.removeItem(a);break;case"cache":if("caches"in window){const u=await caches.open(this.CACHE_NAME),d=this.getCacheUrl(e,t);await u.delete(d)}break}}catch(a){console.error(`â Rollback fallÃ³ para ${s}:`,a)}console.log("â Rollback completado")}async clearBackups(){Object.keys(localStorage).filter(r=>r.startsWith(this.LOCALSTORAGE_PREFIX)).forEach(r=>localStorage.removeItem(r)),"caches"in window&&await caches.delete(this.CACHE_NAME),console.log("ð§¹ Todos los respaldos limpiados")}async getStorageStats(){const e={indexedDB:0,localStorage:0,cacheAPI:0,total:0};try{if(this.db&&this.db.getStats){const t=await this.db.getStats(),r=Object.values(t).reduce((s,a)=>s+(typeof a=="number"?a:0),0);e.indexedDB=r*1024}}catch(t){console.error("FallÃ³ obtener estadÃ­sticas de IndexedDB:",t)}try{const r=Object.keys(localStorage).filter(s=>s.startsWith(this.LOCALSTORAGE_PREFIX));e.localStorage=r.reduce((s,a)=>{const u=localStorage.getItem(a)||"";return s+new Blob([u]).size},0)}catch(t){console.error("FallÃ³ obtener estadÃ­sticas de LocalStorage:",t)}try{if("caches"in window){const r=await(await caches.open(this.CACHE_NAME)).keys();e.cacheAPI=r.length*1024}}catch(t){console.error("FallÃ³ obtener estadÃ­sticas de Cache API:",t)}return e.total=e.indexedDB+e.localStorage+e.cacheAPI,e}}class Mt{constructor(e){this.sequenceCounter=0,this.lastHash="0".repeat(64),this.db=e,this.initializeSequence()}static getInstance(e){return Mt.instance||(Mt.instance=new Mt(e)),Mt.instance}setDatabase(e){this.db=e,this.initializeSequence()}async initializeSequence(){if(this.db)try{const e=await this.db.audit_log.orderBy("sequence").reverse().first();e&&(this.sequenceCounter=e.sequence,this.lastHash=e.hash)}catch(e){console.error("FallÃ³ inicializar secuencia de auditorÃ­a:",e)}}async log(e){const t={tenant_id:e.tenant_id,user_id:e.user_id,device_id:e.device_id||"unknown-device",event_type:e.event_type,aggregate_type:e.aggregate_type,aggregate_id:e.aggregate_id,data:e.data,metadata:e.metadata};return this.logEvent(t)}async logEvent(e){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");this.sequenceCounter++;const t=await this.getCompleteMetadata(e.metadata),r={timestamp:Date.now(),sequence:this.sequenceCounter,tenant_id:e.tenant_id,user_id:e.user_id,device_id:e.device_id,event_type:e.event_type,aggregate_type:e.aggregate_type,aggregate_id:e.aggregate_id,data:e.data,metadata:t,previous_hash:this.lastHash,hash:""};r.hash=await this.calculateHash(r),this.lastHash=r.hash;try{return await this.db.audit_log.add(r),r}catch(s){throw console.error("FallÃ³ registrar evento de auditorÃ­a:",s),s}}async calculateHash(e){const t=JSON.stringify({timestamp:e.timestamp,sequence:e.sequence,tenant_id:e.tenant_id,user_id:e.user_id,device_id:e.device_id,event_type:e.event_type,aggregate_type:e.aggregate_type,aggregate_id:e.aggregate_id,data:e.data,metadata:e.metadata,previous_hash:e.previous_hash}),s=new TextEncoder().encode(t),a=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(a)).map(p=>p.toString(16).padStart(2,"0")).join("")}async getCompleteMetadata(e){const r=(navigator.connection||navigator.mozConnection||navigator.webkitConnection)?.effectiveType||"unknown";let s=null;try{const a=await navigator.getBattery?.();a&&(s=Math.round(a.level*100))}catch{}return{ip_address:e?.ip_address||null,user_agent:typeof navigator<"u"?navigator.userAgent:"unknown",app_version:"1.0.0",latitude:e?.latitude||null,longitude:e?.longitude||null,connection_type:r,battery_level:s}}async verifyHashChain(){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");const e=[];let t="0".repeat(64);const r=await this.db.audit_log.orderBy("sequence").toArray();for(const s of r){s.previous_hash!==t&&e.push(`Evento ${s.sequence}: previous_hash no coincide. Esperado ${t}, obtenido ${s.previous_hash}`);const a=await this.calculateHash(s);a!==s.hash&&e.push(`Evento ${s.sequence}: hash no coincide. Esperado ${s.hash}, calculado ${a}`),t=s.hash}return{valid:e.length===0,errors:e}}async reconstructState(e,t,r){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");const s=await this.db.audit_log.where("aggregate_type").equals(e).toArray(),a=r||Date.now(),u=s.filter(p=>p.aggregate_id===t&&p.timestamp<=a).sort((p,y)=>p.timestamp-y.timestamp);let d=null;for(const p of u)switch(p.event_type){case"CREATE":d={...p.data};break;case"UPDATE":d&&(d={...d,...p.data});break;case"DELETE":d=null;break}return d}async detectFraudPatterns(e,t=36e5){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");const r=[],s=Date.now(),a=s-t,u=await this.db.audit_log.where("[user_id+timestamp]").between([e,a],[e,s]).toArray(),d=u.filter(_=>_.event_type==="CREATE"&&_.aggregate_type==="pago"&&_.timestamp>s-3e5);d.length>10&&r.push({type:"rapid_payments",severity:"high",description:`${d.length} pagos en 5 minutos`,events:d});const p=u.filter(_=>_.event_type==="CREATE"&&_.aggregate_type==="pago"&&_.metadata.latitude&&_.metadata.longitude).sort((_,T)=>_.timestamp-T.timestamp);for(let _=1;_<p.length;_++){const T=p[_-1],P=p[_],I=P.timestamp-T.timestamp,D=this.calculateDistance(T.metadata.latitude,T.metadata.longitude,P.metadata.latitude,P.metadata.longitude);D>100&&I<6e5&&r.push({type:"impossible_location",severity:"high",description:`Se moviÃ³ ${D.toFixed(1)}km en ${(I/6e4).toFixed(1)} minutos`,events:[T,P]})}const y=u.filter(_=>_.event_type==="CREATE"&&_.aggregate_type==="pago");for(let _=0;_<y.length;_++)for(let T=_+1;T<y.length;T++){const P=y[_],I=y[T];P.data&&I.data&&P.data.cliente_id===I.data.cliente_id&&P.data.monto===I.data.monto&&Math.abs(P.timestamp-I.timestamp)<6e4&&r.push({type:"duplicate_payment",severity:"medium",description:`Pago duplicado de ${P.data.monto} para el mismo cliente`,events:[P,I]})}const v=y.filter(_=>_.data&&_.data.monto&&_.data.monto>1e6);return v.length>0&&r.push({type:"suspicious_amount",severity:"medium",description:`${v.length} pago(s) sobre 1M`,events:v}),r}calculateDistance(e,t,r,s){const u=this.toRad(r-e),d=this.toRad(s-t),p=Math.sin(u/2)*Math.sin(u/2)+Math.cos(this.toRad(e))*Math.cos(this.toRad(r))*Math.sin(d/2)*Math.sin(d/2);return 6371*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))}toRad(e){return e*(Math.PI/180)}async getEventsForAggregate(e,t){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");return this.db.audit_log.where("[aggregate_type+aggregate_id+timestamp]").between([e,t,0],[e,t,Date.now()]).toArray()}async getEventsForUser(e,t=100){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");return this.db.audit_log.where("user_id").equals(e).reverse().limit(t).toArray()}async getRecentEvents(e=100){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");return this.db.audit_log.orderBy("timestamp").reverse().limit(e).toArray()}async countEventsByType(){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");const e=await this.db.audit_log.toArray(),t={};for(const r of e)t[r.event_type]=(t[r.event_type]||0)+1;return t}}class Ne{constructor(){this.encryptionKey=null,this.userPin=null}static getInstance(){return Ne.instance||(Ne.instance=new Ne),Ne.instance}async initializeWithPin(e,t={}){if(!e||e.length<4)throw new Error("El PIN debe tener al menos 4 caracteres");this.userPin=e;const r=crypto.getRandomValues(new Uint8Array(16)),s=t.iterations||1e5;this.encryptionKey=await this.deriveKeyFromPin(e,r,s),console.log("ð Servicio de encriptaciÃ³n inicializado")}async deriveKeyFromPin(e,t,r){const s=await crypto.subtle.importKey("raw",new TextEncoder().encode(e),"PBKDF2",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:new Uint8Array(t),iterations:r,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async encrypt(e){if(!this.encryptionKey)throw new Error("Servicio de encriptaciÃ³n no inicializado. Llama initializeWithPin() primero.");if(!e||typeof e!="string")throw new Error("Los datos deben ser un string no vacÃ­o");const t=crypto.getRandomValues(new Uint8Array(12)),r=crypto.getRandomValues(new Uint8Array(16)),s=await this.deriveKeyFromPin(this.userPin,r,1e5),a=new TextEncoder().encode(e),u=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},s,a);return{data:this.arrayBufferToBase64(u),iv:this.arrayBufferToBase64(t.buffer),salt:this.arrayBufferToBase64(r.buffer)}}async decrypt(e){if(!this.userPin)throw new Error("Servicio de encriptaciÃ³n no inicializado. Llama initializeWithPin() primero.");if(!e||!e.data||!e.iv||!e.salt)throw new Error("Formato de datos encriptados invÃ¡lido");try{const t=this.base64ToArrayBuffer(e.data),r=this.base64ToArrayBuffer(e.iv),s=this.base64ToArrayBuffer(e.salt),a=await this.deriveKeyFromPin(this.userPin,new Uint8Array(s),1e5),u=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(r)},a,new Uint8Array(t));return new TextDecoder().decode(u)}catch(t){throw new Error(`DesencriptaciÃ³n fallÃ³: ${t instanceof Error?t.message:"Error desconocido"}`)}}async encryptSensitiveFields(e){if(!e||typeof e!="object")return e;const t={...e};for(const r of Ne.SENSITIVE_FIELDS)if(t[r]&&typeof t[r]=="string")try{t[r]=await this.encrypt(t[r])}catch(s){console.error(`FallÃ³ encriptar campo ${r}:`,s)}return t}async decryptSensitiveFields(e){if(!e||typeof e!="object")return e;const t={...e};for(const r of Ne.SENSITIVE_FIELDS)if(t[r]&&typeof t[r]=="object"&&t[r].data)try{t[r]=await this.decrypt(t[r])}catch(s){console.error(`FallÃ³ desencriptar campo ${r}:`,s)}return t}static isSensitiveField(e){return Ne.SENSITIVE_FIELDS.includes(e)}static isEncrypted(e){return!!(e&&typeof e=="object"&&typeof e.data=="string"&&typeof e.iv=="string"&&typeof e.salt=="string")}clearEncryptionKey(){this.encryptionKey=null,this.userPin=null,console.log("ð§¹ Clave de encriptaciÃ³n limpiada de la memoria")}isInitialized(){return this.encryptionKey!==null&&this.userPin!==null}static getSensitiveFields(){return[...Ne.SENSITIVE_FIELDS]}arrayBufferToBase64(e){const t=new Uint8Array(e);let r="";for(let s=0;s<t.byteLength;s++)r+=String.fromCharCode(t[s]);return btoa(r)}base64ToArrayBuffer(e){const t=atob(e),r=new Uint8Array(t.length);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return r.buffer}}Ne.SENSITIVE_FIELDS=["numero_documento","telefono","telefono_2","telefono_fiador","direccion","barrio","referencia","nombre_fiador"];var He={},Jr={},vs=function(i,e){return vs=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])},vs(i,e)};function da(i,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");vs(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var hn=function(){return hn=Object.assign||function(e){for(var t,r=1,s=arguments.length;r<s;r++){t=arguments[r];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},hn.apply(this,arguments)};function Gt(i,e){var t={};for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&e.indexOf(r)<0&&(t[r]=i[r]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(i);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(i,r[s])&&(t[r[s]]=i[r[s]]);return t}function fa(i,e,t,r){var s=arguments.length,a=s<3?e:r===null?r=Object.getOwnPropertyDescriptor(e,t):r,u;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(i,e,t,r);else for(var d=i.length-1;d>=0;d--)(u=i[d])&&(a=(s<3?u(a):s>3?u(e,t,a):u(e,t))||a);return s>3&&a&&Object.defineProperty(e,t,a),a}function pa(i,e){return function(t,r){e(t,r,i)}}function ya(i,e,t,r,s,a){function u(q){if(q!==void 0&&typeof q!="function")throw new TypeError("Function expected");return q}for(var d=r.kind,p=d==="getter"?"get":d==="setter"?"set":"value",y=!e&&i?r.static?i:i.prototype:null,v=e||(y?Object.getOwnPropertyDescriptor(y,r.name):{}),_,T=!1,P=t.length-1;P>=0;P--){var I={};for(var D in r)I[D]=D==="access"?{}:r[D];for(var D in r.access)I.access[D]=r.access[D];I.addInitializer=function(q){if(T)throw new TypeError("Cannot add initializers after decoration has completed");a.push(u(q||null))};var B=(0,t[P])(d==="accessor"?{get:v.get,set:v.set}:v[p],I);if(d==="accessor"){if(B===void 0)continue;if(B===null||typeof B!="object")throw new TypeError("Object expected");(_=u(B.get))&&(v.get=_),(_=u(B.set))&&(v.set=_),(_=u(B.init))&&s.unshift(_)}else(_=u(B))&&(d==="field"?s.unshift(_):v[p]=_)}y&&Object.defineProperty(y,r.name,v),T=!0}function ga(i,e,t){for(var r=arguments.length>2,s=0;s<e.length;s++)t=r?e[s].call(i,t):e[s].call(i);return r?t:void 0}function ma(i){return typeof i=="symbol"?i:"".concat(i)}function va(i,e,t){return typeof e=="symbol"&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(i,"name",{configurable:!0,value:t?"".concat(t," ",e):e})}function wa(i,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(i,e)}function J(i,e,t,r){function s(a){return a instanceof t?a:new t(function(u){u(a)})}return new(t||(t=Promise))(function(a,u){function d(v){try{y(r.next(v))}catch(_){u(_)}}function p(v){try{y(r.throw(v))}catch(_){u(_)}}function y(v){v.done?a(v.value):s(v.value).then(d,p)}y((r=r.apply(i,e||[])).next())})}function _a(i,e){var t={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},r,s,a,u=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return u.next=d(0),u.throw=d(1),u.return=d(2),typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function d(y){return function(v){return p([y,v])}}function p(y){if(r)throw new TypeError("Generator is already executing.");for(;u&&(u=0,y[0]&&(t=0)),t;)try{if(r=1,s&&(a=y[0]&2?s.return:y[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,y[1])).done)return a;switch(s=0,a&&(y=[y[0]&2,a.value]),y[0]){case 0:case 1:a=y;break;case 4:return t.label++,{value:y[1],done:!1};case 5:t.label++,s=y[1],y=[0];continue;case 7:y=t.ops.pop(),t.trys.pop();continue;default:if(a=t.trys,!(a=a.length>0&&a[a.length-1])&&(y[0]===6||y[0]===2)){t=0;continue}if(y[0]===3&&(!a||y[1]>a[0]&&y[1]<a[3])){t.label=y[1];break}if(y[0]===6&&t.label<a[1]){t.label=a[1],a=y;break}if(a&&t.label<a[2]){t.label=a[2],t.ops.push(y);break}a[2]&&t.ops.pop(),t.trys.pop();continue}y=e.call(i,t)}catch(v){y=[6,v],s=0}finally{r=a=0}if(y[0]&5)throw y[1];return{value:y[0]?y[1]:void 0,done:!0}}}var _n=Object.create?(function(i,e,t,r){r===void 0&&(r=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,r,s)}):(function(i,e,t,r){r===void 0&&(r=t),i[r]=e[t]});function ba(i,e){for(var t in i)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&_n(e,i,t)}function dn(i){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&i[e],r=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&r>=i.length&&(i=void 0),{value:i&&i[r++],done:!i}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ds(i,e){var t=typeof Symbol=="function"&&i[Symbol.iterator];if(!t)return i;var r=t.call(i),s,a=[],u;try{for(;(e===void 0||e-- >0)&&!(s=r.next()).done;)a.push(s.value)}catch(d){u={error:d}}finally{try{s&&!s.done&&(t=r.return)&&t.call(r)}finally{if(u)throw u.error}}return a}function Ea(){for(var i=[],e=0;e<arguments.length;e++)i=i.concat(Ds(arguments[e]));return i}function Sa(){for(var i=0,e=0,t=arguments.length;e<t;e++)i+=arguments[e].length;for(var r=Array(i),s=0,e=0;e<t;e++)for(var a=arguments[e],u=0,d=a.length;u<d;u++,s++)r[s]=a[u];return r}function ka(i,e,t){if(t||arguments.length===2)for(var r=0,s=e.length,a;r<s;r++)(a||!(r in e))&&(a||(a=Array.prototype.slice.call(e,0,r)),a[r]=e[r]);return i.concat(a||Array.prototype.slice.call(e))}function zt(i){return this instanceof zt?(this.v=i,this):new zt(i)}function Oa(i,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(i,e||[]),s,a=[];return s=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),d("next"),d("throw"),d("return",u),s[Symbol.asyncIterator]=function(){return this},s;function u(P){return function(I){return Promise.resolve(I).then(P,_)}}function d(P,I){r[P]&&(s[P]=function(D){return new Promise(function(B,q){a.push([P,D,B,q])>1||p(P,D)})},I&&(s[P]=I(s[P])))}function p(P,I){try{y(r[P](I))}catch(D){T(a[0][3],D)}}function y(P){P.value instanceof zt?Promise.resolve(P.value.v).then(v,_):T(a[0][2],P)}function v(P){p("next",P)}function _(P){p("throw",P)}function T(P,I){P(I),a.shift(),a.length&&p(a[0][0],a[0][1])}}function Ta(i){var e,t;return e={},r("next"),r("throw",function(s){throw s}),r("return"),e[Symbol.iterator]=function(){return this},e;function r(s,a){e[s]=i[s]?function(u){return(t=!t)?{value:zt(i[s](u)),done:!1}:a?a(u):u}:a}}function Aa(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=i[Symbol.asyncIterator],t;return e?e.call(i):(i=typeof dn=="function"?dn(i):i[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(a){t[a]=i[a]&&function(u){return new Promise(function(d,p){u=i[a](u),s(d,p,u.done,u.value)})}}function s(a,u,d,p){Promise.resolve(p).then(function(y){a({value:y,done:d})},u)}}function Pa(i,e){return Object.defineProperty?Object.defineProperty(i,"raw",{value:e}):i.raw=e,i}var vu=Object.create?(function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}):function(i,e){i.default=e},ws=function(i){return ws=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},ws(i)};function Ca(i){if(i&&i.__esModule)return i;var e={};if(i!=null)for(var t=ws(i),r=0;r<t.length;r++)t[r]!=="default"&&_n(e,i,t[r]);return vu(e,i),e}function Ra(i){return i&&i.__esModule?i:{default:i}}function ja(i,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?i!==e||!r:!e.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(i):r?r.value:e.get(i)}function Ia(i,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?i!==e||!s:!e.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(i,t):s?s.value=t:e.set(i,t),t}function xa(i,e){if(e===null||typeof e!="object"&&typeof e!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof i=="function"?e===i:i.has(e)}function $a(i,e,t){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var r,s;if(t){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");r=e[Symbol.asyncDispose]}if(r===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");r=e[Symbol.dispose],t&&(s=r)}if(typeof r!="function")throw new TypeError("Object not disposable.");s&&(r=function(){try{s.call(this)}catch(a){return Promise.reject(a)}}),i.stack.push({value:e,dispose:r,async:t})}else t&&i.stack.push({async:!0});return e}var wu=typeof SuppressedError=="function"?SuppressedError:function(i,e,t){var r=new Error(t);return r.name="SuppressedError",r.error=i,r.suppressed=e,r};function Da(i){function e(a){i.error=i.hasError?new wu(a,i.error,"An error was suppressed during disposal."):a,i.hasError=!0}var t,r=0;function s(){for(;t=i.stack.pop();)try{if(!t.async&&r===1)return r=0,i.stack.push(t),Promise.resolve().then(s);if(t.dispose){var a=t.dispose.call(t.value);if(t.async)return r|=2,Promise.resolve(a).then(s,function(u){return e(u),s()})}else r|=1}catch(u){e(u)}if(r===1)return i.hasError?Promise.reject(i.error):Promise.resolve();if(i.hasError)throw i.error}return s()}function Ba(i,e){return typeof i=="string"&&/^\.\.?\//.test(i)?i.replace(/\.(tsx)$|((?:\.d)?)((?:\.[^./]+?)?)\.([cm]?)ts$/i,function(t,r,s,a,u){return r?e?".jsx":".js":s&&(!a||!u)?t:s+a+"."+u.toLowerCase()+"js"}):i}const _u={__extends:da,__assign:hn,__rest:Gt,__decorate:fa,__param:pa,__esDecorate:ya,__runInitializers:ga,__propKey:ma,__setFunctionName:va,__metadata:wa,__awaiter:J,__generator:_a,__createBinding:_n,__exportStar:ba,__values:dn,__read:Ds,__spread:Ea,__spreadArrays:Sa,__spreadArray:ka,__await:zt,__asyncGenerator:Oa,__asyncDelegator:Ta,__asyncValues:Aa,__makeTemplateObject:Pa,__importStar:Ca,__importDefault:Ra,__classPrivateFieldGet:ja,__classPrivateFieldSet:Ia,__classPrivateFieldIn:xa,__addDisposableResource:$a,__disposeResources:Da,__rewriteRelativeImportExtension:Ba},bu=Object.freeze(Object.defineProperty({__proto__:null,__addDisposableResource:$a,get __assign(){return hn},__asyncDelegator:Ta,__asyncGenerator:Oa,__asyncValues:Aa,__await:zt,__awaiter:J,__classPrivateFieldGet:ja,__classPrivateFieldIn:xa,__classPrivateFieldSet:Ia,__createBinding:_n,__decorate:fa,__disposeResources:Da,__esDecorate:ya,__exportStar:ba,__extends:da,__generator:_a,__importDefault:Ra,__importStar:Ca,__makeTemplateObject:Pa,__metadata:wa,__param:pa,__propKey:ma,__read:Ds,__rest:Gt,__rewriteRelativeImportExtension:Ba,__runInitializers:ga,__setFunctionName:va,__spread:Ea,__spreadArray:ka,__spreadArrays:Sa,__values:dn,default:_u},Symbol.toStringTag,{value:"Module"})),Eu=i=>i?(...e)=>i(...e):(...e)=>fetch(...e);let bn=class extends Error{constructor(e,t="FunctionsError",r){super(e),this.name=t,this.context=r}},Na=class extends bn{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}},_s=class extends bn{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}},bs=class extends bn{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}};var fn;(function(i){i.Any="any",i.ApNortheast1="ap-northeast-1",i.ApNortheast2="ap-northeast-2",i.ApSouth1="ap-south-1",i.ApSoutheast1="ap-southeast-1",i.ApSoutheast2="ap-southeast-2",i.CaCentral1="ca-central-1",i.EuCentral1="eu-central-1",i.EuWest1="eu-west-1",i.EuWest2="eu-west-2",i.EuWest3="eu-west-3",i.SaEast1="sa-east-1",i.UsEast1="us-east-1",i.UsWest1="us-west-1",i.UsWest2="us-west-2"})(fn||(fn={}));class Su{constructor(e,{headers:t={},customFetch:r,region:s=fn.Any}={}){this.url=e,this.headers=t,this.region=s,this.fetch=Eu(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return J(this,arguments,void 0,function*(t,r={}){var s;let a,u;try{const{headers:d,method:p,body:y,signal:v,timeout:_}=r;let T={},{region:P}=r;P||(P=this.region);const I=new URL(`${this.url}/${t}`);P&&P!=="any"&&(T["x-region"]=P,I.searchParams.set("forceFunctionRegion",P));let D;y&&(d&&!Object.prototype.hasOwnProperty.call(d,"Content-Type")||!d)?typeof Blob<"u"&&y instanceof Blob||y instanceof ArrayBuffer?(T["Content-Type"]="application/octet-stream",D=y):typeof y=="string"?(T["Content-Type"]="text/plain",D=y):typeof FormData<"u"&&y instanceof FormData?D=y:(T["Content-Type"]="application/json",D=JSON.stringify(y)):D=y;let B=v;_&&(u=new AbortController,a=setTimeout(()=>u.abort(),_),v?(B=u.signal,v.addEventListener("abort",()=>u.abort())):B=u.signal);const q=yield this.fetch(I.toString(),{method:p||"POST",headers:Object.assign(Object.assign(Object.assign({},T),this.headers),d),body:D,signal:B}).catch(ce=>{throw new Na(ce)}),H=q.headers.get("x-relay-error");if(H&&H==="true")throw new _s(q);if(!q.ok)throw new bs(q);let L=((s=q.headers.get("Content-Type"))!==null&&s!==void 0?s:"text/plain").split(";")[0].trim(),X;return L==="application/json"?X=yield q.json():L==="application/octet-stream"||L==="application/pdf"?X=yield q.blob():L==="text/event-stream"?X=q:L==="multipart/form-data"?X=yield q.formData():X=yield q.text(),{data:X,error:null,response:q}}catch(d){return{data:null,error:d,response:d instanceof bs||d instanceof _s?d.context:void 0}}finally{a&&clearTimeout(a)}})}}const ku=Object.freeze(Object.defineProperty({__proto__:null,get FunctionRegion(){return fn},FunctionsClient:Su,FunctionsError:bn,FunctionsFetchError:Na,FunctionsHttpError:bs,FunctionsRelayError:_s},Symbol.toStringTag,{value:"Module"})),Ua=vr(ku);var Te={};const Jt=vr(bu);var Qr={},Yr={},Xr={},Zr={},en={},tn={},ji;function La(){if(ji)return tn;ji=1,Object.defineProperty(tn,"__esModule",{value:!0});class i extends Error{constructor(t){super(t.message),this.name="PostgrestError",this.details=t.details,this.hint=t.hint,this.code=t.code}}return tn.default=i,tn}var Ii;function qa(){if(Ii)return en;Ii=1,Object.defineProperty(en,"__esModule",{value:!0});const e=Jt.__importDefault(La());let t=class{constructor(s){var a,u;this.shouldThrowOnError=!1,this.method=s.method,this.url=s.url,this.headers=new Headers(s.headers),this.schema=s.schema,this.body=s.body,this.shouldThrowOnError=(a=s.shouldThrowOnError)!==null&&a!==void 0?a:!1,this.signal=s.signal,this.isMaybeSingle=(u=s.isMaybeSingle)!==null&&u!==void 0?u:!1,s.fetch?this.fetch=s.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(s,a){return this.headers=new Headers(this.headers),this.headers.set(s,a),this}then(s,a){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const u=this.fetch;let d=u(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async p=>{var y,v,_,T;let P=null,I=null,D=null,B=p.status,q=p.statusText;if(p.ok){if(this.method!=="HEAD"){const ce=await p.text();ce===""||(this.headers.get("Accept")==="text/csv"||this.headers.get("Accept")&&(!((y=this.headers.get("Accept"))===null||y===void 0)&&y.includes("application/vnd.pgrst.plan+text"))?I=ce:I=JSON.parse(ce))}const L=(v=this.headers.get("Prefer"))===null||v===void 0?void 0:v.match(/count=(exact|planned|estimated)/),X=(_=p.headers.get("content-range"))===null||_===void 0?void 0:_.split("/");L&&X&&X.length>1&&(D=parseInt(X[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(I)&&(I.length>1?(P={code:"PGRST116",details:`Results contain ${I.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},I=null,D=null,B=406,q="Not Acceptable"):I.length===1?I=I[0]:I=null)}else{const L=await p.text();try{P=JSON.parse(L),Array.isArray(P)&&p.status===404&&(I=[],P=null,B=200,q="OK")}catch{p.status===404&&L===""?(B=204,q="No Content"):P={message:L}}if(P&&this.isMaybeSingle&&(!((T=P?.details)===null||T===void 0)&&T.includes("0 rows"))&&(P=null,B=200,q="OK"),P&&this.shouldThrowOnError)throw new e.default(P)}return{error:P,data:I,count:D,status:B,statusText:q}});return this.shouldThrowOnError||(d=d.catch(p=>{var y,v,_,T,P,I;let D="";const B=p?.cause;if(B){const q=(y=B?.message)!==null&&y!==void 0?y:"",H=(v=B?.code)!==null&&v!==void 0?v:"";D=`${(_=p?.name)!==null&&_!==void 0?_:"FetchError"}: ${p?.message}`,D+=`

Caused by: ${(T=B?.name)!==null&&T!==void 0?T:"Error"}: ${q}`,H&&(D+=` (${H})`),B?.stack&&(D+=`
${B.stack}`)}else D=(P=p?.stack)!==null&&P!==void 0?P:"";return{error:{message:`${(I=p?.name)!==null&&I!==void 0?I:"FetchError"}: ${p?.message}`,details:D,hint:"",code:""},data:null,count:null,status:0,statusText:""}})),d.then(s,a)}returns(){return this}overrideTypes(){return this}};return en.default=t,en}var xi;function Fa(){if(xi)return Zr;xi=1,Object.defineProperty(Zr,"__esModule",{value:!0});const e=Jt.__importDefault(qa());let t=class extends e.default{select(s){let a=!1;const u=(s??"*").split("").map(d=>/\s/.test(d)&&!a?"":(d==='"'&&(a=!a),d)).join("");return this.url.searchParams.set("select",u),this.headers.append("Prefer","return=representation"),this}order(s,{ascending:a=!0,nullsFirst:u,foreignTable:d,referencedTable:p=d}={}){const y=p?`${p}.order`:"order",v=this.url.searchParams.get(y);return this.url.searchParams.set(y,`${v?`${v},`:""}${s}.${a?"asc":"desc"}${u===void 0?"":u?".nullsfirst":".nullslast"}`),this}limit(s,{foreignTable:a,referencedTable:u=a}={}){const d=typeof u>"u"?"limit":`${u}.limit`;return this.url.searchParams.set(d,`${s}`),this}range(s,a,{foreignTable:u,referencedTable:d=u}={}){const p=typeof d>"u"?"offset":`${d}.offset`,y=typeof d>"u"?"limit":`${d}.limit`;return this.url.searchParams.set(p,`${s}`),this.url.searchParams.set(y,`${a-s+1}`),this}abortSignal(s){return this.signal=s,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:s=!1,verbose:a=!1,settings:u=!1,buffers:d=!1,wal:p=!1,format:y="text"}={}){var v;const _=[s?"analyze":null,a?"verbose":null,u?"settings":null,d?"buffers":null,p?"wal":null].filter(Boolean).join("|"),T=(v=this.headers.get("Accept"))!==null&&v!==void 0?v:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${y}; for="${T}"; options=${_};`),y==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(s){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${s}`),this}};return Zr.default=t,Zr}var $i;function Bs(){if($i)return Xr;$i=1,Object.defineProperty(Xr,"__esModule",{value:!0});const e=Jt.__importDefault(Fa()),t=new RegExp("[,()]");let r=class extends e.default{eq(a,u){return this.url.searchParams.append(a,`eq.${u}`),this}neq(a,u){return this.url.searchParams.append(a,`neq.${u}`),this}gt(a,u){return this.url.searchParams.append(a,`gt.${u}`),this}gte(a,u){return this.url.searchParams.append(a,`gte.${u}`),this}lt(a,u){return this.url.searchParams.append(a,`lt.${u}`),this}lte(a,u){return this.url.searchParams.append(a,`lte.${u}`),this}like(a,u){return this.url.searchParams.append(a,`like.${u}`),this}likeAllOf(a,u){return this.url.searchParams.append(a,`like(all).{${u.join(",")}}`),this}likeAnyOf(a,u){return this.url.searchParams.append(a,`like(any).{${u.join(",")}}`),this}ilike(a,u){return this.url.searchParams.append(a,`ilike.${u}`),this}ilikeAllOf(a,u){return this.url.searchParams.append(a,`ilike(all).{${u.join(",")}}`),this}ilikeAnyOf(a,u){return this.url.searchParams.append(a,`ilike(any).{${u.join(",")}}`),this}regexMatch(a,u){return this.url.searchParams.append(a,`match.${u}`),this}regexIMatch(a,u){return this.url.searchParams.append(a,`imatch.${u}`),this}is(a,u){return this.url.searchParams.append(a,`is.${u}`),this}isDistinct(a,u){return this.url.searchParams.append(a,`isdistinct.${u}`),this}in(a,u){const d=Array.from(new Set(u)).map(p=>typeof p=="string"&&t.test(p)?`"${p}"`:`${p}`).join(",");return this.url.searchParams.append(a,`in.(${d})`),this}contains(a,u){return typeof u=="string"?this.url.searchParams.append(a,`cs.${u}`):Array.isArray(u)?this.url.searchParams.append(a,`cs.{${u.join(",")}}`):this.url.searchParams.append(a,`cs.${JSON.stringify(u)}`),this}containedBy(a,u){return typeof u=="string"?this.url.searchParams.append(a,`cd.${u}`):Array.isArray(u)?this.url.searchParams.append(a,`cd.{${u.join(",")}}`):this.url.searchParams.append(a,`cd.${JSON.stringify(u)}`),this}rangeGt(a,u){return this.url.searchParams.append(a,`sr.${u}`),this}rangeGte(a,u){return this.url.searchParams.append(a,`nxl.${u}`),this}rangeLt(a,u){return this.url.searchParams.append(a,`sl.${u}`),this}rangeLte(a,u){return this.url.searchParams.append(a,`nxr.${u}`),this}rangeAdjacent(a,u){return this.url.searchParams.append(a,`adj.${u}`),this}overlaps(a,u){return typeof u=="string"?this.url.searchParams.append(a,`ov.${u}`):this.url.searchParams.append(a,`ov.{${u.join(",")}}`),this}textSearch(a,u,{config:d,type:p}={}){let y="";p==="plain"?y="pl":p==="phrase"?y="ph":p==="websearch"&&(y="w");const v=d===void 0?"":`(${d})`;return this.url.searchParams.append(a,`${y}fts${v}.${u}`),this}match(a){return Object.entries(a).forEach(([u,d])=>{this.url.searchParams.append(u,`eq.${d}`)}),this}not(a,u,d){return this.url.searchParams.append(a,`not.${u}.${d}`),this}or(a,{foreignTable:u,referencedTable:d=u}={}){const p=d?`${d}.or`:"or";return this.url.searchParams.append(p,`(${a})`),this}filter(a,u,d){return this.url.searchParams.append(a,`${u}.${d}`),this}};return Xr.default=r,Xr}var Di;function Ka(){if(Di)return Yr;Di=1,Object.defineProperty(Yr,"__esModule",{value:!0});const e=Jt.__importDefault(Bs());let t=class{constructor(s,{headers:a={},schema:u,fetch:d}){this.url=s,this.headers=new Headers(a),this.schema=u,this.fetch=d}select(s,a){const{head:u=!1,count:d}=a??{},p=u?"HEAD":"GET";let y=!1;const v=(s??"*").split("").map(_=>/\s/.test(_)&&!y?"":(_==='"'&&(y=!y),_)).join("");return this.url.searchParams.set("select",v),d&&this.headers.append("Prefer",`count=${d}`),new e.default({method:p,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch})}insert(s,{count:a,defaultToNull:u=!0}={}){var d;const p="POST";if(a&&this.headers.append("Prefer",`count=${a}`),u||this.headers.append("Prefer","missing=default"),Array.isArray(s)){const y=s.reduce((v,_)=>v.concat(Object.keys(_)),[]);if(y.length>0){const v=[...new Set(y)].map(_=>`"${_}"`);this.url.searchParams.set("columns",v.join(","))}}return new e.default({method:p,url:this.url,headers:this.headers,schema:this.schema,body:s,fetch:(d=this.fetch)!==null&&d!==void 0?d:fetch})}upsert(s,{onConflict:a,ignoreDuplicates:u=!1,count:d,defaultToNull:p=!0}={}){var y;const v="POST";if(this.headers.append("Prefer",`resolution=${u?"ignore":"merge"}-duplicates`),a!==void 0&&this.url.searchParams.set("on_conflict",a),d&&this.headers.append("Prefer",`count=${d}`),p||this.headers.append("Prefer","missing=default"),Array.isArray(s)){const _=s.reduce((T,P)=>T.concat(Object.keys(P)),[]);if(_.length>0){const T=[...new Set(_)].map(P=>`"${P}"`);this.url.searchParams.set("columns",T.join(","))}}return new e.default({method:v,url:this.url,headers:this.headers,schema:this.schema,body:s,fetch:(y=this.fetch)!==null&&y!==void 0?y:fetch})}update(s,{count:a}={}){var u;const d="PATCH";return a&&this.headers.append("Prefer",`count=${a}`),new e.default({method:d,url:this.url,headers:this.headers,schema:this.schema,body:s,fetch:(u=this.fetch)!==null&&u!==void 0?u:fetch})}delete({count:s}={}){var a;const u="DELETE";return s&&this.headers.append("Prefer",`count=${s}`),new e.default({method:u,url:this.url,headers:this.headers,schema:this.schema,fetch:(a=this.fetch)!==null&&a!==void 0?a:fetch})}};return Yr.default=t,Yr}var Bi;function Ou(){if(Bi)return Qr;Bi=1,Object.defineProperty(Qr,"__esModule",{value:!0});const i=Jt,e=i.__importDefault(Ka()),t=i.__importDefault(Bs());let r=class Ma{constructor(a,{headers:u={},schema:d,fetch:p}={}){this.url=a,this.headers=new Headers(u),this.schemaName=d,this.fetch=p}from(a){if(!a||typeof a!="string"||a.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");const u=new URL(`${this.url}/${a}`);return new e.default(u,{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(a){return new Ma(this.url,{headers:this.headers,schema:a,fetch:this.fetch})}rpc(a,u={},{head:d=!1,get:p=!1,count:y}={}){var v;let _;const T=new URL(`${this.url}/rpc/${a}`);let P;d||p?(_=d?"HEAD":"GET",Object.entries(u).filter(([D,B])=>B!==void 0).map(([D,B])=>[D,Array.isArray(B)?`{${B.join(",")}}`:`${B}`]).forEach(([D,B])=>{T.searchParams.append(D,B)})):(_="POST",P=u);const I=new Headers(this.headers);return y&&I.set("Prefer",`count=${y}`),new t.default({method:_,url:T,headers:I,schema:this.schemaName,body:P,fetch:(v=this.fetch)!==null&&v!==void 0?v:fetch})}};return Qr.default=r,Qr}var Ni;function Va(){if(Ni)return Te;Ni=1,Object.defineProperty(Te,"__esModule",{value:!0}),Te.PostgrestError=Te.PostgrestBuilder=Te.PostgrestTransformBuilder=Te.PostgrestFilterBuilder=Te.PostgrestQueryBuilder=Te.PostgrestClient=void 0;const i=Jt,e=i.__importDefault(Ou());Te.PostgrestClient=e.default;const t=i.__importDefault(Ka());Te.PostgrestQueryBuilder=t.default;const r=i.__importDefault(Bs());Te.PostgrestFilterBuilder=r.default;const s=i.__importDefault(Fa());Te.PostgrestTransformBuilder=s.default;const a=i.__importDefault(qa());Te.PostgrestBuilder=a.default;const u=i.__importDefault(La());return Te.PostgrestError=u.default,Te.default={PostgrestClient:e.default,PostgrestQueryBuilder:t.default,PostgrestFilterBuilder:r.default,PostgrestTransformBuilder:s.default,PostgrestBuilder:a.default,PostgrestError:u.default},Te}class Wa{constructor(){}static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};if(typeof process<"u"){const t=process.versions;if(t&&t.node){const r=t.node,s=parseInt(r.replace(/^v/,"").split(".")[0]);return s>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${s} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${s} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){const r=this.getWebSocketConstructor();return new r(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const Tu="2.87.1",Au=`realtime-js/${Tu}`,za="1.0.0",Pu="2.0.0",Ui=za,Es=1e4,Cu=1e3,Ru=100;var St;(function(i){i[i.connecting=0]="connecting",i[i.open=1]="open",i[i.closing=2]="closing",i[i.closed=3]="closed"})(St||(St={}));var me;(function(i){i.closed="closed",i.errored="errored",i.joined="joined",i.joining="joining",i.leaving="leaving"})(me||(me={}));var Le;(function(i){i.close="phx_close",i.error="phx_error",i.join="phx_join",i.reply="phx_reply",i.leave="phx_leave",i.access_token="access_token"})(Le||(Le={}));var Ss;(function(i){i.websocket="websocket"})(Ss||(Ss={}));var kt;(function(i){i.Connecting="connecting",i.Open="open",i.Closing="closing",i.Closed="closed"})(kt||(kt={}));class ju{constructor(e){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=e??[]}encode(e,t){if(e.event===this.BROADCAST_EVENT&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return t(this._binaryEncodeUserBroadcastPush(e));let r=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(r))}_binaryEncodeUserBroadcastPush(e){var t;return this._isArrayBuffer((t=e.payload)===null||t===void 0?void 0:t.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var t,r;const s=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:new ArrayBuffer(0);return this._encodeUserBroadcastPush(e,this.BINARY_ENCODING,s)}_encodeJsonUserBroadcastPush(e){var t,r;const s=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:{},u=new TextEncoder().encode(JSON.stringify(s)).buffer;return this._encodeUserBroadcastPush(e,this.JSON_ENCODING,u)}_encodeUserBroadcastPush(e,t,r){var s,a;const u=e.topic,d=(s=e.ref)!==null&&s!==void 0?s:"",p=(a=e.join_ref)!==null&&a!==void 0?a:"",y=e.payload.event,v=this.allowedMetadataKeys?this._pick(e.payload,this.allowedMetadataKeys):{},_=Object.keys(v).length===0?"":JSON.stringify(v);if(p.length>255)throw new Error(`joinRef length ${p.length} exceeds maximum of 255`);if(d.length>255)throw new Error(`ref length ${d.length} exceeds maximum of 255`);if(u.length>255)throw new Error(`topic length ${u.length} exceeds maximum of 255`);if(y.length>255)throw new Error(`userEvent length ${y.length} exceeds maximum of 255`);if(_.length>255)throw new Error(`metadata length ${_.length} exceeds maximum of 255`);const T=this.USER_BROADCAST_PUSH_META_LENGTH+p.length+d.length+u.length+y.length+_.length,P=new ArrayBuffer(this.HEADER_LENGTH+T);let I=new DataView(P),D=0;I.setUint8(D++,this.KINDS.userBroadcastPush),I.setUint8(D++,p.length),I.setUint8(D++,d.length),I.setUint8(D++,u.length),I.setUint8(D++,y.length),I.setUint8(D++,_.length),I.setUint8(D++,t),Array.from(p,q=>I.setUint8(D++,q.charCodeAt(0))),Array.from(d,q=>I.setUint8(D++,q.charCodeAt(0))),Array.from(u,q=>I.setUint8(D++,q.charCodeAt(0))),Array.from(y,q=>I.setUint8(D++,q.charCodeAt(0))),Array.from(_,q=>I.setUint8(D++,q.charCodeAt(0)));var B=new Uint8Array(P.byteLength+r.byteLength);return B.set(new Uint8Array(P),0),B.set(new Uint8Array(r),P.byteLength),B.buffer}decode(e,t){if(this._isArrayBuffer(e)){let r=this._binaryDecode(e);return t(r)}if(typeof e=="string"){const r=JSON.parse(e),[s,a,u,d,p]=r;return t({join_ref:s,ref:a,topic:u,event:d,payload:p})}return t({})}_binaryDecode(e){const t=new DataView(e),r=t.getUint8(0),s=new TextDecoder;switch(r){case this.KINDS.userBroadcast:return this._decodeUserBroadcast(e,t,s)}}_decodeUserBroadcast(e,t,r){const s=t.getUint8(1),a=t.getUint8(2),u=t.getUint8(3),d=t.getUint8(4);let p=this.HEADER_LENGTH+4;const y=r.decode(e.slice(p,p+s));p=p+s;const v=r.decode(e.slice(p,p+a));p=p+a;const _=r.decode(e.slice(p,p+u));p=p+u;const T=e.slice(p,e.byteLength),P=d===this.JSON_ENCODING?JSON.parse(r.decode(T)):T,I={type:this.BROADCAST_EVENT,event:v,payload:P};return u>0&&(I.meta=JSON.parse(_)),{join_ref:null,ref:null,topic:y,event:this.BROADCAST_EVENT,payload:I}}_isArrayBuffer(e){var t;return e instanceof ArrayBuffer||((t=e?.constructor)===null||t===void 0?void 0:t.name)==="ArrayBuffer"}_pick(e,t){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([r])=>t.includes(r)))}}class Ha{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var de;(function(i){i.abstime="abstime",i.bool="bool",i.date="date",i.daterange="daterange",i.float4="float4",i.float8="float8",i.int2="int2",i.int4="int4",i.int4range="int4range",i.int8="int8",i.int8range="int8range",i.json="json",i.jsonb="jsonb",i.money="money",i.numeric="numeric",i.oid="oid",i.reltime="reltime",i.text="text",i.time="time",i.timestamp="timestamp",i.timestamptz="timestamptz",i.timetz="timetz",i.tsrange="tsrange",i.tstzrange="tstzrange"})(de||(de={}));const Li=(i,e,t={})=>{var r;const s=(r=t.skipTypes)!==null&&r!==void 0?r:[];return e?Object.keys(e).reduce((a,u)=>(a[u]=Iu(u,i,e,s),a),{}):{}},Iu=(i,e,t,r)=>{const s=e.find(d=>d.name===i),a=s?.type,u=t[i];return a&&!r.includes(a)?Ga(a,u):ks(u)},Ga=(i,e)=>{if(i.charAt(0)==="_"){const t=i.slice(1,i.length);return Bu(e,t)}switch(i){case de.bool:return xu(e);case de.float4:case de.float8:case de.int2:case de.int4:case de.int8:case de.numeric:case de.oid:return $u(e);case de.json:case de.jsonb:return Du(e);case de.timestamp:return Nu(e);case de.abstime:case de.date:case de.daterange:case de.int4range:case de.int8range:case de.money:case de.reltime:case de.text:case de.time:case de.timestamptz:case de.timetz:case de.tsrange:case de.tstzrange:return ks(e);default:return ks(e)}},ks=i=>i,xu=i=>{switch(i){case"t":return!0;case"f":return!1;default:return i}},$u=i=>{if(typeof i=="string"){const e=parseFloat(i);if(!Number.isNaN(e))return e}return i},Du=i=>{if(typeof i=="string")try{return JSON.parse(i)}catch(e){return console.log(`JSON parse error: ${e}`),i}return i},Bu=(i,e)=>{if(typeof i!="string")return i;const t=i.length-1,r=i[t];if(i[0]==="{"&&r==="}"){let a;const u=i.slice(1,t);try{a=JSON.parse("["+u+"]")}catch{a=u?u.split(","):[]}return a.map(d=>Ga(e,d))}return i},Nu=i=>typeof i=="string"?i.replace(" ","T"):i,Ja=i=>{const e=new URL(i);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class cs{constructor(e,t,r={},s=Es){this.channel=e,this.event=t,this.payload=r,this.timeout=s,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var r;return this._hasReceived(e)&&t((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var Os;(function(i){i.SYNC="sync",i.JOIN="join",i.LEAVE="leave"})(Os||(Os={}));let Qa=class an{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const r=t?.events||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},s=>{const{onJoin:a,onLeave:u,onSync:d}=this.caller;this.joinRef=this.channel._joinRef(),this.state=an.syncState(this.state,s,a,u),this.pendingDiffs.forEach(p=>{this.state=an.syncDiff(this.state,p,a,u)}),this.pendingDiffs=[],d()}),this.channel._on(r.diff,{},s=>{const{onJoin:a,onLeave:u,onSync:d}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(s):(this.state=an.syncDiff(this.state,s,a,u),d())}),this.onJoin((s,a,u)=>{this.channel._trigger("presence",{event:"join",key:s,currentPresences:a,newPresences:u})}),this.onLeave((s,a,u)=>{this.channel._trigger("presence",{event:"leave",key:s,currentPresences:a,leftPresences:u})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,r,s){const a=this.cloneDeep(e),u=this.transformState(t),d={},p={};return this.map(a,(y,v)=>{u[y]||(p[y]=v)}),this.map(u,(y,v)=>{const _=a[y];if(_){const T=v.map(B=>B.presence_ref),P=_.map(B=>B.presence_ref),I=v.filter(B=>P.indexOf(B.presence_ref)<0),D=_.filter(B=>T.indexOf(B.presence_ref)<0);I.length>0&&(d[y]=I),D.length>0&&(p[y]=D)}else d[y]=v}),this.syncDiff(a,{joins:d,leaves:p},r,s)}static syncDiff(e,t,r,s){const{joins:a,leaves:u}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return r||(r=()=>{}),s||(s=()=>{}),this.map(a,(d,p)=>{var y;const v=(y=e[d])!==null&&y!==void 0?y:[];if(e[d]=this.cloneDeep(p),v.length>0){const _=e[d].map(P=>P.presence_ref),T=v.filter(P=>_.indexOf(P.presence_ref)<0);e[d].unshift(...T)}r(d,v,p)}),this.map(u,(d,p)=>{let y=e[d];if(!y)return;const v=p.map(_=>_.presence_ref);y=y.filter(_=>v.indexOf(_.presence_ref)<0),e[d]=y,s(d,y,p),y.length===0&&delete e[d]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(r=>t(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,r)=>{const s=e[r];return"metas"in s?t[r]=s.metas.map(a=>(a.presence_ref=a.phx_ref,delete a.phx_ref,delete a.phx_ref_prev,a)):t[r]=s,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}};var Ts;(function(i){i.ALL="*",i.INSERT="INSERT",i.UPDATE="UPDATE",i.DELETE="DELETE"})(Ts||(Ts={}));var Vt;(function(i){i.BROADCAST="broadcast",i.PRESENCE="presence",i.POSTGRES_CHANGES="postgres_changes",i.SYSTEM="system"})(Vt||(Vt={}));var Me;(function(i){i.SUBSCRIBED="SUBSCRIBED",i.TIMED_OUT="TIMED_OUT",i.CLOSED="CLOSED",i.CHANNEL_ERROR="CHANNEL_ERROR"})(Me||(Me={}));const Uu=me;let Ya=class fr{constructor(e,t={config:{}},r){var s,a;if(this.topic=e,this.params=t,this.socket=r,this.bindings={},this.state=me.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new cs(this,Le.join,this.params,this.timeout),this.rejoinTimer=new Ha(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=me.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(u=>u.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=me.closed,this.socket._remove(this)}),this._onError(u=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,u),this.state=me.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=me.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",u=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,u),this.state=me.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Le.reply,{},(u,d)=>{this._trigger(this._replyEventName(d),u)}),this.presence=new Qa(this),this.broadcastEndpointURL=Ja(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((a=(s=this.params.config)===null||s===void 0?void 0:s.broadcast)===null||a===void 0)&&a.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,t=this.timeout){var r,s,a;if(this.socket.isConnected()||this.socket.connect(),this.state==me.closed){const{config:{broadcast:u,presence:d,private:p}}=this.params,y=(s=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(P=>P.filter))!==null&&s!==void 0?s:[],v=!!this.bindings[Vt.PRESENCE]&&this.bindings[Vt.PRESENCE].length>0||((a=this.params.config.presence)===null||a===void 0?void 0:a.enabled)===!0,_={},T={broadcast:u,presence:Object.assign(Object.assign({},d),{enabled:v}),postgres_changes:y,private:p};this.socket.accessTokenValue&&(_.access_token=this.socket.accessTokenValue),this._onError(P=>e?.(Me.CHANNEL_ERROR,P)),this._onClose(()=>e?.(Me.CLOSED)),this.updateJoinPayload(Object.assign({config:T},_)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:P})=>{var I;if(this.socket._isManualToken()||this.socket.setAuth(),P===void 0){e?.(Me.SUBSCRIBED);return}else{const D=this.bindings.postgres_changes,B=(I=D?.length)!==null&&I!==void 0?I:0,q=[];for(let H=0;H<B;H++){const L=D[H],{filter:{event:X,schema:ce,table:se,filter:ae}}=L,$e=P&&P[H];if($e&&$e.event===X&&fr.isFilterValueEqual($e.schema,ce)&&fr.isFilterValueEqual($e.table,se)&&fr.isFilterValueEqual($e.filter,ae))q.push(Object.assign(Object.assign({},L),{id:$e.id}));else{this.unsubscribe(),this.state=me.errored,e?.(Me.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=q,e&&e(Me.SUBSCRIBED);return}}).receive("error",P=>{this.state=me.errored,e?.(Me.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(P).join(", ")||"error")))}).receive("timeout",()=>{e?.(Me.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,r){return this.state===me.joined&&e===Vt.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(e,t,r)}async httpSend(e,t,r={}){var s;const a=this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"";if(t==null)return Promise.reject("Payload is required for httpSend()");const u={method:"POST",headers:{Authorization:a,apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:t,private:this.private}]})},d=await this._fetchWithTimeout(this.broadcastEndpointURL,u,(s=r.timeout)!==null&&s!==void 0?s:this.timeout);if(d.status===202)return{success:!0};let p=d.statusText;try{const y=await d.json();p=y.error||y.message||p}catch{}return Promise.reject(new Error(p))}async send(e,t={}){var r,s;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:a,payload:u}=e,p={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:a,payload:u,private:this.private}]})};try{const y=await this._fetchWithTimeout(this.broadcastEndpointURL,p,(r=t.timeout)!==null&&r!==void 0?r:this.timeout);return await((s=y.body)===null||s===void 0?void 0:s.cancel()),y.ok?"ok":"error"}catch(y){return y.name==="AbortError"?"timed out":"error"}}else return new Promise(a=>{var u,d,p;const y=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((p=(d=(u=this.params)===null||u===void 0?void 0:u.config)===null||d===void 0?void 0:d.broadcast)===null||p===void 0)&&p.ack)&&a("ok"),y.receive("ok",()=>a("ok")),y.receive("error",()=>a("error")),y.receive("timeout",()=>a("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=me.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Le.close,"leave",this._joinRef())};this.joinPush.destroy();let r=null;return new Promise(s=>{r=new cs(this,Le.leave,{},e),r.receive("ok",()=>{t(),s("ok")}).receive("timeout",()=>{t(),s("timed out")}).receive("error",()=>{s("error")}),r.send(),this._canPush()||r.trigger("ok",{})}).finally(()=>{r?.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=me.closed,this.bindings={}}async _fetchWithTimeout(e,t,r){const s=new AbortController,a=setTimeout(()=>s.abort(),r),u=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:s.signal}));return clearTimeout(a),u}_push(e,t,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let s=new cs(this,e,t,r);return this._canPush()?s.send():this._addToPushBuffer(s),s}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>Ru){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,r){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,r){var s,a;const u=e.toLocaleLowerCase(),{close:d,error:p,leave:y,join:v}=Le;if(r&&[d,p,y,v].indexOf(u)>=0&&r!==this._joinRef())return;let T=this._onMessage(u,t,r);if(t&&!T)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(u)?(s=this.bindings.postgres_changes)===null||s===void 0||s.filter(P=>{var I,D,B;return((I=P.filter)===null||I===void 0?void 0:I.event)==="*"||((B=(D=P.filter)===null||D===void 0?void 0:D.event)===null||B===void 0?void 0:B.toLocaleLowerCase())===u}).map(P=>P.callback(T,r)):(a=this.bindings[u])===null||a===void 0||a.filter(P=>{var I,D,B,q,H,L;if(["broadcast","presence","postgres_changes"].includes(u))if("id"in P){const X=P.id,ce=(I=P.filter)===null||I===void 0?void 0:I.event;return X&&((D=t.ids)===null||D===void 0?void 0:D.includes(X))&&(ce==="*"||ce?.toLocaleLowerCase()===((B=t.data)===null||B===void 0?void 0:B.type.toLocaleLowerCase()))}else{const X=(H=(q=P?.filter)===null||q===void 0?void 0:q.event)===null||H===void 0?void 0:H.toLocaleLowerCase();return X==="*"||X===((L=t?.event)===null||L===void 0?void 0:L.toLocaleLowerCase())}else return P.type.toLocaleLowerCase()===u}).map(P=>{if(typeof T=="object"&&"ids"in T){const I=T.data,{schema:D,table:B,commit_timestamp:q,type:H,errors:L}=I;T=Object.assign(Object.assign({},{schema:D,table:B,commit_timestamp:q,eventType:H,new:{},old:{},errors:L}),this._getPayloadRecords(I))}P.callback(T,r)})}_isClosed(){return this.state===me.closed}_isJoined(){return this.state===me.joined}_isJoining(){return this.state===me.joining}_isLeaving(){return this.state===me.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,r){const s=e.toLocaleLowerCase(),a={type:s,filter:t,callback:r};return this.bindings[s]?this.bindings[s].push(a):this.bindings[s]=[a],this}_off(e,t){const r=e.toLocaleLowerCase();return this.bindings[r]&&(this.bindings[r]=this.bindings[r].filter(s=>{var a;return!(((a=s.type)===null||a===void 0?void 0:a.toLocaleLowerCase())===r&&fr.isEqual(s.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(e[r]!==t[r])return!1;return!0}static isFilterValueEqual(e,t){return(e??void 0)===(t??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(Le.close,{},e)}_onError(e){this._on(Le.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=me.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=Li(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=Li(e.columns,e.old_record)),t}};const ls=()=>{},rn={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},Lu=[1e3,2e3,5e3,1e4],qu=1e4,Fu=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;let Ku=class{constructor(e,t){var r;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=Es,this.transport=null,this.heartbeatIntervalMs=rn.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=ls,this.ref=0,this.reconnectTimer=null,this.vsn=Ui,this.logger=ls,this.conn=null,this.sendBuffer=[],this.serializer=new ju,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._resolveFetch=s=>s?(...a)=>s(...a):(...a)=>fetch(...a),!(!((r=t?.params)===null||r===void 0)&&r.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${Ss.websocket}`,this.httpEndpoint=Ja(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t?.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=Wa.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const r=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(r),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,t??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,r){this.logger(e,t,r)}connectionState(){switch(this.conn&&this.conn.readyState){case St.connecting:return kt.Connecting;case St.open:return kt.Open;case St.closing:return kt.Closing;default:return kt.Closed}}isConnected(){return this.connectionState()===kt.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){const r=`realtime:${e}`,s=this.getChannels().find(a=>a.topic===r);if(s)return s;{const a=new Ya(`realtime:${e}`,t,this);return this.channels.push(a),a}}push(e){const{topic:t,event:r,payload:s,ref:a}=e,u=()=>{this.encode(e,d=>{var p;(p=this.conn)===null||p===void 0||p.send(d)})};this.log("push",`${t} ${r} (${a})`,s),this.isConnected()?u():this.sendBuffer.push(u)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(Cu,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},rn.HEARTBEAT_TIMEOUT_FALLBACK);return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{if(t.topic==="phoenix"&&t.event==="phx_reply")try{this.heartbeatCallback(t.payload.status==="ok"?"ok":"error")}catch(y){this.log("error","error in heartbeat callback",y)}t.ref&&t.ref===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null);const{topic:r,event:s,payload:a,ref:u}=t,d=u?`(${u})`:"",p=a.status||"";this.log("receive",`${p} ${r} ${s} ${d}`.trim(),a),this.channels.filter(y=>y._isMember(r)).forEach(y=>y._trigger(s,a,u)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_teardownConnection(){if(this.conn){if(this.conn.readyState===St.open||this.conn.readyState===St.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(t=>{this.log("error","error waiting for auth on connect",t),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(Le.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const r=e.match(/\?/)?"&":"?",s=new URLSearchParams(t);return`${e}${r}${s}`}_workerObjectUrl(e){let t;if(e)t=e;else{const r=new Blob([Fu],{type:"application/javascript"});t=URL.createObjectURL(r)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t,r=!1;if(e)t=e,r=!0;else if(this.accessToken)try{t=await this.accessToken()}catch(s){this.log("error","Error fetching access token from callback",s),t=this.accessTokenValue}else t=this.accessTokenValue;r?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(s=>{const a={access_token:t,version:Au};t&&s.updateJoinPayload(a),s.joinedOnce&&s._isJoined()&&s._push(Le.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this._isManualToken()||this.setAuth().catch(t=>{this.log("error",`Error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(r=>{try{r(t)}catch(s){this.log("error",`error in ${e} callback`,s)}})}catch(r){this.log("error",`error triggering ${e} callbacks`,r)}}_setupReconnectionTimer(){this.reconnectTimer=new Ha(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},rn.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,r,s,a,u,d,p,y,v,_,T,P;switch(this.transport=(t=e?.transport)!==null&&t!==void 0?t:null,this.timeout=(r=e?.timeout)!==null&&r!==void 0?r:Es,this.heartbeatIntervalMs=(s=e?.heartbeatIntervalMs)!==null&&s!==void 0?s:rn.HEARTBEAT_INTERVAL,this.worker=(a=e?.worker)!==null&&a!==void 0?a:!1,this.accessToken=(u=e?.accessToken)!==null&&u!==void 0?u:null,this.heartbeatCallback=(d=e?.heartbeatCallback)!==null&&d!==void 0?d:ls,this.vsn=(p=e?.vsn)!==null&&p!==void 0?p:Ui,e?.params&&(this.params=e.params),e?.logger&&(this.logger=e.logger),(e?.logLevel||e?.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(y=e?.reconnectAfterMs)!==null&&y!==void 0?y:(I=>Lu[I-1]||qu),this.vsn){case za:this.encode=(v=e?.encode)!==null&&v!==void 0?v:((I,D)=>D(JSON.stringify(I))),this.decode=(_=e?.decode)!==null&&_!==void 0?_:((I,D)=>D(JSON.parse(I)));break;case Pu:this.encode=(T=e?.encode)!==null&&T!==void 0?T:this.serializer.encode.bind(this.serializer),this.decode=(P=e?.decode)!==null&&P!==void 0?P:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e?.workerUrl}}};const Mu=Object.freeze(Object.defineProperty({__proto__:null,REALTIME_CHANNEL_STATES:Uu,get REALTIME_LISTEN_TYPES(){return Vt},get REALTIME_POSTGRES_CHANGES_LISTEN_EVENT(){return Ts},get REALTIME_PRESENCE_LISTEN_EVENTS(){return Os},get REALTIME_SUBSCRIBE_STATES(){return Me},RealtimeChannel:Ya,RealtimeClient:Ku,RealtimePresence:Qa,WebSocketFactory:Wa},Symbol.toStringTag,{value:"Module"})),Xa=vr(Mu);class wr extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function pe(i){return typeof i=="object"&&i!==null&&"__isStorageError"in i}class Za extends wr{constructor(e,t,r){super(e),this.name="StorageApiError",this.status=t,this.statusCode=r}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class pn extends wr{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}const Ns=i=>i?(...e)=>i(...e):(...e)=>fetch(...e),Vu=()=>Response,As=i=>{if(Array.isArray(i))return i.map(t=>As(t));if(typeof i=="function"||i!==Object(i))return i;const e={};return Object.entries(i).forEach(([t,r])=>{const s=t.replace(/([-_][a-z])/gi,a=>a.toUpperCase().replace(/[-_]/g,""));e[s]=As(r)}),e},Wu=i=>{if(typeof i!="object"||i===null)return!1;const e=Object.getPrototypeOf(i);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in i)&&!(Symbol.iterator in i)},zu=i=>!i||typeof i!="string"||i.length===0||i.length>100||i.trim()!==i||i.includes("/")||i.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(i),hs=i=>{var e;return i.msg||i.message||i.error_description||(typeof i.error=="string"?i.error:(e=i.error)===null||e===void 0?void 0:e.message)||JSON.stringify(i)},Hu=(i,e,t)=>J(void 0,void 0,void 0,function*(){const r=yield Vu();i instanceof r&&!t?.noResolveJson?i.json().then(s=>{const a=i.status||500,u=s?.statusCode||a+"";e(new Za(hs(s),a,u))}).catch(s=>{e(new pn(hs(s),s))}):e(new pn(hs(i),i))}),Gu=(i,e,t,r)=>{const s={method:i,headers:e?.headers||{}};return i==="GET"||!r?s:(Wu(r)?(s.headers=Object.assign({"Content-Type":"application/json"},e?.headers),s.body=JSON.stringify(r)):s.body=r,e?.duplex&&(s.duplex=e.duplex),Object.assign(Object.assign({},s),t))};function _r(i,e,t,r,s,a){return J(this,void 0,void 0,function*(){return new Promise((u,d)=>{i(t,Gu(e,r,s,a)).then(p=>{if(!p.ok)throw p;return r?.noResolveJson?p:p.json()}).then(p=>u(p)).catch(p=>Hu(p,d,r))})})}function gr(i,e,t,r){return J(this,void 0,void 0,function*(){return _r(i,"GET",e,t,r)})}function Ue(i,e,t,r,s){return J(this,void 0,void 0,function*(){return _r(i,"POST",e,r,s,t)})}function Ps(i,e,t,r,s){return J(this,void 0,void 0,function*(){return _r(i,"PUT",e,r,s,t)})}function Ju(i,e,t,r){return J(this,void 0,void 0,function*(){return _r(i,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),r)})}function Us(i,e,t,r,s){return J(this,void 0,void 0,function*(){return _r(i,"DELETE",e,r,s,t)})}class Qu{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t}then(e,t){return this.execute().then(e,t)}execute(){return J(this,void 0,void 0,function*(){try{return{data:(yield this.downloadFn()).body,error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(pe(e))return{data:null,error:e};throw e}})}}var eo;class Yu{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t,this[eo]="BlobDownloadBuilder",this.promise=null}asStream(){return new Qu(this.downloadFn,this.shouldThrowOnError)}then(e,t){return this.getPromise().then(e,t)}catch(e){return this.getPromise().catch(e)}finally(e){return this.getPromise().finally(e)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}execute(){return J(this,void 0,void 0,function*(){try{return{data:yield(yield this.downloadFn()).blob(),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(pe(e))return{data:null,error:e};throw e}})}}eo=Symbol.toStringTag;const Xu={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},qi={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class Zu{constructor(e,t={},r,s){this.shouldThrowOnError=!1,this.url=e,this.headers=t,this.bucketId=r,this.fetch=Ns(s)}throwOnError(){return this.shouldThrowOnError=!0,this}uploadOrUpdate(e,t,r,s){return J(this,void 0,void 0,function*(){try{let a;const u=Object.assign(Object.assign({},qi),s);let d=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(u.upsert)});const p=u.metadata;typeof Blob<"u"&&r instanceof Blob?(a=new FormData,a.append("cacheControl",u.cacheControl),p&&a.append("metadata",this.encodeMetadata(p)),a.append("",r)):typeof FormData<"u"&&r instanceof FormData?(a=r,a.has("cacheControl")||a.append("cacheControl",u.cacheControl),p&&!a.has("metadata")&&a.append("metadata",this.encodeMetadata(p))):(a=r,d["cache-control"]=`max-age=${u.cacheControl}`,d["content-type"]=u.contentType,p&&(d["x-metadata"]=this.toBase64(this.encodeMetadata(p))),(typeof ReadableStream<"u"&&a instanceof ReadableStream||a&&typeof a=="object"&&"pipe"in a&&typeof a.pipe=="function")&&!u.duplex&&(u.duplex="half")),s?.headers&&(d=Object.assign(Object.assign({},d),s.headers));const y=this._removeEmptyFolders(t),v=this._getFinalPath(y),_=yield(e=="PUT"?Ps:Ue)(this.fetch,`${this.url}/object/${v}`,a,Object.assign({headers:d},u?.duplex?{duplex:u.duplex}:{}));return{data:{path:y,id:_.Id,fullPath:_.Key},error:null}}catch(a){if(this.shouldThrowOnError)throw a;if(pe(a))return{data:null,error:a};throw a}})}upload(e,t,r){return J(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,r)})}uploadToSignedUrl(e,t,r,s){return J(this,void 0,void 0,function*(){const a=this._removeEmptyFolders(e),u=this._getFinalPath(a),d=new URL(this.url+`/object/upload/sign/${u}`);d.searchParams.set("token",t);try{let p;const y=Object.assign({upsert:qi.upsert},s),v=Object.assign(Object.assign({},this.headers),{"x-upsert":String(y.upsert)});typeof Blob<"u"&&r instanceof Blob?(p=new FormData,p.append("cacheControl",y.cacheControl),p.append("",r)):typeof FormData<"u"&&r instanceof FormData?(p=r,p.append("cacheControl",y.cacheControl)):(p=r,v["cache-control"]=`max-age=${y.cacheControl}`,v["content-type"]=y.contentType);const _=yield Ps(this.fetch,d.toString(),p,{headers:v});return{data:{path:a,fullPath:_.Key},error:null}}catch(p){if(this.shouldThrowOnError)throw p;if(pe(p))return{data:null,error:p};throw p}})}createSignedUploadUrl(e,t){return J(this,void 0,void 0,function*(){try{let r=this._getFinalPath(e);const s=Object.assign({},this.headers);t?.upsert&&(s["x-upsert"]="true");const a=yield Ue(this.fetch,`${this.url}/object/upload/sign/${r}`,{},{headers:s}),u=new URL(this.url+a.url),d=u.searchParams.get("token");if(!d)throw new wr("No token returned by API");return{data:{signedUrl:u.toString(),path:e,token:d},error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(pe(r))return{data:null,error:r};throw r}})}update(e,t,r){return J(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,r)})}move(e,t,r){return J(this,void 0,void 0,function*(){try{return{data:yield Ue(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r?.destinationBucket},{headers:this.headers}),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(pe(s))return{data:null,error:s};throw s}})}copy(e,t,r){return J(this,void 0,void 0,function*(){try{return{data:{path:(yield Ue(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r?.destinationBucket},{headers:this.headers})).Key},error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(pe(s))return{data:null,error:s};throw s}})}createSignedUrl(e,t,r){return J(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e),a=yield Ue(this.fetch,`${this.url}/object/sign/${s}`,Object.assign({expiresIn:t},r?.transform?{transform:r.transform}:{}),{headers:this.headers});const u=r?.download?`&download=${r.download===!0?"":r.download}`:"";return a={signedUrl:encodeURI(`${this.url}${a.signedURL}${u}`)},{data:a,error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(pe(s))return{data:null,error:s};throw s}})}createSignedUrls(e,t,r){return J(this,void 0,void 0,function*(){try{const s=yield Ue(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),a=r?.download?`&download=${r.download===!0?"":r.download}`:"";return{data:s.map(u=>Object.assign(Object.assign({},u),{signedUrl:u.signedURL?encodeURI(`${this.url}${u.signedURL}${a}`):null})),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(pe(s))return{data:null,error:s};throw s}})}download(e,t){const s=typeof t?.transform<"u"?"render/image/authenticated":"object",a=this.transformOptsToQueryString(t?.transform||{}),u=a?`?${a}`:"",d=this._getFinalPath(e),p=()=>gr(this.fetch,`${this.url}/${s}/${d}${u}`,{headers:this.headers,noResolveJson:!0});return new Yu(p,this.shouldThrowOnError)}info(e){return J(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const r=yield gr(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:As(r),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(pe(r))return{data:null,error:r};throw r}})}exists(e){return J(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield Ju(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(pe(r)&&r instanceof pn){const s=r.originalError;if([400,404].includes(s?.status))return{data:!1,error:r}}throw r}})}getPublicUrl(e,t){const r=this._getFinalPath(e),s=[],a=t?.download?`download=${t.download===!0?"":t.download}`:"";a!==""&&s.push(a);const d=typeof t?.transform<"u"?"render/image":"object",p=this.transformOptsToQueryString(t?.transform||{});p!==""&&s.push(p);let y=s.join("&");return y!==""&&(y=`?${y}`),{data:{publicUrl:encodeURI(`${this.url}/${d}/public/${r}${y}`)}}}remove(e){return J(this,void 0,void 0,function*(){try{return{data:yield Us(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(pe(t))return{data:null,error:t};throw t}})}list(e,t,r){return J(this,void 0,void 0,function*(){try{const s=Object.assign(Object.assign(Object.assign({},Xu),t),{prefix:e||""});return{data:yield Ue(this.fetch,`${this.url}/object/list/${this.bucketId}`,s,{headers:this.headers},r),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(pe(s))return{data:null,error:s};throw s}})}listV2(e,t){return J(this,void 0,void 0,function*(){try{const r=Object.assign({},e);return{data:yield Ue(this.fetch,`${this.url}/object/list-v2/${this.bucketId}`,r,{headers:this.headers},t),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(pe(r))return{data:null,error:r};throw r}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e.replace(/^\/+/,"")}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const to="2.87.1",ro={"X-Client-Info":`storage-js/${to}`};class ec{constructor(e,t={},r,s){this.shouldThrowOnError=!1;const a=new URL(e);s?.useNewHostname&&/supabase\.(co|in|red)$/.test(a.hostname)&&!a.hostname.includes("storage.supabase.")&&(a.hostname=a.hostname.replace("supabase.","storage.supabase.")),this.url=a.href.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},ro),t),this.fetch=Ns(r)}throwOnError(){return this.shouldThrowOnError=!0,this}listBuckets(e){return J(this,void 0,void 0,function*(){try{const t=this.listBucketOptionsToQueryString(e);return{data:yield gr(this.fetch,`${this.url}/bucket${t}`,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(pe(t))return{data:null,error:t};throw t}})}getBucket(e){return J(this,void 0,void 0,function*(){try{return{data:yield gr(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(pe(t))return{data:null,error:t};throw t}})}createBucket(e){return J(this,arguments,void 0,function*(t,r={public:!1}){try{return{data:yield Ue(this.fetch,`${this.url}/bucket`,{id:t,name:t,type:r.type,public:r.public,file_size_limit:r.fileSizeLimit,allowed_mime_types:r.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(pe(s))return{data:null,error:s};throw s}})}updateBucket(e,t){return J(this,void 0,void 0,function*(){try{return{data:yield Ps(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(pe(r))return{data:null,error:r};throw r}})}emptyBucket(e){return J(this,void 0,void 0,function*(){try{return{data:yield Ue(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(pe(t))return{data:null,error:t};throw t}})}deleteBucket(e){return J(this,void 0,void 0,function*(){try{return{data:yield Us(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(pe(t))return{data:null,error:t};throw t}})}listBucketOptionsToQueryString(e){const t={};return e&&("limit"in e&&(t.limit=String(e.limit)),"offset"in e&&(t.offset=String(e.offset)),e.search&&(t.search=e.search),e.sortColumn&&(t.sortColumn=e.sortColumn),e.sortOrder&&(t.sortOrder=e.sortOrder)),Object.keys(t).length>0?"?"+new URLSearchParams(t).toString():""}}var mr=class extends Error{constructor(i,e){super(i),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown=e.icebergType==="CommitStateUnknownException"||[500,502,504].includes(e.status)&&e.icebergType?.includes("CommitState")===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function tc(i,e,t){const r=new URL(e,i);if(t)for(const[s,a]of Object.entries(t))a!==void 0&&r.searchParams.set(s,a);return r.toString()}async function rc(i){return!i||i.type==="none"?{}:i.type==="bearer"?{Authorization:`Bearer ${i.token}`}:i.type==="header"?{[i.name]:i.value}:i.type==="custom"?await i.getHeaders():{}}function nc(i){const e=i.fetchImpl??globalThis.fetch;return{async request({method:t,path:r,query:s,body:a,headers:u}){const d=tc(i.baseUrl,r,s),p=await rc(i.auth),y=await e(d,{method:t,headers:{...a?{"Content-Type":"application/json"}:{},...p,...u},body:a?JSON.stringify(a):void 0}),v=await y.text(),_=(y.headers.get("content-type")||"").includes("application/json"),T=_&&v?JSON.parse(v):v;if(!y.ok){const P=_?T:void 0,I=P?.error;throw new mr(I?.message??`Request failed with status ${y.status}`,{status:y.status,icebergType:I?.type,icebergCode:I?.code,details:P})}return{status:y.status,headers:y.headers,data:T}}}}function nn(i){return i.join("")}var sc=class{constructor(i,e=""){this.client=i,this.prefix=e}async listNamespaces(i){const e=i?{parent:nn(i.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(r=>({namespace:r}))}async createNamespace(i,e){const t={namespace:i.namespace,properties:e?.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:t})).data}async dropNamespace(i){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${nn(i.namespace)}`})}async loadNamespaceMetadata(i){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${nn(i.namespace)}`})).data.properties}}async namespaceExists(i){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${nn(i.namespace)}`}),!0}catch(e){if(e instanceof mr&&e.status===404)return!1;throw e}}async createNamespaceIfNotExists(i,e){try{return await this.createNamespace(i,e)}catch(t){if(t instanceof mr&&t.status===409)return;throw t}}};function Nt(i){return i.join("")}var ic=class{constructor(i,e="",t){this.client=i,this.prefix=e,this.accessDelegation=t}async listTables(i){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Nt(i.namespace)}/tables`})).data.identifiers}async createTable(i,e){const t={};return this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${Nt(i.namespace)}/tables`,body:e,headers:t})).data.metadata}async updateTable(i,e){const t=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${Nt(i.namespace)}/tables/${i.name}`,body:e});return{"metadata-location":t.data["metadata-location"],metadata:t.data.metadata}}async dropTable(i,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${Nt(i.namespace)}/tables/${i.name}`,query:{purgeRequested:String(e?.purge??!1)}})}async loadTable(i){const e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Nt(i.namespace)}/tables/${i.name}`,headers:e})).data.metadata}async tableExists(i){const e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${Nt(i.namespace)}/tables/${i.name}`,headers:e}),!0}catch(t){if(t instanceof mr&&t.status===404)return!1;throw t}}async createTableIfNotExists(i,e){try{return await this.createTable(i,e)}catch(t){if(t instanceof mr&&t.status===409)return await this.loadTable({namespace:i.namespace,name:e.name});throw t}}},ac=class{constructor(i){let e="v1";i.catalogName&&(e+=`/${i.catalogName}`);const t=i.baseUrl.endsWith("/")?i.baseUrl:`${i.baseUrl}/`;this.client=nc({baseUrl:t,auth:i.auth,fetchImpl:i.fetch}),this.accessDelegation=i.accessDelegation?.join(","),this.namespaceOps=new sc(this.client,e),this.tableOps=new ic(this.client,e,this.accessDelegation)}async listNamespaces(i){return this.namespaceOps.listNamespaces(i)}async createNamespace(i,e){return this.namespaceOps.createNamespace(i,e)}async dropNamespace(i){await this.namespaceOps.dropNamespace(i)}async loadNamespaceMetadata(i){return this.namespaceOps.loadNamespaceMetadata(i)}async listTables(i){return this.tableOps.listTables(i)}async createTable(i,e){return this.tableOps.createTable(i,e)}async updateTable(i,e){return this.tableOps.updateTable(i,e)}async dropTable(i,e){await this.tableOps.dropTable(i,e)}async loadTable(i){return this.tableOps.loadTable(i)}async namespaceExists(i){return this.namespaceOps.namespaceExists(i)}async tableExists(i){return this.tableOps.tableExists(i)}async createNamespaceIfNotExists(i,e){return this.namespaceOps.createNamespaceIfNotExists(i,e)}async createTableIfNotExists(i,e){return this.tableOps.createTableIfNotExists(i,e)}};class no{constructor(e,t={},r){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},ro),t),this.fetch=Ns(r)}throwOnError(){return this.shouldThrowOnError=!0,this}createBucket(e){return J(this,void 0,void 0,function*(){try{return{data:yield Ue(this.fetch,`${this.url}/bucket`,{name:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(pe(t))return{data:null,error:t};throw t}})}listBuckets(e){return J(this,void 0,void 0,function*(){try{const t=new URLSearchParams;e?.limit!==void 0&&t.set("limit",e.limit.toString()),e?.offset!==void 0&&t.set("offset",e.offset.toString()),e?.sortColumn&&t.set("sortColumn",e.sortColumn),e?.sortOrder&&t.set("sortOrder",e.sortOrder),e?.search&&t.set("search",e.search);const r=t.toString(),s=r?`${this.url}/bucket?${r}`:`${this.url}/bucket`;return{data:yield gr(this.fetch,s,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(pe(t))return{data:null,error:t};throw t}})}deleteBucket(e){return J(this,void 0,void 0,function*(){try{return{data:yield Us(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(pe(t))return{data:null,error:t};throw t}})}from(e){if(!zu(e))throw new wr("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const t=new ac({baseUrl:this.url,catalogName:e,auth:{type:"custom",getHeaders:()=>J(this,void 0,void 0,function*(){return this.headers})},fetch:this.fetch}),r=this.shouldThrowOnError;return new Proxy(t,{get(a,u){const d=a[u];return typeof d!="function"?d:(...p)=>J(this,void 0,void 0,function*(){try{return{data:yield d.apply(a,p),error:null}}catch(y){if(r)throw y;return{data:null,error:y}}})}})}}const Ls={"X-Client-Info":`storage-js/${to}`,"Content-Type":"application/json"};class qs extends Error{constructor(e){super(e),this.__isStorageVectorsError=!0,this.name="StorageVectorsError"}}function Ce(i){return typeof i=="object"&&i!==null&&"__isStorageVectorsError"in i}class on extends qs{constructor(e,t,r){super(e),this.name="StorageVectorsApiError",this.status=t,this.statusCode=r}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class so extends qs{constructor(e,t){super(e),this.name="StorageVectorsUnknownError",this.originalError=t}}var Cs;(function(i){i.InternalError="InternalError",i.S3VectorConflictException="S3VectorConflictException",i.S3VectorNotFoundException="S3VectorNotFoundException",i.S3VectorBucketNotEmpty="S3VectorBucketNotEmpty",i.S3VectorMaxBucketsExceeded="S3VectorMaxBucketsExceeded",i.S3VectorMaxIndexesExceeded="S3VectorMaxIndexesExceeded"})(Cs||(Cs={}));const En=i=>i?(...e)=>i(...e):(...e)=>fetch(...e),oc=()=>Response,io=i=>{if(typeof i!="object"||i===null)return!1;const e=Object.getPrototypeOf(i);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in i)&&!(Symbol.iterator in i)},uc=i=>Array.from(new Float32Array(i)),cc=(i,e)=>{if(e!==void 0&&i.float32.length!==e)throw new Error(`Vector dimension mismatch: expected ${e}, got ${i.float32.length}`)},Fi=i=>i.msg||i.message||i.error_description||i.error||JSON.stringify(i),lc=(i,e,t)=>J(void 0,void 0,void 0,function*(){if(i&&typeof i=="object"&&"status"in i&&"ok"in i&&typeof i.status=="number"&&!t?.noResolveJson){const s=i.status||500,a=i;if(typeof a.json=="function")a.json().then(u=>{const d=u?.statusCode||u?.code||s+"";e(new on(Fi(u),s,d))}).catch(()=>{const u=s+"",d=a.statusText||`HTTP ${s} error`;e(new on(d,s,u))});else{const u=s+"",d=a.statusText||`HTTP ${s} error`;e(new on(d,s,u))}}else e(new so(Fi(i),i))}),hc=(i,e,t,r)=>{const s={method:i,headers:e?.headers||{}};return r?(io(r)?(s.headers=Object.assign({"Content-Type":"application/json"},e?.headers),s.body=JSON.stringify(r)):s.body=r,Object.assign(Object.assign({},s),t)):s};function dc(i,e,t,r,s,a){return J(this,void 0,void 0,function*(){return new Promise((u,d)=>{i(t,hc(e,r,s,a)).then(p=>{if(!p.ok)throw p;if(r?.noResolveJson)return p;const y=p.headers.get("content-type");return!y||!y.includes("application/json")?{}:p.json()}).then(p=>u(p)).catch(p=>lc(p,d,r))})})}function Ie(i,e,t,r,s){return J(this,void 0,void 0,function*(){return dc(i,"POST",e,r,s,t)})}class ao{constructor(e,t={},r){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},Ls),t),this.fetch=En(r)}throwOnError(){return this.shouldThrowOnError=!0,this}createIndex(e){return J(this,void 0,void 0,function*(){try{return{data:(yield Ie(this.fetch,`${this.url}/CreateIndex`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}getIndex(e,t){return J(this,void 0,void 0,function*(){try{return{data:yield Ie(this.fetch,`${this.url}/GetIndex`,{vectorBucketName:e,indexName:t},{headers:this.headers}),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(Ce(r))return{data:null,error:r};throw r}})}listIndexes(e){return J(this,void 0,void 0,function*(){try{return{data:yield Ie(this.fetch,`${this.url}/ListIndexes`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}deleteIndex(e,t){return J(this,void 0,void 0,function*(){try{return{data:(yield Ie(this.fetch,`${this.url}/DeleteIndex`,{vectorBucketName:e,indexName:t},{headers:this.headers}))||{},error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(Ce(r))return{data:null,error:r};throw r}})}}class oo{constructor(e,t={},r){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},Ls),t),this.fetch=En(r)}throwOnError(){return this.shouldThrowOnError=!0,this}putVectors(e){return J(this,void 0,void 0,function*(){try{if(e.vectors.length<1||e.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return{data:(yield Ie(this.fetch,`${this.url}/PutVectors`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}getVectors(e){return J(this,void 0,void 0,function*(){try{return{data:yield Ie(this.fetch,`${this.url}/GetVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}listVectors(e){return J(this,void 0,void 0,function*(){try{if(e.segmentCount!==void 0){if(e.segmentCount<1||e.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(e.segmentIndex!==void 0&&(e.segmentIndex<0||e.segmentIndex>=e.segmentCount))throw new Error(`segmentIndex must be between 0 and ${e.segmentCount-1}`)}return{data:yield Ie(this.fetch,`${this.url}/ListVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}queryVectors(e){return J(this,void 0,void 0,function*(){try{return{data:yield Ie(this.fetch,`${this.url}/QueryVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}deleteVectors(e){return J(this,void 0,void 0,function*(){try{if(e.keys.length<1||e.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return{data:(yield Ie(this.fetch,`${this.url}/DeleteVectors`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}}class uo{constructor(e,t={},r){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},Ls),t),this.fetch=En(r)}throwOnError(){return this.shouldThrowOnError=!0,this}createBucket(e){return J(this,void 0,void 0,function*(){try{return{data:(yield Ie(this.fetch,`${this.url}/CreateVectorBucket`,{vectorBucketName:e},{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}getBucket(e){return J(this,void 0,void 0,function*(){try{return{data:yield Ie(this.fetch,`${this.url}/GetVectorBucket`,{vectorBucketName:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}listBuckets(){return J(this,arguments,void 0,function*(e={}){try{return{data:yield Ie(this.fetch,`${this.url}/ListVectorBuckets`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}deleteBucket(e){return J(this,void 0,void 0,function*(){try{return{data:(yield Ie(this.fetch,`${this.url}/DeleteVectorBucket`,{vectorBucketName:e},{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Ce(t))return{data:null,error:t};throw t}})}}class co extends uo{constructor(e,t={}){super(e,t.headers||{},t.fetch)}from(e){return new lo(this.url,this.headers,e,this.fetch)}createBucket(e){const t=Object.create(null,{createBucket:{get:()=>super.createBucket}});return J(this,void 0,void 0,function*(){return t.createBucket.call(this,e)})}getBucket(e){const t=Object.create(null,{getBucket:{get:()=>super.getBucket}});return J(this,void 0,void 0,function*(){return t.getBucket.call(this,e)})}listBuckets(){const e=Object.create(null,{listBuckets:{get:()=>super.listBuckets}});return J(this,arguments,void 0,function*(t={}){return e.listBuckets.call(this,t)})}deleteBucket(e){const t=Object.create(null,{deleteBucket:{get:()=>super.deleteBucket}});return J(this,void 0,void 0,function*(){return t.deleteBucket.call(this,e)})}}class lo extends ao{constructor(e,t,r,s){super(e,t,s),this.vectorBucketName=r}createIndex(e){const t=Object.create(null,{createIndex:{get:()=>super.createIndex}});return J(this,void 0,void 0,function*(){return t.createIndex.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName}))})}listIndexes(){const e=Object.create(null,{listIndexes:{get:()=>super.listIndexes}});return J(this,arguments,void 0,function*(t={}){return e.listIndexes.call(this,Object.assign(Object.assign({},t),{vectorBucketName:this.vectorBucketName}))})}getIndex(e){const t=Object.create(null,{getIndex:{get:()=>super.getIndex}});return J(this,void 0,void 0,function*(){return t.getIndex.call(this,this.vectorBucketName,e)})}deleteIndex(e){const t=Object.create(null,{deleteIndex:{get:()=>super.deleteIndex}});return J(this,void 0,void 0,function*(){return t.deleteIndex.call(this,this.vectorBucketName,e)})}index(e){return new ho(this.url,this.headers,this.vectorBucketName,e,this.fetch)}}class ho extends oo{constructor(e,t,r,s,a){super(e,t,a),this.vectorBucketName=r,this.indexName=s}putVectors(e){const t=Object.create(null,{putVectors:{get:()=>super.putVectors}});return J(this,void 0,void 0,function*(){return t.putVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}getVectors(e){const t=Object.create(null,{getVectors:{get:()=>super.getVectors}});return J(this,void 0,void 0,function*(){return t.getVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}listVectors(){const e=Object.create(null,{listVectors:{get:()=>super.listVectors}});return J(this,arguments,void 0,function*(t={}){return e.listVectors.call(this,Object.assign(Object.assign({},t),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}queryVectors(e){const t=Object.create(null,{queryVectors:{get:()=>super.queryVectors}});return J(this,void 0,void 0,function*(){return t.queryVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}deleteVectors(e){const t=Object.create(null,{deleteVectors:{get:()=>super.deleteVectors}});return J(this,void 0,void 0,function*(){return t.deleteVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}}class fc extends ec{constructor(e,t={},r,s){super(e,t,r,s)}from(e){return new Zu(this.url,this.headers,e,this.fetch)}get vectors(){return new co(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new no(this.url+"/iceberg",this.headers,this.fetch)}}const pc=Object.freeze(Object.defineProperty({__proto__:null,StorageAnalyticsClient:no,StorageApiError:Za,StorageClient:fc,StorageError:wr,StorageUnknownError:pn,StorageVectorsApiError:on,StorageVectorsClient:co,StorageVectorsError:qs,get StorageVectorsErrorCode(){return Cs},StorageVectorsUnknownError:so,VectorBucketApi:uo,VectorBucketScope:lo,VectorDataApi:oo,VectorIndexApi:ao,VectorIndexScope:ho,isPlainObject:io,isStorageError:pe,isStorageVectorsError:Ce,normalizeToFloat32:uc,resolveFetch:En,resolveResponse:oc,validateVectorDimension:cc},Symbol.toStringTag,{value:"Module"})),yc=vr(pc);var ds={},hr={},Ki;function gc(){return Ki||(Ki=1,Object.defineProperty(hr,"__esModule",{value:!0}),hr.version=void 0,hr.version="2.87.1"),hr}var Mi;function mc(){return Mi||(Mi=1,(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.DEFAULT_REALTIME_OPTIONS=i.DEFAULT_AUTH_OPTIONS=i.DEFAULT_DB_OPTIONS=i.DEFAULT_GLOBAL_OPTIONS=i.DEFAULT_HEADERS=void 0;const e=gc();let t="";typeof Deno<"u"?t="deno":typeof document<"u"?t="web":typeof navigator<"u"&&navigator.product==="ReactNative"?t="react-native":t="node",i.DEFAULT_HEADERS={"X-Client-Info":`supabase-js-${t}/${e.version}`},i.DEFAULT_GLOBAL_OPTIONS={headers:i.DEFAULT_HEADERS},i.DEFAULT_DB_OPTIONS={schema:"public"},i.DEFAULT_AUTH_OPTIONS={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},i.DEFAULT_REALTIME_OPTIONS={}})(ds)),ds}var fs={},Vi;function vc(){return Vi||(Vi=1,(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.fetchWithAuth=i.resolveHeadersConstructor=i.resolveFetch=void 0;const e=s=>s?(...a)=>s(...a):(...a)=>fetch(...a);i.resolveFetch=e;const t=()=>Headers;i.resolveHeadersConstructor=t;const r=(s,a,u)=>{const d=(0,i.resolveFetch)(u),p=(0,i.resolveHeadersConstructor)();return async(y,v)=>{var _;const T=(_=await a())!==null&&_!==void 0?_:s;let P=new p(v?.headers);return P.has("apikey")||P.set("apikey",s),P.has("Authorization")||P.set("Authorization",`Bearer ${T}`),d(y,Object.assign(Object.assign({},v),{headers:P}))}};i.fetchWithAuth=r})(fs)),fs}var Ge={},Wi;function wc(){if(Wi)return Ge;Wi=1,Object.defineProperty(Ge,"__esModule",{value:!0}),Ge.isBrowser=void 0,Ge.uuid=i,Ge.ensureTrailingSlash=e,Ge.applySettingDefaults=r,Ge.validateSupabaseUrl=s;function i(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var u=Math.random()*16|0,d=a=="x"?u:u&3|8;return d.toString(16)})}function e(a){return a.endsWith("/")?a:a+"/"}const t=()=>typeof window<"u";Ge.isBrowser=t;function r(a,u){var d,p;const{db:y,auth:v,realtime:_,global:T}=a,{db:P,auth:I,realtime:D,global:B}=u,q={db:Object.assign(Object.assign({},P),y),auth:Object.assign(Object.assign({},I),v),realtime:Object.assign(Object.assign({},D),_),storage:{},global:Object.assign(Object.assign(Object.assign({},B),T),{headers:Object.assign(Object.assign({},(d=B?.headers)!==null&&d!==void 0?d:{}),(p=T?.headers)!==null&&p!==void 0?p:{})}),accessToken:async()=>""};return a.accessToken?q.accessToken=a.accessToken:delete q.accessToken,q}function s(a){const u=a?.trim();if(!u)throw new Error("supabaseUrl is required.");if(!u.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(e(u))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}return Ge}var dr={};const fo="2.87.1",Ft=30*1e3,Rs=3,ps=Rs*Ft,_c="http://localhost:9999",bc="supabase.auth.token",Ec={"X-Client-Info":`gotrue-js/${fo}`},js="X-Supabase-Api-Version",po={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Sc=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,kc=600*1e3;let Ht=class extends Error{constructor(e,t,r){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=r}};function Q(i){return typeof i=="object"&&i!==null&&"__isAuthError"in i}let yo=class extends Ht{constructor(e,t,r){super(e,t,r),this.name="AuthApiError",this.status=t,this.code=r}};function go(i){return Q(i)&&i.name==="AuthApiError"}let nt=class extends Ht{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}},Je=class extends Ht{constructor(e,t,r,s){super(e,r,s),this.name=t,this.status=r}},Pe=class extends Je{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}};function mo(i){return Q(i)&&i.name==="AuthSessionMissingError"}let _t=class extends Je{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}},pr=class extends Je{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}},yr=class extends Je{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}};function vo(i){return Q(i)&&i.name==="AuthImplicitGrantRedirectError"}let Is=class extends Je{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}},yn=class extends Je{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}};function un(i){return Q(i)&&i.name==="AuthRetryableFetchError"}let xs=class extends Je{constructor(e,t,r){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=r}};function Oc(i){return Q(i)&&i.name==="AuthWeakPasswordError"}let gn=class extends Je{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}};const mn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),zi=` 	
\r=`.split(""),Tc=(()=>{const i=new Array(128);for(let e=0;e<i.length;e+=1)i[e]=-1;for(let e=0;e<zi.length;e+=1)i[zi[e].charCodeAt(0)]=-2;for(let e=0;e<mn.length;e+=1)i[mn[e].charCodeAt(0)]=e;return i})();function Hi(i,e,t){if(i!==null)for(e.queue=e.queue<<8|i,e.queuedBits+=8;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(mn[r]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(mn[r]),e.queuedBits-=6}}function wo(i,e,t){const r=Tc[i];if(r>-1)for(e.queue=e.queue<<6|r,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(r===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(i)}"`)}}function Gi(i){const e=[],t=u=>{e.push(String.fromCodePoint(u))},r={utf8seq:0,codepoint:0},s={queue:0,queuedBits:0},a=u=>{Cc(u,r,t)};for(let u=0;u<i.length;u+=1)wo(i.charCodeAt(u),s,a);return e.join("")}function Ac(i,e){if(i<=127){e(i);return}else if(i<=2047){e(192|i>>6),e(128|i&63);return}else if(i<=65535){e(224|i>>12),e(128|i>>6&63),e(128|i&63);return}else if(i<=1114111){e(240|i>>18),e(128|i>>12&63),e(128|i>>6&63),e(128|i&63);return}throw new Error(`Unrecognized Unicode codepoint: ${i.toString(16)}`)}function Pc(i,e){for(let t=0;t<i.length;t+=1){let r=i.charCodeAt(t);if(r>55295&&r<=56319){const s=(r-55296)*1024&65535;r=(i.charCodeAt(t+1)-56320&65535|s)+65536,t+=1}Ac(r,e)}}function Cc(i,e,t){if(e.utf8seq===0){if(i<=127){t(i);return}for(let r=1;r<6;r+=1)if((i>>7-r&1)===0){e.utf8seq=r;break}if(e.utf8seq===2)e.codepoint=i&31;else if(e.utf8seq===3)e.codepoint=i&15;else if(e.utf8seq===4)e.codepoint=i&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(i<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|i&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function Wt(i){const e=[],t={queue:0,queuedBits:0},r=s=>{e.push(s)};for(let s=0;s<i.length;s+=1)wo(i.charCodeAt(s),t,r);return new Uint8Array(e)}function Rc(i){const e=[];return Pc(i,t=>e.push(t)),new Uint8Array(e)}function Ot(i){const e=[],t={queue:0,queuedBits:0},r=s=>{e.push(s)};return i.forEach(s=>Hi(s,t,r)),Hi(null,t,r),e.join("")}function jc(i){return Math.round(Date.now()/1e3)+i}function Ic(){return Symbol("auth-callback")}const Ee=()=>typeof window<"u"&&typeof document<"u",vt={tested:!1,writable:!1},_o=()=>{if(!Ee())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(vt.tested)return vt.writable;const i=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(i,i),globalThis.localStorage.removeItem(i),vt.tested=!0,vt.writable=!0}catch{vt.tested=!0,vt.writable=!1}return vt.writable};function xc(i){const e={},t=new URL(i);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((s,a)=>{e[a]=s})}catch{}return t.searchParams.forEach((r,s)=>{e[s]=r}),e}const bo=i=>i?(...e)=>i(...e):(...e)=>fetch(...e),$c=i=>typeof i=="object"&&i!==null&&"status"in i&&"ok"in i&&"json"in i&&typeof i.json=="function",Kt=async(i,e,t)=>{await i.setItem(e,JSON.stringify(t))},wt=async(i,e)=>{const t=await i.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},be=async(i,e)=>{await i.removeItem(e)};class Sn{constructor(){this.promise=new Sn.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}Sn.promiseConstructor=Promise;function ys(i){const e=i.split(".");if(e.length!==3)throw new gn("Invalid JWT structure");for(let r=0;r<e.length;r++)if(!Sc.test(e[r]))throw new gn("JWT not in base64url format");return{header:JSON.parse(Gi(e[0])),payload:JSON.parse(Gi(e[1])),signature:Wt(e[2]),raw:{header:e[0],payload:e[1]}}}async function Dc(i){return await new Promise(e=>{setTimeout(()=>e(null),i)})}function Bc(i,e){return new Promise((r,s)=>{(async()=>{for(let a=0;a<1/0;a++)try{const u=await i(a);if(!e(a,null,u)){r(u);return}}catch(u){if(!e(a,u)){s(u);return}}})()})}function Nc(i){return("0"+i.toString(16)).substr(-2)}function Uc(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=t.length;let s="";for(let a=0;a<56;a++)s+=t.charAt(Math.floor(Math.random()*r));return s}return crypto.getRandomValues(e),Array.from(e,Nc).join("")}async function Lc(i){const t=new TextEncoder().encode(i),r=await crypto.subtle.digest("SHA-256",t),s=new Uint8Array(r);return Array.from(s).map(a=>String.fromCharCode(a)).join("")}async function qc(i){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),i;const t=await Lc(i);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Ut(i,e,t=!1){const r=Uc();let s=r;t&&(s+="/PASSWORD_RECOVERY"),await Kt(i,`${e}-code-verifier`,s);const a=await qc(r);return[a,r===a?"plain":"s256"]}const Fc=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Kc(i){const e=i.headers.get(js);if(!e||!e.match(Fc))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function Mc(i){if(!i)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(i<=e)throw new Error("JWT has expired")}function Vc(i){switch(i){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Wc=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Lt(i){if(!Wc.test(i))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function gs(){const i={};return new Proxy(i,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){const r=t.toString();if(r==="Symbol(Symbol.toPrimitive)"||r==="Symbol(Symbol.toStringTag)"||r==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function zc(i,e){return new Proxy(i,{get:(t,r,s)=>{if(r==="__isInsecureUserWarningProxy")return!0;if(typeof r=="symbol"){const a=r.toString();if(a==="Symbol(Symbol.toPrimitive)"||a==="Symbol(Symbol.toStringTag)"||a==="Symbol(util.inspect.custom)"||a==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(t,r,s)}return!e.value&&typeof r=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(t,r,s)}})}function Ji(i){return JSON.parse(JSON.stringify(i))}const bt=i=>i.msg||i.message||i.error_description||i.error||JSON.stringify(i),Hc=[502,503,504];async function Qi(i){var e;if(!$c(i))throw new yn(bt(i),0);if(Hc.includes(i.status))throw new yn(bt(i),i.status);let t;try{t=await i.json()}catch(a){throw new nt(bt(a),a)}let r;const s=Kc(i);if(s&&s.getTime()>=po["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?r=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(r=t.error_code),r){if(r==="weak_password")throw new xs(bt(t),i.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(r==="session_not_found")throw new Pe}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((a,u)=>a&&typeof u=="string",!0))throw new xs(bt(t),i.status,t.weak_password.reasons);throw new yo(bt(t),i.status||500,r)}const Gc=(i,e,t,r)=>{const s={method:i,headers:e?.headers||{}};return i==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e?.headers),s.body=JSON.stringify(r),Object.assign(Object.assign({},s),t))};async function ee(i,e,t,r){var s;const a=Object.assign({},r?.headers);a[js]||(a[js]=po["2024-01-01"].name),r?.jwt&&(a.Authorization=`Bearer ${r.jwt}`);const u=(s=r?.query)!==null&&s!==void 0?s:{};r?.redirectTo&&(u.redirect_to=r.redirectTo);const d=Object.keys(u).length?"?"+new URLSearchParams(u).toString():"",p=await Jc(i,e,t+d,{headers:a,noResolveJson:r?.noResolveJson},{},r?.body);return r?.xform?r?.xform(p):{data:Object.assign({},p),error:null}}async function Jc(i,e,t,r,s,a){const u=Gc(e,r,s,a);let d;try{d=await i(t,Object.assign({},u))}catch(p){throw console.error(p),new yn(bt(p),0)}if(d.ok||await Qi(d),r?.noResolveJson)return d;try{return await d.json()}catch(p){await Qi(p)}}function Be(i){var e;let t=null;Xc(i)&&(t=Object.assign({},i),i.expires_at||(t.expires_at=jc(i.expires_in)));const r=(e=i.user)!==null&&e!==void 0?e:i;return{data:{session:t,user:r},error:null}}function Yi(i){const e=Be(i);return!e.error&&i.weak_password&&typeof i.weak_password=="object"&&Array.isArray(i.weak_password.reasons)&&i.weak_password.reasons.length&&i.weak_password.message&&typeof i.weak_password.message=="string"&&i.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)&&(e.data.weak_password=i.weak_password),e}function st(i){var e;return{data:{user:(e=i.user)!==null&&e!==void 0?e:i},error:null}}function Qc(i){return{data:i,error:null}}function Yc(i){const{action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:a}=i,u=Gt(i,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),d={action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:a},p=Object.assign({},u);return{data:{properties:d,user:p},error:null}}function Xi(i){return i}function Xc(i){return i.access_token&&i.refresh_token&&i.expires_in}const cn=["global","local","others"];let Fs=class{constructor({url:e="",headers:t={},fetch:r}){this.url=e,this.headers=t,this.fetch=bo(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,t=cn[0]){if(cn.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${cn.join(", ")}`);try{return await ee(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if(Q(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,t={}){try{return await ee(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:st})}catch(r){if(Q(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{const{options:t}=e,r=Gt(e,["options"]),s=Object.assign(Object.assign({},r),t);return"newEmail"in r&&(s.new_email=r?.newEmail,delete s.newEmail),await ee(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:s,headers:this.headers,xform:Yc,redirectTo:t?.redirectTo})}catch(t){if(Q(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await ee(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:st})}catch(t){if(Q(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,r,s,a,u,d,p;try{const y={nextPage:null,lastPage:0,total:0},v=await ee(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(a=(s=e?.perPage)===null||s===void 0?void 0:s.toString())!==null&&a!==void 0?a:""},xform:Xi});if(v.error)throw v.error;const _=await v.json(),T=(u=v.headers.get("x-total-count"))!==null&&u!==void 0?u:0,P=(p=(d=v.headers.get("link"))===null||d===void 0?void 0:d.split(","))!==null&&p!==void 0?p:[];return P.length>0&&(P.forEach(I=>{const D=parseInt(I.split(";")[0].split("=")[1].substring(0,1)),B=JSON.parse(I.split(";")[1].split("=")[1]);y[`${B}Page`]=D}),y.total=parseInt(T)),{data:Object.assign(Object.assign({},_),y),error:null}}catch(y){if(Q(y))return{data:{users:[]},error:y};throw y}}async getUserById(e){Lt(e);try{return await ee(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:st})}catch(t){if(Q(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){Lt(e);try{return await ee(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:st})}catch(r){if(Q(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,t=!1){Lt(e);try{return await ee(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:st})}catch(r){if(Q(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){Lt(e.userId);try{const{data:t,error:r}=await ee(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:s=>({data:{factors:s},error:null})});return{data:t,error:r}}catch(t){if(Q(t))return{data:null,error:t};throw t}}async _deleteFactor(e){Lt(e.userId),Lt(e.id);try{return{data:await ee(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(Q(t))return{data:null,error:t};throw t}}async _listOAuthClients(e){var t,r,s,a,u,d,p;try{const y={nextPage:null,lastPage:0,total:0},v=await ee(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(a=(s=e?.perPage)===null||s===void 0?void 0:s.toString())!==null&&a!==void 0?a:""},xform:Xi});if(v.error)throw v.error;const _=await v.json(),T=(u=v.headers.get("x-total-count"))!==null&&u!==void 0?u:0,P=(p=(d=v.headers.get("link"))===null||d===void 0?void 0:d.split(","))!==null&&p!==void 0?p:[];return P.length>0&&(P.forEach(I=>{const D=parseInt(I.split(";")[0].split("=")[1].substring(0,1)),B=JSON.parse(I.split(";")[1].split("=")[1]);y[`${B}Page`]=D}),y.total=parseInt(T)),{data:Object.assign(Object.assign({},_),y),error:null}}catch(y){if(Q(y))return{data:{clients:[]},error:y};throw y}}async _createOAuthClient(e){try{return await ee(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(Q(t))return{data:null,error:t};throw t}}async _getOAuthClient(e){try{return await ee(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(Q(t))return{data:null,error:t};throw t}}async _updateOAuthClient(e,t){try{return await ee(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:t,headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(Q(r))return{data:null,error:r};throw r}}async _deleteOAuthClient(e){try{return await ee(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(t){if(Q(t))return{data:null,error:t};throw t}}async _regenerateOAuthClientSecret(e){try{return await ee(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(Q(t))return{data:null,error:t};throw t}}};function Zi(i={}){return{getItem:e=>i[e]||null,setItem:(e,t)=>{i[e]=t},removeItem:e=>{delete i[e]}}}const Et={debug:!!(globalThis&&_o()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class Ks extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}let Eo=class extends Ks{};class Zc extends Ks{}async function So(i,e,t){Et.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",i,e);const r=new globalThis.AbortController;return e>0&&setTimeout(()=>{r.abort(),Et.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",i)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(i,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async s=>{if(s){Et.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",i,s.name);try{return await t()}finally{Et.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",i,s.name)}}else{if(e===0)throw Et.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",i),new Eo(`Acquiring an exclusive Navigator LockManager lock "${i}" immediately failed`);if(Et.debug)try{const a=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(a,null,"  "))}catch(a){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",a)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}const ea={};async function el(i,e,t){var r;const s=(r=ea[i])!==null&&r!==void 0?r:Promise.resolve(),a=Promise.race([s.catch(()=>null),e>=0?new Promise((u,d)=>{setTimeout(()=>{d(new Zc(`Acquring process lock with name "${i}" timed out`))},e)}):null].filter(u=>u)).catch(u=>{if(u&&u.isAcquireTimeout)throw u;return null}).then(async()=>await t());return ea[i]=a.catch(async u=>{if(u&&u.isAcquireTimeout)return await s,null;throw u}),await a}function tl(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function ko(i){if(!/^0x[a-fA-F0-9]{40}$/.test(i))throw new Error(`@supabase/auth-js: Address "${i}" is invalid.`);return i.toLowerCase()}function rl(i){return parseInt(i,16)}function nl(i){const e=new TextEncoder().encode(i);return"0x"+Array.from(e,r=>r.toString(16).padStart(2,"0")).join("")}function sl(i){var e;const{chainId:t,domain:r,expirationTime:s,issuedAt:a=new Date,nonce:u,notBefore:d,requestId:p,resources:y,scheme:v,uri:_,version:T}=i;{if(!Number.isInteger(t))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${t}`);if(!r)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(u&&u.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${u}`);if(!_)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(T!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${T}`);if(!((e=i.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${i.statement}`)}const P=ko(i.address),I=v?`${v}://${r}`:r,D=i.statement?`${i.statement}
`:"",B=`${I} wants you to sign in with your Ethereum account:
${P}

${D}`;let q=`URI: ${_}
Version: ${T}
Chain ID: ${t}${u?`
Nonce: ${u}`:""}
Issued At: ${a.toISOString()}`;if(s&&(q+=`
Expiration Time: ${s.toISOString()}`),d&&(q+=`
Not Before: ${d.toISOString()}`),p&&(q+=`
Request ID: ${p}`),y){let H=`
Resources:`;for(const L of y){if(!L||typeof L!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${L}`);H+=`
- ${L}`}q+=H}return`${B}
${q}`}class ve extends Error{constructor({message:e,code:t,cause:r,name:s}){var a;super(e,{cause:r}),this.__isWebAuthnError=!0,this.name=(a=s??(r instanceof Error?r.name:void 0))!==null&&a!==void 0?a:"Unknown Error",this.code=t}}class vn extends ve{constructor(e,t){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t,message:e}),this.name="WebAuthnUnknownError",this.originalError=t}}function il({error:i,options:e}){var t,r,s;const{publicKey:a}=e;if(!a)throw Error("options was missing required publicKey property");if(i.name==="AbortError"){if(e.signal instanceof AbortSignal)return new ve({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:i})}else if(i.name==="ConstraintError"){if(((t=a.authenticatorSelection)===null||t===void 0?void 0:t.requireResidentKey)===!0)return new ve({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:i});if(e.mediation==="conditional"&&((r=a.authenticatorSelection)===null||r===void 0?void 0:r.userVerification)==="required")return new ve({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:i});if(((s=a.authenticatorSelection)===null||s===void 0?void 0:s.userVerification)==="required")return new ve({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:i})}else{if(i.name==="InvalidStateError")return new ve({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:i});if(i.name==="NotAllowedError")return new ve({message:i.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:i});if(i.name==="NotSupportedError")return a.pubKeyCredParams.filter(d=>d.type==="public-key").length===0?new ve({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:i}):new ve({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:i});if(i.name==="SecurityError"){const u=window.location.hostname;if(Oo(u)){if(a.rp.id!==u)return new ve({message:`The RP ID "${a.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:i})}else return new ve({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:i})}else if(i.name==="TypeError"){if(a.user.id.byteLength<1||a.user.id.byteLength>64)return new ve({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:i})}else if(i.name==="UnknownError")return new ve({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:i})}return new ve({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:i})}function al({error:i,options:e}){const{publicKey:t}=e;if(!t)throw Error("options was missing required publicKey property");if(i.name==="AbortError"){if(e.signal instanceof AbortSignal)return new ve({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:i})}else{if(i.name==="NotAllowedError")return new ve({message:i.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:i});if(i.name==="SecurityError"){const r=window.location.hostname;if(Oo(r)){if(t.rpId!==r)return new ve({message:`The RP ID "${t.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:i})}else return new ve({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:i})}else if(i.name==="UnknownError")return new ve({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:i})}return new ve({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:i})}class ol{createNewAbortSignal(){if(this.controller){const t=new Error("Cancelling existing WebAuthn API call for new one");t.name="AbortError",this.controller.abort(t)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const ul=new ol;function cl(i){if(!i)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(i);const{challenge:e,user:t,excludeCredentials:r}=i,s=Gt(i,["challenge","user","excludeCredentials"]),a=Wt(e).buffer,u=Object.assign(Object.assign({},t),{id:Wt(t.id).buffer}),d=Object.assign(Object.assign({},s),{challenge:a,user:u});if(r&&r.length>0){d.excludeCredentials=new Array(r.length);for(let p=0;p<r.length;p++){const y=r[p];d.excludeCredentials[p]=Object.assign(Object.assign({},y),{id:Wt(y.id).buffer,type:y.type||"public-key",transports:y.transports})}}return d}function ll(i){if(!i)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(i);const{challenge:e,allowCredentials:t}=i,r=Gt(i,["challenge","allowCredentials"]),s=Wt(e).buffer,a=Object.assign(Object.assign({},r),{challenge:s});if(t&&t.length>0){a.allowCredentials=new Array(t.length);for(let u=0;u<t.length;u++){const d=t[u];a.allowCredentials[u]=Object.assign(Object.assign({},d),{id:Wt(d.id).buffer,type:d.type||"public-key",transports:d.transports})}}return a}function hl(i){var e;if("toJSON"in i&&typeof i.toJSON=="function")return i.toJSON();const t=i;return{id:i.id,rawId:i.id,response:{attestationObject:Ot(new Uint8Array(i.response.attestationObject)),clientDataJSON:Ot(new Uint8Array(i.response.clientDataJSON))},type:"public-key",clientExtensionResults:i.getClientExtensionResults(),authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function dl(i){var e;if("toJSON"in i&&typeof i.toJSON=="function")return i.toJSON();const t=i,r=i.getClientExtensionResults(),s=i.response;return{id:i.id,rawId:i.id,response:{authenticatorData:Ot(new Uint8Array(s.authenticatorData)),clientDataJSON:Ot(new Uint8Array(s.clientDataJSON)),signature:Ot(new Uint8Array(s.signature)),userHandle:s.userHandle?Ot(new Uint8Array(s.userHandle)):void 0},type:"public-key",clientExtensionResults:r,authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function Oo(i){return i==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(i)}function ta(){var i,e;return!!(Ee()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((i=navigator?.credentials)===null||i===void 0?void 0:i.create)=="function"&&typeof((e=navigator?.credentials)===null||e===void 0?void 0:e.get)=="function")}async function fl(i){try{const e=await navigator.credentials.create(i);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new vn("Browser returned unexpected credential type",e)}:{data:null,error:new vn("Empty credential response",e)}}catch(e){return{data:null,error:il({error:e,options:i})}}}async function pl(i){try{const e=await navigator.credentials.get(i);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new vn("Browser returned unexpected credential type",e)}:{data:null,error:new vn("Empty credential response",e)}}catch(e){return{data:null,error:al({error:e,options:i})}}}const yl={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},gl={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function wn(...i){const e=s=>s!==null&&typeof s=="object"&&!Array.isArray(s),t=s=>s instanceof ArrayBuffer||ArrayBuffer.isView(s),r={};for(const s of i)if(s)for(const a in s){const u=s[a];if(u!==void 0)if(Array.isArray(u))r[a]=u;else if(t(u))r[a]=u;else if(e(u)){const d=r[a];e(d)?r[a]=wn(d,u):r[a]=wn(u)}else r[a]=u}return r}function ml(i,e){return wn(yl,i,e||{})}function vl(i,e){return wn(gl,i,e||{})}class wl{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:t,friendlyName:r,signal:s},a){try{const{data:u,error:d}=await this.client.mfa.challenge({factorId:e,webauthn:t});if(!u)return{data:null,error:d};const p=s??ul.createNewAbortSignal();if(u.webauthn.type==="create"){const{user:y}=u.webauthn.credential_options.publicKey;y.name||(y.name=`${y.id}:${r}`),y.displayName||(y.displayName=y.name)}switch(u.webauthn.type){case"create":{const y=ml(u.webauthn.credential_options.publicKey,a?.create),{data:v,error:_}=await fl({publicKey:y,signal:p});return v?{data:{factorId:e,challengeId:u.id,webauthn:{type:u.webauthn.type,credential_response:v}},error:null}:{data:null,error:_}}case"request":{const y=vl(u.webauthn.credential_options.publicKey,a?.request),{data:v,error:_}=await pl(Object.assign(Object.assign({},u.webauthn.credential_options),{publicKey:y,signal:p}));return v?{data:{factorId:e,challengeId:u.id,webauthn:{type:u.webauthn.type,credential_response:v}},error:null}:{data:null,error:_}}}}catch(u){return Q(u)?{data:null,error:u}:{data:null,error:new nt("Unexpected error in challenge",u)}}}async _verify({challengeId:e,factorId:t,webauthn:r}){return this.client.mfa.verify({factorId:t,challengeId:e,webauthn:r})}async _authenticate({factorId:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:s}={}},a){if(!t)return{data:null,error:new Ht("rpId is required for WebAuthn authentication")};try{if(!ta())return{data:null,error:new nt("Browser does not support WebAuthn",null)};const{data:u,error:d}=await this.challenge({factorId:e,webauthn:{rpId:t,rpOrigins:r},signal:s},{request:a});if(!u)return{data:null,error:d};const{webauthn:p}=u;return this._verify({factorId:e,challengeId:u.challengeId,webauthn:{type:p.type,rpId:t,rpOrigins:r,credential_response:p.credential_response}})}catch(u){return Q(u)?{data:null,error:u}:{data:null,error:new nt("Unexpected error in authenticate",u)}}}async _register({friendlyName:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:s}={}},a){if(!t)return{data:null,error:new Ht("rpId is required for WebAuthn registration")};try{if(!ta())return{data:null,error:new nt("Browser does not support WebAuthn",null)};const{data:u,error:d}=await this._enroll({friendlyName:e});if(!u)return await this.client.mfa.listFactors().then(v=>{var _;return(_=v.data)===null||_===void 0?void 0:_.all.find(T=>T.factor_type==="webauthn"&&T.friendly_name===e&&T.status!=="unverified")}).then(v=>v?this.client.mfa.unenroll({factorId:v?.id}):void 0),{data:null,error:d};const{data:p,error:y}=await this._challenge({factorId:u.id,friendlyName:u.friendly_name,webauthn:{rpId:t,rpOrigins:r},signal:s},{create:a});return p?this._verify({factorId:u.id,challengeId:p.challengeId,webauthn:{rpId:t,rpOrigins:r,type:p.webauthn.type,credential_response:p.webauthn.credential_response}}):{data:null,error:y}}catch(u){return Q(u)?{data:null,error:u}:{data:null,error:new nt("Unexpected error in register",u)}}}}tl();const _l={url:_c,storageKey:bc,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Ec,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1};async function ra(i,e,t){return await t()}const qt={};let Ms=class $s{get jwks(){var e,t;return(t=(e=qt[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){qt[this.storageKey]=Object.assign(Object.assign({},qt[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=qt[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){qt[this.storageKey]=Object.assign(Object.assign({},qt[this.storageKey]),{cachedAt:e})}constructor(e){var t,r,s;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const a=Object.assign(Object.assign({},_l),e);if(this.storageKey=a.storageKey,this.instanceID=(t=$s.nextInstanceID[this.storageKey])!==null&&t!==void 0?t:0,$s.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!a.debug,typeof a.debug=="function"&&(this.logger=a.debug),this.instanceID>0&&Ee()){const u=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(u),this.logDebugMessages&&console.trace(u)}if(this.persistSession=a.persistSession,this.autoRefreshToken=a.autoRefreshToken,this.admin=new Fs({url:a.url,headers:a.headers,fetch:a.fetch}),this.url=a.url,this.headers=a.headers,this.fetch=bo(a.fetch),this.lock=a.lock||ra,this.detectSessionInUrl=a.detectSessionInUrl,this.flowType=a.flowType,this.hasCustomAuthorizationHeader=a.hasCustomAuthorizationHeader,this.throwOnError=a.throwOnError,a.lock?this.lock=a.lock:this.persistSession&&Ee()&&(!((r=globalThis?.navigator)===null||r===void 0)&&r.locks)?this.lock=So:this.lock=ra,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new wl(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(a.storage?this.storage=a.storage:_o()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=Zi(this.memoryStorage)),a.userStorage&&(this.userStorage=a.userStorage)):(this.memoryStorage={},this.storage=Zi(this.memoryStorage)),Ee()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(u){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",u)}(s=this.broadcastChannel)===null||s===void 0||s.addEventListener("message",async u=>{this._debug("received broadcast notification from other tab or client",u),await this._notifyAllSubscribers(u.data.event,u.data.session,!1)})}this.initialize()}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${fo}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let t={},r="none";if(Ee()&&(t=xc(window.location.href),this._isImplicitGrantCallback(t)?r="implicit":await this._isPKCECallback(t)&&(r="pkce")),Ee()&&this.detectSessionInUrl&&r!=="none"){const{data:s,error:a}=await this._getSessionFromURL(t,r);if(a){if(this._debug("#_initialize()","error detecting session from URL",a),vo(a)){const p=(e=a.details)===null||e===void 0?void 0:e.code;if(p==="identity_already_exists"||p==="identity_not_found"||p==="single_identity_not_deletable")return{error:a}}return await this._removeSession(),{error:a}}const{session:u,redirectType:d}=s;return this._debug("#_initialize()","detected session in URL",u,"redirect type",d),await this._saveSession(u),setTimeout(async()=>{d==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",u):await this._notifyAllSubscribers("SIGNED_IN",u)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return Q(t)?this._returnResult({error:t}):this._returnResult({error:new nt("Unexpected error during initialization",t)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,r,s;try{const a=await ee(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(r=(t=e?.options)===null||t===void 0?void 0:t.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:(s=e?.options)===null||s===void 0?void 0:s.captchaToken}},xform:Be}),{data:u,error:d}=a;if(d||!u)return this._returnResult({data:{user:null,session:null},error:d});const p=u.session,y=u.user;return u.session&&(await this._saveSession(u.session),await this._notifyAllSubscribers("SIGNED_IN",p)),this._returnResult({data:{user:y,session:p},error:null})}catch(a){if(Q(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async signUp(e){var t,r,s;try{let a;if("email"in e){const{email:v,password:_,options:T}=e;let P=null,I=null;this.flowType==="pkce"&&([P,I]=await Ut(this.storage,this.storageKey)),a=await ee(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:T?.emailRedirectTo,body:{email:v,password:_,data:(t=T?.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:T?.captchaToken},code_challenge:P,code_challenge_method:I},xform:Be})}else if("phone"in e){const{phone:v,password:_,options:T}=e;a=await ee(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:v,password:_,data:(r=T?.data)!==null&&r!==void 0?r:{},channel:(s=T?.channel)!==null&&s!==void 0?s:"sms",gotrue_meta_security:{captcha_token:T?.captchaToken}},xform:Be})}else throw new pr("You must provide either an email or phone number and a password");const{data:u,error:d}=a;if(d||!u)return await be(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:d});const p=u.session,y=u.user;return u.session&&(await this._saveSession(u.session),await this._notifyAllSubscribers("SIGNED_IN",p)),this._returnResult({data:{user:y,session:p},error:null})}catch(a){if(await be(this.storage,`${this.storageKey}-code-verifier`),Q(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async signInWithPassword(e){try{let t;if("email"in e){const{email:a,password:u,options:d}=e;t=await ee(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:a,password:u,gotrue_meta_security:{captcha_token:d?.captchaToken}},xform:Yi})}else if("phone"in e){const{phone:a,password:u,options:d}=e;t=await ee(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:a,password:u,gotrue_meta_security:{captcha_token:d?.captchaToken}},xform:Yi})}else throw new pr("You must provide either an email or phone number and a password");const{data:r,error:s}=t;if(s)return this._returnResult({data:{user:null,session:null},error:s});if(!r||!r.session||!r.user){const a=new _t;return this._returnResult({data:{user:null,session:null},error:a})}return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),this._returnResult({data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:s})}catch(t){if(Q(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOAuth(e){var t,r,s,a;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(s=e.options)===null||s===void 0?void 0:s.queryParams,skipBrowserRedirect:(a=e.options)===null||a===void 0?void 0:a.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;switch(t){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}}async signInWithEthereum(e){var t,r,s,a,u,d,p,y,v,_,T;let P,I;if("message"in e)P=e.message,I=e.signature;else{const{chain:D,wallet:B,statement:q,options:H}=e;let L;if(Ee())if(typeof B=="object")L=B;else{const De=window;if("ethereum"in De&&typeof De.ethereum=="object"&&"request"in De.ethereum&&typeof De.ethereum.request=="function")L=De.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof B!="object"||!H?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");L=B}const X=new URL((t=H?.url)!==null&&t!==void 0?t:window.location.href),ce=await L.request({method:"eth_requestAccounts"}).then(De=>De).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!ce||ce.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const se=ko(ce[0]);let ae=(r=H?.signInWithEthereum)===null||r===void 0?void 0:r.chainId;if(!ae){const De=await L.request({method:"eth_chainId"});ae=rl(De)}const $e={domain:X.host,address:se,statement:q,uri:X.href,version:"1",chainId:ae,nonce:(s=H?.signInWithEthereum)===null||s===void 0?void 0:s.nonce,issuedAt:(u=(a=H?.signInWithEthereum)===null||a===void 0?void 0:a.issuedAt)!==null&&u!==void 0?u:new Date,expirationTime:(d=H?.signInWithEthereum)===null||d===void 0?void 0:d.expirationTime,notBefore:(p=H?.signInWithEthereum)===null||p===void 0?void 0:p.notBefore,requestId:(y=H?.signInWithEthereum)===null||y===void 0?void 0:y.requestId,resources:(v=H?.signInWithEthereum)===null||v===void 0?void 0:v.resources};P=sl($e),I=await L.request({method:"personal_sign",params:[nl(P),se]})}try{const{data:D,error:B}=await ee(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:P,signature:I},!((_=e.options)===null||_===void 0)&&_.captchaToken?{gotrue_meta_security:{captcha_token:(T=e.options)===null||T===void 0?void 0:T.captchaToken}}:null),xform:Be});if(B)throw B;if(!D||!D.session||!D.user){const q=new _t;return this._returnResult({data:{user:null,session:null},error:q})}return D.session&&(await this._saveSession(D.session),await this._notifyAllSubscribers("SIGNED_IN",D.session)),this._returnResult({data:Object.assign({},D),error:B})}catch(D){if(Q(D))return this._returnResult({data:{user:null,session:null},error:D});throw D}}async signInWithSolana(e){var t,r,s,a,u,d,p,y,v,_,T,P;let I,D;if("message"in e)I=e.message,D=e.signature;else{const{chain:B,wallet:q,statement:H,options:L}=e;let X;if(Ee())if(typeof q=="object")X=q;else{const se=window;if("solana"in se&&typeof se.solana=="object"&&("signIn"in se.solana&&typeof se.solana.signIn=="function"||"signMessage"in se.solana&&typeof se.solana.signMessage=="function"))X=se.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof q!="object"||!L?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");X=q}const ce=new URL((t=L?.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in X&&X.signIn){const se=await X.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},L?.signInWithSolana),{version:"1",domain:ce.host,uri:ce.href}),H?{statement:H}:null));let ae;if(Array.isArray(se)&&se[0]&&typeof se[0]=="object")ae=se[0];else if(se&&typeof se=="object"&&"signedMessage"in se&&"signature"in se)ae=se;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in ae&&"signature"in ae&&(typeof ae.signedMessage=="string"||ae.signedMessage instanceof Uint8Array)&&ae.signature instanceof Uint8Array)I=typeof ae.signedMessage=="string"?ae.signedMessage:new TextDecoder().decode(ae.signedMessage),D=ae.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in X)||typeof X.signMessage!="function"||!("publicKey"in X)||typeof X!="object"||!X.publicKey||!("toBase58"in X.publicKey)||typeof X.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");I=[`${ce.host} wants you to sign in with your Solana account:`,X.publicKey.toBase58(),...H?["",H,""]:[""],"Version: 1",`URI: ${ce.href}`,`Issued At: ${(s=(r=L?.signInWithSolana)===null||r===void 0?void 0:r.issuedAt)!==null&&s!==void 0?s:new Date().toISOString()}`,...!((a=L?.signInWithSolana)===null||a===void 0)&&a.notBefore?[`Not Before: ${L.signInWithSolana.notBefore}`]:[],...!((u=L?.signInWithSolana)===null||u===void 0)&&u.expirationTime?[`Expiration Time: ${L.signInWithSolana.expirationTime}`]:[],...!((d=L?.signInWithSolana)===null||d===void 0)&&d.chainId?[`Chain ID: ${L.signInWithSolana.chainId}`]:[],...!((p=L?.signInWithSolana)===null||p===void 0)&&p.nonce?[`Nonce: ${L.signInWithSolana.nonce}`]:[],...!((y=L?.signInWithSolana)===null||y===void 0)&&y.requestId?[`Request ID: ${L.signInWithSolana.requestId}`]:[],...!((_=(v=L?.signInWithSolana)===null||v===void 0?void 0:v.resources)===null||_===void 0)&&_.length?["Resources",...L.signInWithSolana.resources.map(ae=>`- ${ae}`)]:[]].join(`
`);const se=await X.signMessage(new TextEncoder().encode(I),"utf8");if(!se||!(se instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");D=se}}try{const{data:B,error:q}=await ee(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:I,signature:Ot(D)},!((T=e.options)===null||T===void 0)&&T.captchaToken?{gotrue_meta_security:{captcha_token:(P=e.options)===null||P===void 0?void 0:P.captchaToken}}:null),xform:Be});if(q)throw q;if(!B||!B.session||!B.user){const H=new _t;return this._returnResult({data:{user:null,session:null},error:H})}return B.session&&(await this._saveSession(B.session),await this._notifyAllSubscribers("SIGNED_IN",B.session)),this._returnResult({data:Object.assign({},B),error:q})}catch(B){if(Q(B))return this._returnResult({data:{user:null,session:null},error:B});throw B}}async _exchangeCodeForSession(e){const t=await wt(this.storage,`${this.storageKey}-code-verifier`),[r,s]=(t??"").split("/");try{const{data:a,error:u}=await ee(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:Be});if(await be(this.storage,`${this.storageKey}-code-verifier`),u)throw u;if(!a||!a.session||!a.user){const d=new _t;return this._returnResult({data:{user:null,session:null,redirectType:null},error:d})}return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",a.session)),this._returnResult({data:Object.assign(Object.assign({},a),{redirectType:s??null}),error:u})}catch(a){if(await be(this.storage,`${this.storageKey}-code-verifier`),Q(a))return this._returnResult({data:{user:null,session:null,redirectType:null},error:a});throw a}}async signInWithIdToken(e){try{const{options:t,provider:r,token:s,access_token:a,nonce:u}=e,d=await ee(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:s,access_token:a,nonce:u,gotrue_meta_security:{captcha_token:t?.captchaToken}},xform:Be}),{data:p,error:y}=d;if(y)return this._returnResult({data:{user:null,session:null},error:y});if(!p||!p.session||!p.user){const v=new _t;return this._returnResult({data:{user:null,session:null},error:v})}return p.session&&(await this._saveSession(p.session),await this._notifyAllSubscribers("SIGNED_IN",p.session)),this._returnResult({data:p,error:y})}catch(t){if(Q(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOtp(e){var t,r,s,a,u;try{if("email"in e){const{email:d,options:p}=e;let y=null,v=null;this.flowType==="pkce"&&([y,v]=await Ut(this.storage,this.storageKey));const{error:_}=await ee(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:d,data:(t=p?.data)!==null&&t!==void 0?t:{},create_user:(r=p?.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:p?.captchaToken},code_challenge:y,code_challenge_method:v},redirectTo:p?.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:_})}if("phone"in e){const{phone:d,options:p}=e,{data:y,error:v}=await ee(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:d,data:(s=p?.data)!==null&&s!==void 0?s:{},create_user:(a=p?.shouldCreateUser)!==null&&a!==void 0?a:!0,gotrue_meta_security:{captcha_token:p?.captchaToken},channel:(u=p?.channel)!==null&&u!==void 0?u:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:y?.message_id},error:v})}throw new pr("You must provide either an email or phone number.")}catch(d){if(await be(this.storage,`${this.storageKey}-code-verifier`),Q(d))return this._returnResult({data:{user:null,session:null},error:d});throw d}}async verifyOtp(e){var t,r;try{let s,a;"options"in e&&(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo,a=(r=e.options)===null||r===void 0?void 0:r.captchaToken);const{data:u,error:d}=await ee(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:a}}),redirectTo:s,xform:Be});if(d)throw d;if(!u)throw new Error("An error occurred on token verification.");const p=u.session,y=u.user;return p?.access_token&&(await this._saveSession(p),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",p)),this._returnResult({data:{user:y,session:p},error:null})}catch(s){if(Q(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async signInWithSSO(e){var t,r,s,a,u;try{let d=null,p=null;this.flowType==="pkce"&&([d,p]=await Ut(this.storage,this.storageKey));const y=await ee(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&r!==void 0?r:void 0}),!((s=e?.options)===null||s===void 0)&&s.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:d,code_challenge_method:p}),headers:this.headers,xform:Qc});return!((a=y.data)===null||a===void 0)&&a.url&&Ee()&&!(!((u=e.options)===null||u===void 0)&&u.skipBrowserRedirect)&&window.location.assign(y.data.url),this._returnResult(y)}catch(d){if(await be(this.storage,`${this.storageKey}-code-verifier`),Q(d))return this._returnResult({data:null,error:d});throw d}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;if(r)throw r;if(!t)throw new Pe;const{error:s}=await ee(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return this._returnResult({data:{user:null,session:null},error:s})})}catch(e){if(Q(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:r,type:s,options:a}=e,{error:u}=await ee(this.fetch,"POST",t,{headers:this.headers,body:{email:r,type:s,gotrue_meta_security:{captcha_token:a?.captchaToken}},redirectTo:a?.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:u})}else if("phone"in e){const{phone:r,type:s,options:a}=e,{data:u,error:d}=await ee(this.fetch,"POST",t,{headers:this.headers,body:{phone:r,type:s,gotrue_meta_security:{captcha_token:a?.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:u?.message_id},error:d})}throw new pr("You must provide either an email or phone number and a type")}catch(t){if(Q(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await r,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch{}})()),s}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=t();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const s=[...this.pendingInLock];await Promise.all(s),this.pendingInLock.splice(0,s.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await wt(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const r=e.expires_at?e.expires_at*1e3-Date.now()<ps:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r){if(this.userStorage){const u=await wt(this.userStorage,this.storageKey+"-user");u?.user?e.user=u.user:e.user=gs()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const u={value:this.suppressGetSessionWarning};e.user=zc(e.user,u),u.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:s,error:a}=await this._callRefreshToken(e.refresh_token);return a?this._returnResult({data:{session:null},error:a}):this._returnResult({data:{session:s},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){if(e)return await this._getUser(e);await this.initializePromise;const t=await this._acquireLock(-1,async()=>await this._getUser());return t.data.user&&(this.suppressGetSessionWarning=!0),t}async _getUser(e){try{return e?await ee(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:st}):await this._useSession(async t=>{var r,s,a;const{data:u,error:d}=t;if(d)throw d;return!(!((r=u.session)===null||r===void 0)&&r.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new Pe}:await ee(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(a=(s=u.session)===null||s===void 0?void 0:s.access_token)!==null&&a!==void 0?a:void 0,xform:st})})}catch(t){if(Q(t))return mo(t)&&(await this._removeSession(),await be(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:t});throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async r=>{const{data:s,error:a}=r;if(a)throw a;if(!s.session)throw new Pe;const u=s.session;let d=null,p=null;this.flowType==="pkce"&&e.email!=null&&([d,p]=await Ut(this.storage,this.storageKey));const{data:y,error:v}=await ee(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t?.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:d,code_challenge_method:p}),jwt:u.access_token,xform:st});if(v)throw v;return u.user=y.user,await this._saveSession(u),await this._notifyAllSubscribers("USER_UPDATED",u),this._returnResult({data:{user:u.user},error:null})})}catch(r){if(await be(this.storage,`${this.storageKey}-code-verifier`),Q(r))return this._returnResult({data:{user:null},error:r});throw r}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new Pe;const t=Date.now()/1e3;let r=t,s=!0,a=null;const{payload:u}=ys(e.access_token);if(u.exp&&(r=u.exp,s=r<=t),s){const{data:d,error:p}=await this._callRefreshToken(e.refresh_token);if(p)return this._returnResult({data:{user:null,session:null},error:p});if(!d)return{data:{user:null,session:null},error:null};a=d}else{const{data:d,error:p}=await this._getUser(e.access_token);if(p)throw p;a={access_token:e.access_token,refresh_token:e.refresh_token,user:d.user,token_type:"bearer",expires_in:r-t,expires_at:r},await this._saveSession(a),await this._notifyAllSubscribers("SIGNED_IN",a)}return this._returnResult({data:{user:a.user,session:a},error:null})}catch(t){if(Q(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var r;if(!e){const{data:u,error:d}=t;if(d)throw d;e=(r=u.session)!==null&&r!==void 0?r:void 0}if(!e?.refresh_token)throw new Pe;const{data:s,error:a}=await this._callRefreshToken(e.refresh_token);return a?this._returnResult({data:{user:null,session:null},error:a}):s?this._returnResult({data:{user:s.user,session:s},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(t){if(Q(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _getSessionFromURL(e,t){try{if(!Ee())throw new yr("No browser detected.");if(e.error||e.error_description||e.error_code)throw new yr(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new Is("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new yr("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Is("No code detected.");const{data:H,error:L}=await this._exchangeCodeForSession(e.code);if(L)throw L;const X=new URL(window.location.href);return X.searchParams.delete("code"),window.history.replaceState(window.history.state,"",X.toString()),{data:{session:H.session,redirectType:null},error:null}}const{provider_token:r,provider_refresh_token:s,access_token:a,refresh_token:u,expires_in:d,expires_at:p,token_type:y}=e;if(!a||!d||!u||!y)throw new yr("No session defined in URL");const v=Math.round(Date.now()/1e3),_=parseInt(d);let T=v+_;p&&(T=parseInt(p));const P=T-v;P*1e3<=Ft&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${P}s, should have been closer to ${_}s`);const I=T-_;v-I>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",I,T,v):v-I<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",I,T,v);const{data:D,error:B}=await this._getUser(a);if(B)throw B;const q={provider_token:r,provider_refresh_token:s,access_token:a,expires_in:_,expires_at:T,refresh_token:u,token_type:y,user:D.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:q,redirectType:e.type},error:null})}catch(r){if(Q(r))return this._returnResult({data:{session:null,redirectType:null},error:r});throw r}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await wt(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var r;const{data:s,error:a}=t;if(a)return this._returnResult({error:a});const u=(r=s.session)===null||r===void 0?void 0:r.access_token;if(u){const{error:d}=await this.admin.signOut(u,e);if(d&&!(go(d)&&(d.status===404||d.status===401||d.status===403)))return this._returnResult({error:d})}return e!=="others"&&(await this._removeSession(),await be(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const t=Ic(),r={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,r),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async t=>{var r,s;try{const{data:{session:a},error:u}=t;if(u)throw u;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",a)),this._debug("INITIAL_SESSION","callback id",e,"session",a)}catch(a){await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",a),console.error(a)}})}async resetPasswordForEmail(e,t={}){let r=null,s=null;this.flowType==="pkce"&&([r,s]=await Ut(this.storage,this.storageKey,!0));try{return await ee(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:s,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(a){if(await be(this.storage,`${this.storageKey}-code-verifier`),Q(a))return this._returnResult({data:null,error:a});throw a}}async getUserIdentities(){var e;try{const{data:t,error:r}=await this.getUser();if(r)throw r;return this._returnResult({data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(t){if(Q(t))return this._returnResult({data:null,error:t});throw t}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var t;try{const{data:r,error:s}=await this._useSession(async a=>{var u,d,p,y,v;const{data:_,error:T}=a;if(T)throw T;const P=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(u=e.options)===null||u===void 0?void 0:u.redirectTo,scopes:(d=e.options)===null||d===void 0?void 0:d.scopes,queryParams:(p=e.options)===null||p===void 0?void 0:p.queryParams,skipBrowserRedirect:!0});return await ee(this.fetch,"GET",P,{headers:this.headers,jwt:(v=(y=_.session)===null||y===void 0?void 0:y.access_token)!==null&&v!==void 0?v:void 0})});if(s)throw s;return Ee()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(r?.url),this._returnResult({data:{provider:e.provider,url:r?.url},error:null})}catch(r){if(Q(r))return this._returnResult({data:{provider:e.provider,url:null},error:r});throw r}}async linkIdentityIdToken(e){return await this._useSession(async t=>{var r;try{const{error:s,data:{session:a}}=t;if(s)throw s;const{options:u,provider:d,token:p,access_token:y,nonce:v}=e,_=await ee(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(r=a?.access_token)!==null&&r!==void 0?r:void 0,body:{provider:d,id_token:p,access_token:y,nonce:v,link_identity:!0,gotrue_meta_security:{captcha_token:u?.captchaToken}},xform:Be}),{data:T,error:P}=_;return P?this._returnResult({data:{user:null,session:null},error:P}):!T||!T.session||!T.user?this._returnResult({data:{user:null,session:null},error:new _t}):(T.session&&(await this._saveSession(T.session),await this._notifyAllSubscribers("USER_UPDATED",T.session)),this._returnResult({data:T,error:P}))}catch(s){if(await be(this.storage,`${this.storageKey}-code-verifier`),Q(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}})}async unlinkIdentity(e){try{return await this._useSession(async t=>{var r,s;const{data:a,error:u}=t;if(u)throw u;return await ee(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(s=(r=a.session)===null||r===void 0?void 0:r.access_token)!==null&&s!==void 0?s:void 0})})}catch(t){if(Q(t))return this._returnResult({data:null,error:t});throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const r=Date.now();return await Bc(async s=>(s>0&&await Dc(200*Math.pow(2,s-1)),this._debug(t,"refreshing attempt",s),await ee(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:Be})),(s,a)=>{const u=200*Math.pow(2,s);return a&&un(a)&&Date.now()+u-r<Ft})}catch(r){if(this._debug(t,"error",r),Q(r))return this._returnResult({data:{session:null,user:null},error:r});throw r}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",r),Ee()&&!t.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e,t;const r="#_recoverAndRefresh()";this._debug(r,"begin");try{const s=await wt(this.storage,this.storageKey);if(s&&this.userStorage){let u=await wt(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!u&&(u={user:s.user},await Kt(this.userStorage,this.storageKey+"-user",u)),s.user=(e=u?.user)!==null&&e!==void 0?e:gs()}else if(s&&!s.user&&!s.user){const u=await wt(this.storage,this.storageKey+"-user");u&&u?.user?(s.user=u.user,await be(this.storage,this.storageKey+"-user"),await Kt(this.storage,this.storageKey,s)):s.user=gs()}if(this._debug(r,"session from storage",s),!this._isValidSession(s)){this._debug(r,"session is not valid"),s!==null&&await this._removeSession();return}const a=((t=s.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<ps;if(this._debug(r,`session has${a?"":" not"} expired with margin of ${ps}s`),a){if(this.autoRefreshToken&&s.refresh_token){const{error:u}=await this._callRefreshToken(s.refresh_token);u&&(console.error(u),un(u)||(this._debug(r,"refresh failed with a non-retryable error, removing the session",u),await this._removeSession()))}}else if(s.user&&s.user.__isUserNotAvailableProxy===!0)try{const{data:u,error:d}=await this._getUser(s.access_token);!d&&u?.user?(s.user=u.user,await this._saveSession(s),await this._notifyAllSubscribers("SIGNED_IN",s)):this._debug(r,"could not get user data, skipping SIGNED_IN notification")}catch(u){console.error("Error getting user data:",u),this._debug(r,"error getting user data, skipping SIGNED_IN notification",u)}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(s){this._debug(r,"error",s),console.error(s);return}finally{this._debug(r,"end")}}async _callRefreshToken(e){var t,r;if(!e)throw new Pe;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const s=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(s,"begin");try{this.refreshingDeferred=new Sn;const{data:a,error:u}=await this._refreshAccessToken(e);if(u)throw u;if(!a.session)throw new Pe;await this._saveSession(a.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",a.session);const d={data:a.session,error:null};return this.refreshingDeferred.resolve(d),d}catch(a){if(this._debug(s,"error",a),Q(a)){const u={data:null,error:a};return un(a)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(u),u}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(a),a}finally{this.refreshingDeferred=null,this._debug(s,"end")}}async _notifyAllSubscribers(e,t,r=!0){const s=`#_notifyAllSubscribers(${e})`;this._debug(s,"begin",t,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:t});const a=[],u=Array.from(this.stateChangeEmitters.values()).map(async d=>{try{await d.callback(e,t)}catch(p){a.push(p)}});if(await Promise.all(u),a.length>0){for(let d=0;d<a.length;d+=1)console.error(a[d]);throw a[0]}}finally{this._debug(s,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await be(this.storage,`${this.storageKey}-code-verifier`);const t=Object.assign({},e),r=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!r&&t.user&&await Kt(this.userStorage,this.storageKey+"-user",{user:t.user});const s=Object.assign({},t);delete s.user;const a=Ji(s);await Kt(this.storage,this.storageKey,a)}else{const s=Ji(t);await Kt(this.storage,this.storageKey,s)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await be(this.storage,this.storageKey),await be(this.storage,this.storageKey+"-code-verifier"),await be(this.storage,this.storageKey+"-user"),this.userStorage&&await be(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&Ee()&&window?.removeEventListener&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),Ft);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:r}}=t;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const s=Math.floor((r.expires_at*1e3-e)/Ft);this._debug("#_autoRefreshTokenTick()",`access token expires in ${s} ticks, a tick lasts ${Ft}ms, refresh threshold is ${Rs} ticks`),s<=Rs&&await this._callRefreshToken(r.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof Ks)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!Ee()||!window?.addEventListener)return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window?.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,r){const s=[`provider=${encodeURIComponent(t)}`];if(r?.redirectTo&&s.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r?.scopes&&s.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const[a,u]=await Ut(this.storage,this.storageKey),d=new URLSearchParams({code_challenge:`${encodeURIComponent(a)}`,code_challenge_method:`${encodeURIComponent(u)}`});s.push(d.toString())}if(r?.queryParams){const a=new URLSearchParams(r.queryParams);s.push(a.toString())}return r?.skipBrowserRedirect&&s.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${s.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var r;const{data:s,error:a}=t;return a?this._returnResult({data:null,error:a}):await ee(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(Q(t))return this._returnResult({data:null,error:t});throw t}}async _enroll(e){try{return await this._useSession(async t=>{var r,s;const{data:a,error:u}=t;if(u)return this._returnResult({data:null,error:u});const d=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:p,error:y}=await ee(this.fetch,"POST",`${this.url}/factors`,{body:d,headers:this.headers,jwt:(r=a?.session)===null||r===void 0?void 0:r.access_token});return y?this._returnResult({data:null,error:y}):(e.factorType==="totp"&&p.type==="totp"&&(!((s=p?.totp)===null||s===void 0)&&s.qr_code)&&(p.totp.qr_code=`data:image/svg+xml;utf-8,${p.totp.qr_code}`),this._returnResult({data:p,error:null}))})}catch(t){if(Q(t))return this._returnResult({data:null,error:t});throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:a}=t;if(a)return this._returnResult({data:null,error:a});const u=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?hl(e.webauthn.credential_response):dl(e.webauthn.credential_response)})}:{code:e.code}),{data:d,error:p}=await ee(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:u,headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token});return p?this._returnResult({data:null,error:p}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+d.expires_in},d)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",d),this._returnResult({data:d,error:p}))})}catch(t){if(Q(t))return this._returnResult({data:null,error:t});throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:a}=t;if(a)return this._returnResult({data:null,error:a});const u=await ee(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token});if(u.error)return u;const{data:d}=u;if(d.type!=="webauthn")return{data:d,error:null};switch(d.webauthn.type){case"create":return{data:Object.assign(Object.assign({},d),{webauthn:Object.assign(Object.assign({},d.webauthn),{credential_options:Object.assign(Object.assign({},d.webauthn.credential_options),{publicKey:cl(d.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},d),{webauthn:Object.assign(Object.assign({},d.webauthn),{credential_options:Object.assign(Object.assign({},d.webauthn.credential_options),{publicKey:ll(d.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(t){if(Q(t))return this._returnResult({data:null,error:t});throw t}})}async _challengeAndVerify(e){const{data:t,error:r}=await this._challenge({factorId:e.factorId});return r?this._returnResult({data:null,error:r}):await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){var e;const{data:{user:t},error:r}=await this.getUser();if(r)return{data:null,error:r};const s={all:[],phone:[],totp:[],webauthn:[]};for(const a of(e=t?.factors)!==null&&e!==void 0?e:[])s.all.push(a),a.status==="verified"&&s[a.factor_type].push(a);return{data:s,error:null}}async _getAuthenticatorAssuranceLevel(){var e,t;const{data:{session:r},error:s}=await this.getSession();if(s)return this._returnResult({data:null,error:s});if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:a}=ys(r.access_token);let u=null;a.aal&&(u=a.aal);let d=u;((t=(e=r.user.factors)===null||e===void 0?void 0:e.filter(v=>v.status==="verified"))!==null&&t!==void 0?t:[]).length>0&&(d="aal2");const y=a.amr||[];return{data:{currentLevel:u,nextLevel:d,currentAuthenticationMethods:y},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async t=>{const{data:{session:r},error:s}=t;return s?this._returnResult({data:null,error:s}):r?await ee(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:r.access_token,xform:a=>({data:a,error:null})}):this._returnResult({data:null,error:new Pe})})}catch(t){if(Q(t))return this._returnResult({data:null,error:t});throw t}}async _approveAuthorization(e,t){try{return await this._useSession(async r=>{const{data:{session:s},error:a}=r;if(a)return this._returnResult({data:null,error:a});if(!s)return this._returnResult({data:null,error:new Pe});const u=await ee(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"approve"},xform:d=>({data:d,error:null})});return u.data&&u.data.redirect_url&&Ee()&&!t?.skipBrowserRedirect&&window.location.assign(u.data.redirect_url),u})}catch(r){if(Q(r))return this._returnResult({data:null,error:r});throw r}}async _denyAuthorization(e,t){try{return await this._useSession(async r=>{const{data:{session:s},error:a}=r;if(a)return this._returnResult({data:null,error:a});if(!s)return this._returnResult({data:null,error:new Pe});const u=await ee(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"deny"},xform:d=>({data:d,error:null})});return u.data&&u.data.redirect_url&&Ee()&&!t?.skipBrowserRedirect&&window.location.assign(u.data.redirect_url),u})}catch(r){if(Q(r))return this._returnResult({data:null,error:r});throw r}}async _listOAuthGrants(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;return r?this._returnResult({data:null,error:r}):t?await ee(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:t.access_token,xform:s=>({data:s,error:null})}):this._returnResult({data:null,error:new Pe})})}catch(e){if(Q(e))return this._returnResult({data:null,error:e});throw e}}async _revokeOAuthGrant(e){try{return await this._useSession(async t=>{const{data:{session:r},error:s}=t;return s?this._returnResult({data:null,error:s}):r?(await ee(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:r.access_token,query:{client_id:e.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new Pe})})}catch(t){if(Q(t))return this._returnResult({data:null,error:t});throw t}}async fetchJwk(e,t={keys:[]}){let r=t.keys.find(d=>d.kid===e);if(r)return r;const s=Date.now();if(r=this.jwks.keys.find(d=>d.kid===e),r&&this.jwks_cached_at+kc>s)return r;const{data:a,error:u}=await ee(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(u)throw u;return!a.keys||a.keys.length===0||(this.jwks=a,this.jwks_cached_at=s,r=a.keys.find(d=>d.kid===e),!r)?null:r}async getClaims(e,t={}){try{let r=e;if(!r){const{data:P,error:I}=await this.getSession();if(I||!P.session)return this._returnResult({data:null,error:I});r=P.session.access_token}const{header:s,payload:a,signature:u,raw:{header:d,payload:p}}=ys(r);t?.allowExpired||Mc(a.exp);const y=!s.alg||s.alg.startsWith("HS")||!s.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(s.kid,t?.keys?{keys:t.keys}:t?.jwks);if(!y){const{error:P}=await this.getUser(r);if(P)throw P;return{data:{claims:a,header:s,signature:u},error:null}}const v=Vc(s.alg),_=await crypto.subtle.importKey("jwk",y,v,!0,["verify"]);if(!await crypto.subtle.verify(v,_,u,Rc(`${d}.${p}`)))throw new gn("Invalid JWT signature");return{data:{claims:a,header:s,signature:u},error:null}}catch(r){if(Q(r))return this._returnResult({data:null,error:r});throw r}}};Ms.nextInstanceID={};const bl=Fs,El=Ms,Sl=Object.freeze(Object.defineProperty({__proto__:null,AuthAdminApi:bl,AuthApiError:yo,AuthClient:El,AuthError:Ht,AuthImplicitGrantRedirectError:yr,AuthInvalidCredentialsError:pr,AuthInvalidJwtError:gn,AuthInvalidTokenResponseError:_t,AuthPKCEGrantCodeExchangeError:Is,AuthRetryableFetchError:yn,AuthSessionMissingError:Pe,AuthUnknownError:nt,AuthWeakPasswordError:xs,CustomAuthError:Je,GoTrueAdminApi:Fs,GoTrueClient:Ms,NavigatorLockAcquireTimeoutError:Eo,SIGN_OUT_SCOPES:cn,isAuthApiError:go,isAuthError:Q,isAuthImplicitGrantRedirectError:vo,isAuthRetryableFetchError:un,isAuthSessionMissingError:mo,isAuthWeakPasswordError:Oc,lockInternals:Et,navigatorLock:So,processLock:el},Symbol.toStringTag,{value:"Module"})),To=vr(Sl);var na;function kl(){if(na)return dr;na=1,Object.defineProperty(dr,"__esModule",{value:!0}),dr.SupabaseAuthClient=void 0;const i=To;let e=class extends i.AuthClient{constructor(r){super(r)}};return dr.SupabaseAuthClient=e,dr}var sa;function ia(){if(sa)return Jr;sa=1,Object.defineProperty(Jr,"__esModule",{value:!0});const i=Ua,e=Va(),t=Xa,r=yc,s=mc(),a=vc(),u=wc(),d=kl();class p{constructor(v,_,T){var P,I,D;this.supabaseUrl=v,this.supabaseKey=_;const B=(0,u.validateSupabaseUrl)(v);if(!_)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",B),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",B),this.storageUrl=new URL("storage/v1",B),this.functionsUrl=new URL("functions/v1",B);const q=`sb-${B.hostname.split(".")[0]}-auth-token`,H={db:s.DEFAULT_DB_OPTIONS,realtime:s.DEFAULT_REALTIME_OPTIONS,auth:Object.assign(Object.assign({},s.DEFAULT_AUTH_OPTIONS),{storageKey:q}),global:s.DEFAULT_GLOBAL_OPTIONS},L=(0,u.applySettingDefaults)(T??{},H);this.storageKey=(P=L.auth.storageKey)!==null&&P!==void 0?P:"",this.headers=(I=L.global.headers)!==null&&I!==void 0?I:{},L.accessToken?(this.accessToken=L.accessToken,this.auth=new Proxy({},{get:(X,ce)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(ce)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((D=L.auth)!==null&&D!==void 0?D:{},this.headers,L.global.fetch),this.fetch=(0,a.fetchWithAuth)(_,this._getAccessToken.bind(this),L.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},L.realtime)),this.accessToken&&this.accessToken().then(X=>this.realtime.setAuth(X)).catch(X=>console.warn("Failed to set initial Realtime auth token:",X)),this.rest=new e.PostgrestClient(new URL("rest/v1",B).href,{headers:this.headers,schema:L.db.schema,fetch:this.fetch}),this.storage=new r.StorageClient(this.storageUrl.href,this.headers,this.fetch,T?.storage),L.accessToken||this._listenForAuthEvents()}get functions(){return new i.FunctionsClient(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(v){return this.rest.from(v)}schema(v){return this.rest.schema(v)}rpc(v,_={},T={head:!1,get:!1,count:void 0}){return this.rest.rpc(v,_,T)}channel(v,_={config:{}}){return this.realtime.channel(v,_)}getChannels(){return this.realtime.getChannels()}removeChannel(v){return this.realtime.removeChannel(v)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var v,_;if(this.accessToken)return await this.accessToken();const{data:T}=await this.auth.getSession();return(_=(v=T.session)===null||v===void 0?void 0:v.access_token)!==null&&_!==void 0?_:this.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:v,persistSession:_,detectSessionInUrl:T,storage:P,userStorage:I,storageKey:D,flowType:B,lock:q,debug:H,throwOnError:L},X,ce){const se={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new d.SupabaseAuthClient({url:this.authUrl.href,headers:Object.assign(Object.assign({},se),X),storageKey:D,autoRefreshToken:v,persistSession:_,detectSessionInUrl:T,storage:P,userStorage:I,flowType:B,lock:q,debug:H,throwOnError:L,fetch:ce,hasCustomAuthorizationHeader:Object.keys(this.headers).some(ae=>ae.toLowerCase()==="authorization")})}_initRealtimeClient(v){return new t.RealtimeClient(this.realtimeUrl.href,Object.assign(Object.assign({},v),{params:Object.assign({apikey:this.supabaseKey},v?.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((_,T)=>{this._handleTokenChanged(_,"CLIENT",T?.access_token)})}_handleTokenChanged(v,_,T){(v==="TOKEN_REFRESHED"||v==="SIGNED_IN")&&this.changedAccessToken!==T?(this.changedAccessToken=T,this.realtime.setAuth(T)):v==="SIGNED_OUT"&&(this.realtime.setAuth(),_=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}return Jr.default=p,Jr}var aa;function Ol(){return aa||(aa=1,(function(i){var e=He&&He.__createBinding||(Object.create?(function(v,_,T,P){P===void 0&&(P=T);var I=Object.getOwnPropertyDescriptor(_,T);(!I||("get"in I?!_.__esModule:I.writable||I.configurable))&&(I={enumerable:!0,get:function(){return _[T]}}),Object.defineProperty(v,P,I)}):(function(v,_,T,P){P===void 0&&(P=T),v[P]=_[T]})),t=He&&He.__exportStar||function(v,_){for(var T in v)T!=="default"&&!Object.prototype.hasOwnProperty.call(_,T)&&e(_,v,T)},r=He&&He.__importDefault||function(v){return v&&v.__esModule?v:{default:v}};Object.defineProperty(i,"__esModule",{value:!0}),i.createClient=i.SupabaseClient=i.FunctionRegion=i.FunctionsError=i.FunctionsRelayError=i.FunctionsFetchError=i.FunctionsHttpError=i.PostgrestError=void 0;const s=r(ia());t(To,i);var a=Va();Object.defineProperty(i,"PostgrestError",{enumerable:!0,get:function(){return a.PostgrestError}});var u=Ua;Object.defineProperty(i,"FunctionsHttpError",{enumerable:!0,get:function(){return u.FunctionsHttpError}}),Object.defineProperty(i,"FunctionsFetchError",{enumerable:!0,get:function(){return u.FunctionsFetchError}}),Object.defineProperty(i,"FunctionsRelayError",{enumerable:!0,get:function(){return u.FunctionsRelayError}}),Object.defineProperty(i,"FunctionsError",{enumerable:!0,get:function(){return u.FunctionsError}}),Object.defineProperty(i,"FunctionRegion",{enumerable:!0,get:function(){return u.FunctionRegion}}),t(Xa,i);var d=ia();Object.defineProperty(i,"SupabaseClient",{enumerable:!0,get:function(){return r(d).default}});const p=(v,_,T)=>new s.default(v,_,T);i.createClient=p;function y(){if(typeof window<"u"||typeof process>"u")return!1;const v=process.version;if(v==null)return!1;const _=v.match(/^v(\d+)\./);return _?parseInt(_[1],10)<=18:!1}y()&&console.warn("â ï¸  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217")})(He)),He}var Ao=Ol();const Po=ua(Ao),Tl=cu({__proto__:null,default:Po},[Ao]),{PostgrestError:lh,FunctionsHttpError:hh,FunctionsFetchError:dh,FunctionsRelayError:fh,FunctionsError:ph,FunctionRegion:yh,SupabaseClient:gh,createClient:Al,GoTrueAdminApi:mh,GoTrueClient:vh,AuthAdminApi:wh,AuthClient:_h,navigatorLock:bh,NavigatorLockAcquireTimeoutError:Eh,lockInternals:Sh,processLock:kh,SIGN_OUT_SCOPES:Oh,AuthError:Th,AuthApiError:Ah,AuthUnknownError:Ph,CustomAuthError:Ch,AuthSessionMissingError:Rh,AuthInvalidTokenResponseError:jh,AuthInvalidCredentialsError:Ih,AuthImplicitGrantRedirectError:xh,AuthPKCEGrantCodeExchangeError:$h,AuthRetryableFetchError:Dh,AuthWeakPasswordError:Bh,AuthInvalidJwtError:Nh,isAuthError:Uh,isAuthApiError:Lh,isAuthSessionMissingError:qh,isAuthImplicitGrantRedirectError:Fh,isAuthRetryableFetchError:Kh,isAuthWeakPasswordError:Mh,RealtimePresence:Vh,RealtimeChannel:Wh,RealtimeClient:zh,REALTIME_LISTEN_TYPES:Hh,REALTIME_POSTGRES_CHANGES_LISTEN_EVENT:Gh,REALTIME_PRESENCE_LISTEN_EVENTS:Jh,REALTIME_SUBSCRIBE_STATES:Qh,REALTIME_CHANNEL_STATES:Yh}=Po||Tl;class oa{constructor(e){this.config=e,this.supabase=null,this.currentUser=null,this.currentSession=null,this.initialized=!1}async initialize(){if(!this.initialized)try{this.supabase=Al(this.config.supabaseUrl,this.config.supabaseKey);const{data:{session:e},error:t}=await this.supabase.auth.getSession();t?console.warn("Error obteniendo sesiÃ³n:",t.message):e&&(this.currentSession=e,this.currentUser=e.user,console.log("â SesiÃ³n existente restaurada")),this.supabase.auth.onAuthStateChange((r,s)=>{console.log("ð Auth state change:",r),this.currentSession=s,this.currentUser=s?.user||null}),this.initialized=!0,console.log("â AuthService inicializado")}catch(e){throw console.error("â Error inicializando AuthService:",e),e}}async signIn(e,t){if(!this.supabase)throw new Error("AuthService no estÃ¡ inicializado");try{const{data:r,error:s}=await this.supabase.auth.signInWithPassword({email:e,password:t});return s?{user:null,session:null,error:new Error(s.message)}:(this.currentUser=r.user,this.currentSession=r.session,{user:r.user,session:r.session,error:null})}catch(r){return{user:null,session:null,error:r instanceof Error?r:new Error("Error desconocido en signIn")}}}async signUp(e,t,r){if(!this.supabase)throw new Error("AuthService no estÃ¡ inicializado");try{const{data:s,error:a}=await this.supabase.auth.signUp({email:e,password:t,options:r});return a?{user:null,session:null,error:new Error(a.message)}:(this.currentUser=s.user,this.currentSession=s.session,{user:s.user,session:s.session,error:null})}catch(s){return{user:null,session:null,error:s instanceof Error?s:new Error("Error desconocido en signUp")}}}async signOut(){if(!this.supabase)throw new Error("AuthService no estÃ¡ inicializado");try{const{error:e}=await this.supabase.auth.signOut();return e?{error:new Error(e.message)}:(this.currentUser=null,this.currentSession=null,{error:null})}catch(e){return{error:e instanceof Error?e:new Error("Error desconocido en signOut")}}}getCurrentUser(){return this.currentUser}getCurrentSession(){return this.currentSession}isAuthenticated(){return this.currentUser!==null&&this.currentSession!==null}getAccessToken(){return this.currentSession?.access_token||null}async refreshSession(){if(!this.supabase)throw new Error("AuthService no estÃ¡ inicializado");try{const{data:e,error:t}=await this.supabase.auth.refreshSession();return t?{user:null,session:null,error:new Error(t.message)}:(this.currentUser=e.user,this.currentSession=e.session,{user:e.user,session:e.session,error:null})}catch(e){return{user:null,session:null,error:e instanceof Error?e:new Error("Error desconocido en refreshSession")}}}isInitialized(){return this.initialized}getSupabaseClient(){return this.supabase}}class Pl{async calculateChecksum(e){try{const t=JSON.stringify(this.canonicalize(e)),s=new TextEncoder().encode(t),a=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(a)).map(p=>p.toString(16).padStart(2,"0")).join("")}catch(t){throw console.error("Error calculando checksum:",t),new Error(`FallÃ³ el cÃ¡lculo de checksum: ${t}`)}}canonicalize(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(s=>this.canonicalize(s));const t={},r=Object.keys(e).sort();for(const s of r)s!=="checksum"&&(t[s]=this.canonicalize(e[s]));return t}async calculatePagoChecksum(e){const t={id:e.id,tenant_id:e.tenant_id,credito_id:e.credito_id,cliente_id:e.cliente_id,cobrador_id:e.cobrador_id,monto:e.monto,fecha:e.fecha,latitud:e.latitud,longitud:e.longitud,observaciones:e.observaciones,created_at:e.created_at,created_by:e.created_by,device_id:e.device_id};return this.calculateChecksum(t)}async calculateCreditoChecksum(e){const t={id:e.id,tenant_id:e.tenant_id,cliente_id:e.cliente_id,producto_id:e.producto_id,monto_original:e.monto_original,interes_porcentaje:e.interes_porcentaje,total_a_pagar:e.total_a_pagar,numero_cuotas:e.numero_cuotas,fecha_desembolso:e.fecha_desembolso,created_at:e.created_at,created_by:e.created_by};return this.calculateChecksum(t)}async calculateClienteChecksum(e){const t={id:e.id,tenant_id:e.tenant_id,numero_documento:e.numero_documento,nombre:e.nombre,created_at:e.created_at,created_by:e.created_by};return this.calculateChecksum(t)}async verifyPagoChecksum(e){const t=e.checksum,r=await this.calculatePagoChecksum(e);return{valid:t===r,expected:t,actual:r,corrupted:t!==r}}async verifyCreditoChecksum(e){const t=e.checksum,r=await this.calculateCreditoChecksum(e);return{valid:t===r,expected:t,actual:r,corrupted:t!==r}}async verifyClienteChecksum(e){const t=e.checksum,r=await this.calculateClienteChecksum(e);return{valid:t===r,expected:t,actual:r,corrupted:t!==r}}async storeChecksum(e,t,r,s){if(!s)throw new Error("Base de datos requerida para almacenar checksum");const a={record_key:`${e}:${t}`,checksum:r,timestamp:Date.now()};await s.checksums.put(a)}async getStoredChecksum(e,t,r){if(!r)throw new Error("Base de datos requerida para recuperar checksum");return(await r.checksums.get(`${e}:${t}`))?.checksum||null}async performIntegrityCheck(e){if(!e)throw new Error("Base de datos requerida para verificaciÃ³n de integridad");const t={total:0,valid:0,corrupted:0,missing:0,repaired:0,errors:[]};try{const r=await this.checkPagosIntegrity(e);t.total+=r.total,t.valid+=r.valid,t.corrupted+=r.corrupted,t.missing+=r.missing,t.repaired+=r.repaired,t.errors.push(...r.errors);const s=await this.checkCreditosIntegrity(e);t.total+=s.total,t.valid+=s.valid,t.corrupted+=s.corrupted,t.missing+=s.missing,t.repaired+=s.repaired,t.errors.push(...s.errors);const a=await this.checkClientesIntegrity(e);t.total+=a.total,t.valid+=a.valid,t.corrupted+=a.corrupted,t.missing+=a.missing,t.repaired+=a.repaired,t.errors.push(...a.errors),console.log("â VerificaciÃ³n de integridad completada:",t)}catch(r){console.error("â VerificaciÃ³n de integridad fallÃ³:",r),t.errors.push({recordType:"system",recordId:"integrity_check",error:`VerificaciÃ³n de integridad fallÃ³: ${r}`,timestamp:Date.now()})}return t}async checkPagosIntegrity(e){const t={total:0,valid:0,corrupted:0,missing:0,repaired:0,errors:[]},r=await e.pagos.toArray();t.total=r.length;for(const s of r)try{if(!s.checksum){t.missing++;const u=await this.calculatePagoChecksum(s);await e.pagos.update(s.id,{checksum:u}),t.repaired++;continue}const a=await this.verifyPagoChecksum(s);a.valid?t.valid++:(t.corrupted++,t.errors.push({recordType:"pago",recordId:s.id,error:`Checksum no coincide: esperado ${a.expected}, obtenido ${a.actual}`,timestamp:Date.now()}))}catch(a){t.errors.push({recordType:"pago",recordId:s.id,error:`VerificaciÃ³n fallÃ³: ${a}`,timestamp:Date.now()})}return t}async checkCreditosIntegrity(e){const t={total:0,valid:0,corrupted:0,missing:0,repaired:0,errors:[]},r=await e.creditos.toArray();t.total=r.length;for(const s of r)try{if(!s.checksum){t.missing++;const u=await this.calculateCreditoChecksum(s);await e.creditos.update(s.id,{checksum:u}),t.repaired++;continue}const a=await this.verifyCreditoChecksum(s);a.valid?t.valid++:(t.corrupted++,t.errors.push({recordType:"credito",recordId:s.id,error:`Checksum no coincide: esperado ${a.expected}, obtenido ${a.actual}`,timestamp:Date.now()}))}catch(a){t.errors.push({recordType:"credito",recordId:s.id,error:`VerificaciÃ³n fallÃ³: ${a}`,timestamp:Date.now()})}return t}async checkClientesIntegrity(e){const t={total:0,valid:0,corrupted:0,missing:0,repaired:0,errors:[]},r=await e.clientes.toArray();t.total=r.length;for(const s of r)try{if(!s.checksum){t.missing++;const u=await this.calculateClienteChecksum(s);await e.clientes.update(s.id,{checksum:u}),t.repaired++;continue}const a=await this.verifyClienteChecksum(s);a.valid?t.valid++:(t.corrupted++,t.errors.push({recordType:"cliente",recordId:s.id,error:`Checksum no coincide: esperado ${a.expected}, obtenido ${a.actual}`,timestamp:Date.now()}))}catch(a){t.errors.push({recordType:"cliente",recordId:s.id,error:`VerificaciÃ³n fallÃ³: ${a}`,timestamp:Date.now()})}return t}startPeriodicChecks(e,t=300*1e3){return console.log(`ð Iniciando verificaciones periÃ³dicas de integridad cada ${t/1e3} segundos`),setInterval(async()=>{console.log("ð Ejecutando verificaciÃ³n periÃ³dica de integridad...");const r=await this.performIntegrityCheck(e);r.corrupted>0&&console.warn(`â ï¸ Se encontraron ${r.corrupted} registros corruptos`),r.repaired>0&&console.log(`â Se repararon ${r.repaired} registros`)},t)}stopPeriodicChecks(e){clearInterval(e),console.log("ð Se detuvieron las verificaciones periÃ³dicas de integridad")}}function Xh(i){const t={...{appName:"sync-app",encryptionEnabled:!0,auditEnabled:!0,syncInterval:3e4,databaseName:void 0,logLevel:"info"},...i},r=yu(),s=new Pl,a=new ca(r),u=new ha,d=new la(r),p=new gu(r),y=new mu(r),v=Mt.getInstance(r),_=Ne.getInstance();let T;if(t.supabase?.url&&t.supabase?.anonKey)T=new oa({supabaseUrl:t.supabase.url,supabaseKey:t.supabase.anonKey});else if(t.supabaseUrl&&t.supabaseKey)T=new oa({supabaseUrl:t.supabaseUrl,supabaseKey:t.supabaseKey});else throw new Error("ConfiguraciÃ³n de Supabase requerida para el servicio de autenticaciÃ³n");p.setDatabase(r),y.setDatabase(r),v.setDatabase(r);const P={db:r,checksum:s,sync:p,syncQueue:a,conflictResolver:u,changeTracker:d,storage:y,audit:v,encryption:_,auth:T};let I=!1,D=null;const B={services:P,config:t,isStarted:!1,async start(){if(I){console.warn(`â ï¸ ${t.appName} ya estÃ¡ iniciado`);return}try{console.log(`ð Iniciando ${t.appName}...`),await r.initialize(),console.log("â Base de datos inicializada"),await T.initialize(),console.log("â Servicio de autenticaciÃ³n inicializado"),t.encryptionEnabled&&console.log("ð EncriptaciÃ³n habilitada (requiere PIN del usuario)"),t.auditEnabled&&console.log("ð Sistema de auditorÃ­a habilitado"),(t.supabase?.url||t.supabaseUrl)&&t.syncInterval&&(D=setInterval(async()=>{try{p.isOnline()&&!p.isCurrentlySyncing()&&await p.sync()}catch(q){console.error("Error en sincronizaciÃ³n automÃ¡tica:",q)}},t.syncInterval),console.log(`ð SincronizaciÃ³n automÃ¡tica cada ${t.syncInterval}ms`)),I=!0,B.isStarted=!0,console.log(`â ${t.appName} iniciado exitosamente`)}catch(q){throw console.error(`â Error iniciando ${t.appName}:`,q),q}},async stop(){if(!I){console.warn(`â ï¸ ${t.appName} no estÃ¡ iniciado`);return}try{console.log(`ð Deteniendo ${t.appName}...`),D&&(clearInterval(D),D=null,console.log("ð SincronizaciÃ³n automÃ¡tica detenida")),p.isCurrentlySyncing()&&(await p.cancelSync(),console.log("ð« SincronizaciÃ³n en curso cancelada")),t.encryptionEnabled&&(_.clearEncryptionKey(),console.log("ð§¹ Claves de encriptaciÃ³n limpiadas")),await r.close(),console.log("ðï¸ Base de datos cerrada"),I=!1,B.isStarted=!1,console.log(`â ${t.appName} detenido exitosamente`)}catch(q){throw console.error(`â Error deteniendo ${t.appName}:`,q),q}},async getStatus(){const q=await a.getQueueSize(),H=await r.getStats();return{isStarted:I,isOnline:p.isOnline(),isSyncing:p.isCurrentlySyncing(),queueSize:q,lastSync:p.getLastSyncTimestamp(),encryptionReady:_.isInitialized(),dbStats:H}},async clearData(){if(I)throw new Error("No se puede limpiar datos mientras la aplicaciÃ³n estÃ¡ iniciada");console.log("ð§¹ Limpiando todos los datos..."),await r.clearAll(),await y.clearBackups(),console.log("â Todos los datos limpiados")}};return B}export{Xh as c};
