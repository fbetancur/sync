import A from"dexie";import{createClient as k}from"@supabase/supabase-js";class T extends A{constructor(){super("microcreditos_db"),this.version(1).stores({tenants:"id, nombre, activo",users:"id, tenant_id, email, [tenant_id+activo]",rutas:"id, tenant_id, nombre, activa, [tenant_id+activa]",productos_credito:"id, tenant_id, activo, [tenant_id+activo]",clientes:`
        id,
        tenant_id,
        ruta_id,
        numero_documento,
        estado,
        [tenant_id+ruta_id],
        [tenant_id+estado],
        [tenant_id+numero_documento]
      `,creditos:`
        id,
        tenant_id,
        cliente_id,
        cobrador_id,
        ruta_id,
        estado,
        [tenant_id+estado],
        [cliente_id+estado],
        [cobrador_id+estado],
        [tenant_id+ruta_id+estado]
      `,cuotas:`
        id,
        credito_id,
        tenant_id,
        numero,
        estado,
        fecha_programada,
        [credito_id+numero],
        [credito_id+estado],
        [tenant_id+estado+fecha_programada]
      `,pagos:`
        id,
        tenant_id,
        credito_id,
        cliente_id,
        cobrador_id,
        fecha,
        synced,
        [tenant_id+fecha],
        [credito_id+fecha],
        [cobrador_id+fecha],
        [synced+fecha]
      `,sync_queue:`
        ++id,
        timestamp,
        table_name,
        record_id,
        operation,
        synced,
        priority,
        [synced+priority+timestamp]
      `,audit_log:`
        ++id,
        timestamp,
        sequence,
        event_type,
        aggregate_type,
        aggregate_id,
        user_id,
        [aggregate_type+aggregate_id+timestamp],
        [user_id+timestamp]
      `,change_log:`
        ++id,
        timestamp,
        table_name,
        record_id,
        synced,
        [synced+timestamp],
        [table_name+record_id]
      `,checksums:"record_key, checksum, timestamp",app_state:"key, value, updated_at"})}async initialize(){try{if(!("indexedDB"in window))throw new Error("IndexedDB no est√° soportado en este navegador");await this.open(),console.log("‚úÖ IndexedDB inicializado exitosamente")}catch(e){throw console.error("‚ùå Fall√≥ la inicializaci√≥n de IndexedDB:",e),e}}async getStats(){return{tenants:await this.tenants.count(),users:await this.users.count(),rutas:await this.rutas.count(),productos_credito:await this.productos_credito.count(),clientes:await this.clientes.count(),creditos:await this.creditos.count(),cuotas:await this.cuotas.count(),pagos:await this.pagos.count(),sync_queue:await this.sync_queue.count(),audit_log:await this.audit_log.count(),change_log:await this.change_log.count(),checksums:await this.checksums.count(),app_state:await this.app_state.count()}}async clearAll(){await this.transaction("rw",[this.tenants,this.users,this.rutas,this.productos_credito,this.clientes,this.creditos,this.cuotas,this.pagos,this.sync_queue,this.audit_log,this.change_log,this.checksums,this.app_state],async()=>{await this.tenants.clear(),await this.users.clear(),await this.rutas.clear(),await this.productos_credito.clear(),await this.clientes.clear(),await this.creditos.clear(),await this.cuotas.clear(),await this.pagos.clear(),await this.sync_queue.clear(),await this.audit_log.clear(),await this.change_log.clear(),await this.checksums.clear(),await this.app_state.clear()}),console.log("‚úÖ Todos los datos limpiados de IndexedDB")}}function I(g){return new T}class v{constructor(e){this.MAX_ATTEMPTS=10,this.INITIAL_BACKOFF_MS=1e3,this.MAX_BACKOFF_MS=3e5,this.db=e}setDatabase(e){this.db=e}async addToQueue(e,t,a,r={}){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");const{priority:s=this.getDefaultPriority(e),data:n=null}=r,i={timestamp:Date.now(),table_name:e,record_id:t,operation:a,data:n,synced:!1,priority:s,attempts:0,last_attempt:null,error:null};return await this.db.sync_queue.add(i)}async getPendingOperations(e){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");const a=(await this.db.sync_queue.toArray()).filter(r=>{if(r.synced)return!1;if(r.attempts===0)return!0;if(r.attempts>=this.MAX_ATTEMPTS)return!1;const s=this.calculateBackoff(r.attempts),n=(r.last_attempt||0)+s;return Date.now()>=n});return a.sort((r,s)=>r.priority!==s.priority?r.priority-s.priority:r.timestamp-s.timestamp),e?a.slice(0,e):a}async markAsSynced(e){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");await this.db.sync_queue.update(e,{synced:!0,error:null})}async markAsFailed(e,t){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");const a=await this.db.sync_queue.get(e);a&&await this.db.sync_queue.update(e,{attempts:a.attempts+1,last_attempt:Date.now(),error:t})}async getStats(){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");const e=await this.db.sync_queue.toArray(),t=e.filter(n=>!n.synced&&n.attempts<this.MAX_ATTEMPTS),a=e.filter(n=>n.synced),r=e.filter(n=>!n.synced&&n.attempts>=this.MAX_ATTEMPTS),s=t.length>0?Math.min(...t.map(n=>n.timestamp)):null;return{total:e.length,pending:t.length,synced:a.length,failed:r.length,oldestPending:s}}async getQueueSize(){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");return await this.db.sync_queue.filter(e=>!e.synced&&e.attempts<this.MAX_ATTEMPTS).count()}async getFailedOperations(){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");return await this.db.sync_queue.filter(e=>!e.synced&&e.attempts>=this.MAX_ATTEMPTS).toArray()}async retryFailedOperation(e){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");await this.db.sync_queue.update(e,{attempts:0,last_attempt:null,error:null})}async clearOldSyncedOperations(e=7){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");const t=Date.now()-e*24*60*60*1e3,r=(await this.db.sync_queue.filter(s=>s.synced&&s.timestamp<t).toArray()).map(s=>s.id);return await this.db.sync_queue.bulkDelete(r),r.length}async clearAll(){if(!this.db)throw new Error("Base de datos no configurada en SyncQueue");await this.db.sync_queue.clear()}calculateBackoff(e){const t=this.INITIAL_BACKOFF_MS*Math.pow(2,e-1);return Math.min(t,this.MAX_BACKOFF_MS)}getDefaultPriority(e){switch(e){case"pagos":return 1;case"creditos":case"cuotas":return 2;case"clientes":return 3;default:return 4}}getNextRetryTime(e){if(e.attempts===0)return Date.now();if(e.attempts>=this.MAX_ATTEMPTS)return null;const t=this.calculateBackoff(e.attempts);return(e.last_attempt||0)+t}isReadyToRetry(e){if(e.synced||e.attempts>=this.MAX_ATTEMPTS)return!1;if(e.attempts===0)return!0;const t=this.getNextRetryTime(e);return t!==null&&Date.now()>=t}}class S{constructor(e){this.db=e}setDatabase(e){this.db=e}async getAllPendingChanges(){if(!this.db)throw new Error("Base de datos no configurada en ChangeTracker");return await this.db.change_log.filter(e=>!e.synced).toArray()}async compressChanges(e){return e}async createUploadBatches(e){const t=e.reduce((r,s)=>(r[s.table_name]||(r[s.table_name]=[]),r[s.table_name].push(s),r),{}),a=[];for(const[r,s]of Object.entries(t))a.push({table:r,priority:this.getTablePriority(r),changes:s});return a.sort((r,s)=>r.priority-s.priority),a}async applyDeltas(e){console.log("Aplicando deltas:",e.length)}getTablePriority(e){switch(e){case"pagos":return 1;case"creditos":case"cuotas":return 2;case"clientes":return 3;default:return 4}}}class E{resolveConflict(e,t,a){return a==="pago"?{resolved:e,strategy:"append_only",conflicts_detected:[],metadata:{}}:this.resolveCRDT(e,t)}resolveCRDT(e,t){const a=e.version_vector||{},r=t.version_vector||{},s=this.dominatesVector(a,r),n=this.dominatesVector(r,a);return s&&!n?{resolved:e,strategy:"local_wins",conflicts_detected:[],metadata:{local_version:a,remote_version:r}}:n&&!s?{resolved:t,strategy:"remote_wins",conflicts_detected:[],metadata:{local_version:a,remote_version:r}}:this.mergeFields(e,t)}mergeFields(e,t){const a={...e},r=[],s=[],n=e.field_versions||{},i=t.field_versions||{},c=new Set([...Object.keys(n),...Object.keys(i)]);for(const d of c){const u=n[d],o=i[d];if(!o)a[d]=u?.value;else if(!u)a[d]=o.value,s.push(d);else{const l=this.resolveFieldConflict(u,o);a[d]=l.value,l!==u&&s.push(d),u.timestamp===o.timestamp&&r.push(d)}}a.field_versions={};for(const d of c){const u=n[d],o=i[d];u&&o?a.field_versions[d]=this.resolveFieldConflict(u,o):a.field_versions[d]=u||o}return a.version_vector=this.mergeVersionVectors(e.version_vector||{},t.version_vector||{}),{resolved:a,strategy:"merged",conflicts_detected:r,metadata:{local_version:e.version_vector,remote_version:t.version_vector,merged_fields:s}}}resolveFieldConflict(e,t){return e.timestamp>t.timestamp?e:t.timestamp>e.timestamp?t:e.device_id>t.device_id?e:t}dominatesVector(e,t){let a=!1;for(const r in t){const s=e[r]||0,n=t[r];if(s<n)return!1;s>n&&(a=!0)}for(const r in e)!(r in t)&&e[r]>0&&(a=!0);return a}mergeVersionVectors(e,t){const a={...e};for(const r in t)a[r]=Math.max(a[r]||0,t[r]);return a}incrementVersion(e,t){return{...e,[t]:(e[t]||0)+1}}createFieldVersion(e,t,a=Date.now()){return{value:e,timestamp:a,device_id:t}}updateRecord(e,t,a){const r=Date.now(),s={...e};s.field_versions||(s.field_versions={});for(const[n,i]of Object.entries(t))s[n]=i,s.field_versions[n]=this.createFieldVersion(i,a,r);return s.version_vector=this.incrementVersion(s.version_vector||{},a),s.updated_at=r,s}areConcurrent(e,t){const a=e.version_vector||{},r=t.version_vector||{},s=this.dominatesVector(a,r),n=this.dominatesVector(r,a);return!s&&!n}}class B{constructor(e){this.isSyncing=!1,this.lastSyncTimestamp=0,this.syncAbortController=null,this.db=e,this.syncQueue=new v(e),this.changeTracker=new S(e),this.conflictResolver=new E}setDatabase(e){this.db=e,this.syncQueue.setDatabase(e),this.changeTracker.setDatabase(e)}getConnectionStatus(){if(typeof navigator>"u"||!navigator.onLine)return{online:!1,type:"none",effectiveType:"unknown"};const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return{online:navigator.onLine,type:e?.type||"unknown",effectiveType:e?.effectiveType||"unknown"}}isOnline(){return this.getConnectionStatus().online}isCurrentlySyncing(){return this.isSyncing}getLastSyncTimestamp(){return this.lastSyncTimestamp}async getQueueSize(){return await this.syncQueue.getQueueSize()}async getPendingOperations(){return await this.syncQueue.getPendingOperations()}async cancelSync(){this.syncAbortController&&(this.syncAbortController.abort(),this.syncAbortController=null),this.isSyncing=!1}async sync(e={}){if(this.isSyncing&&!e.force)return{success:!1,uploaded:0,downloaded:0,conflicts:0,errors:["Sincronizaci√≥n ya en progreso"],timestamp:Date.now()};if(!this.isOnline())return{success:!1,uploaded:0,downloaded:0,conflicts:0,errors:["Sin conexi√≥n a internet"],timestamp:Date.now()};this.isSyncing=!0,this.syncAbortController=new AbortController;const t={success:!0,uploaded:0,downloaded:0,conflicts:0,errors:[],timestamp:Date.now()};try{e.onProgress?.({phase:"upload",current:0,total:100,message:"Subiendo cambios locales..."}),t.uploaded=await this.syncUpload(e),e.onProgress?.({phase:"download",current:50,total:100,message:"Descargando cambios remotos..."});const a=await this.syncDownload(e);t.downloaded=a.downloaded,t.conflicts=a.conflicts,e.onProgress?.({phase:"verify",current:90,total:100,message:"Verificando integridad..."}),await this.verifyIntegrity(),e.onProgress?.({phase:"complete",current:100,total:100,message:"Sincronizaci√≥n completada"}),this.lastSyncTimestamp=Date.now(),await this.updateLastSyncTimestamp()}catch(a){t.success=!1,t.errors.push(a instanceof Error?a.message:"Error desconocido")}finally{this.isSyncing=!1,this.syncAbortController=null}return t}async syncUpload(e={}){let t=0;try{const a=await this.changeTracker.getAllPendingChanges();if(a.length===0)return 0;const r=await this.changeTracker.compressChanges(a),s=await this.changeTracker.createUploadBatches(r);for(const n of s){if(this.syncAbortController?.signal.aborted)break;try{if(await this.uploadBatch(n),this.db)for(const i of n.changes)await this.db.change_log.update(i.id,{synced:!0});t+=n.changes.length}catch{try{await this.syncQueue.addToQueue(n.table,"batch-"+Date.now(),"UPDATE",{data:n.changes,priority:n.priority})}catch{}}}}catch(a){return console.error("Error de sincronizaci√≥n de subida:",a),0}return t}async syncDownload(e={}){let t=0,a=0;try{const r=await this.getLastSyncTimestampFromDB(),s=await this.fetchRemoteChanges(r);if(s.length===0)return{downloaded:0,conflicts:0};for(const n of s){if(this.syncAbortController?.signal.aborted)break;try{const i=await this.getLocalRecord(n.table,n.record_id);if(i&&!i.synced){const c=this.conflictResolver.resolveConflict(i,n.new_value,n.table);await this.applyResolution(n.table,n.record_id,c.resolved),a++}else await this.changeTracker.applyDeltas([n]);t++}catch(i){console.error(`Fall√≥ aplicar delta para ${n.table}:${n.record_id}`,i)}}}catch(r){return console.error("Error de sincronizaci√≥n de descarga:",r),{downloaded:0,conflicts:0}}return{downloaded:t,conflicts:a}}async verifyIntegrity(){return Promise.resolve()}async updateLastSyncTimestamp(){this.db&&await this.db.app_state.put({key:"last_sync_timestamp",value:this.lastSyncTimestamp.toString(),updated_at:Date.now()})}async getLastSyncTimestampFromDB(){if(!this.db)return 0;const e=await this.db.app_state.get("last_sync_timestamp");return e?parseInt(e.value):0}async uploadBatch(e){return new Promise(t=>setTimeout(t,100))}async fetchRemoteChanges(e){return Promise.resolve([])}async getLocalRecord(e,t){if(!this.db)return null;try{const a=this.db[e];return a?await a.get(t):null}catch{return null}}async applyResolution(e,t,a){if(!this.db)return;const r=this.db[e];r&&await r.put(a)}}class D{constructor(e){this.CACHE_NAME="pwa-data-backup",this.LOCALSTORAGE_PREFIX="pwa_backup_",this.db=e}setDatabase(e){this.db=e}async writeAtomic(e,t){const a={success:!1,layersWritten:[],errors:[]},{tableName:r,recordId:s,skipBackup:n=!1}=t;try{if(await this.writeToIndexedDB(r,s,e),a.layersWritten.push("indexeddb"),!n){try{await this.writeToLocalStorage(r,s,e),a.layersWritten.push("localstorage")}catch(i){a.errors.push(`LocalStorage: ${i}`),console.warn("‚ö†Ô∏è Escritura a LocalStorage fall√≥:",i)}try{await this.writeToCache(r,s,e),a.layersWritten.push("cache")}catch(i){a.errors.push(`Cache API: ${i}`),console.warn("‚ö†Ô∏è Escritura a Cache API fall√≥:",i)}}return a.success=!0,console.log(`‚úÖ Datos escritos a ${a.layersWritten.length} capa(s):`,a.layersWritten),a}catch(i){throw a.errors.push(`IndexedDB: ${i}`),console.error("‚ùå Escritura at√≥mica fall√≥:",i),await this.rollback(r,s,a.layersWritten),new Error(`Escritura at√≥mica fall√≥: ${i}`)}}async readWithFallback(e){const{tableName:t,recordId:a}=e;try{const r=await this.readFromIndexedDB(t,a);if(r!==null)return{success:!0,data:r,source:"indexeddb"}}catch(r){console.warn("‚ö†Ô∏è Lectura de IndexedDB fall√≥, intentando LocalStorage:",r)}try{const r=await this.readFromLocalStorage(t,a);if(r!==null)return console.log("üì¶ Datos recuperados de LocalStorage"),this.db&&await this.writeToIndexedDB(t,a,r),{success:!0,data:r,source:"localstorage"}}catch(r){console.warn("‚ö†Ô∏è Lectura de LocalStorage fall√≥, intentando Cache API:",r)}try{const r=await this.readFromCache(t,a);if(r!==null)return console.log("üíæ Datos recuperados de Cache API"),this.db&&await this.writeToIndexedDB(t,a,r),await this.writeToLocalStorage(t,a,r),{success:!0,data:r,source:"cache"}}catch(r){console.error("‚ùå Todas las capas de almacenamiento fallaron:",r)}return{success:!1,data:null,source:null,error:"Datos no encontrados en ninguna capa de almacenamiento"}}async writeToIndexedDB(e,t,a){if(!this.db)throw new Error("Base de datos no configurada en StorageManager");const r=this.db[e];if(!r)throw new Error(`Tabla ${e} no encontrada en IndexedDB`);await r.put({...a,id:t})}async readFromIndexedDB(e,t){if(!this.db)throw new Error("Base de datos no configurada en StorageManager");const a=this.db[e];if(!a)throw new Error(`Tabla ${e} no encontrada en IndexedDB`);return await a.get(t)||null}async writeToLocalStorage(e,t,a){const r=this.getLocalStorageKey(e,t),s=JSON.stringify({data:a,timestamp:Date.now(),version:1});if(new Blob([s]).size>5*1024*1024)throw new Error("Datos demasiado grandes para LocalStorage");try{localStorage.setItem(r,s)}catch(i){if(i instanceof DOMException&&i.name==="QuotaExceededError")console.warn("‚ö†Ô∏è Cuota de LocalStorage excedida, limpiando entradas antiguas"),await this.cleanOldLocalStorageEntries(),localStorage.setItem(r,s);else throw i}}async readFromLocalStorage(e,t){const a=this.getLocalStorageKey(e,t),r=localStorage.getItem(a);if(!r)return null;try{return JSON.parse(r).data}catch(s){return console.error("‚ùå Fall√≥ parsear datos de LocalStorage:",s),null}}getLocalStorageKey(e,t){return`${this.LOCALSTORAGE_PREFIX}${e}_${t}`}async cleanOldLocalStorageEntries(){const a=Object.keys(localStorage).filter(s=>s.startsWith(this.LOCALSTORAGE_PREFIX)).map(s=>{try{const n=JSON.parse(localStorage.getItem(s)||"{}");return{key:s,timestamp:n.timestamp||0}}catch{return{key:s,timestamp:0}}}).sort((s,n)=>s.timestamp-n.timestamp),r=Math.ceil(a.length*.25);for(let s=0;s<r;s++)localStorage.removeItem(a[s].key);console.log(`üßπ Limpiadas ${r} entradas antiguas de LocalStorage`)}async writeToCache(e,t,a){if(!("caches"in window))throw new Error("Cache API no soportada");const r=await caches.open(this.CACHE_NAME),s=this.getCacheUrl(e,t),n=new Response(JSON.stringify({data:a,timestamp:Date.now(),version:1}),{headers:{"Content-Type":"application/json","X-Backup-Layer":"cache-api"}});await r.put(s,n)}async readFromCache(e,t){if(!("caches"in window))throw new Error("Cache API no soportada");const a=await caches.open(this.CACHE_NAME),r=this.getCacheUrl(e,t),s=await a.match(r);if(!s)return null;try{return(await s.json()).data}catch(n){return console.error("‚ùå Fall√≥ parsear datos de Cache API:",n),null}}getCacheUrl(e,t){return`https://pwa-backup/${e}/${t}`}async rollback(e,t,a){console.warn("üîÑ Haciendo rollback de escritura parcial...");for(const r of a)try{switch(r){case"indexeddb":if(this.db){const n=this.db[e];n&&await n.delete(t)}break;case"localstorage":const s=this.getLocalStorageKey(e,t);localStorage.removeItem(s);break;case"cache":if("caches"in window){const n=await caches.open(this.CACHE_NAME),i=this.getCacheUrl(e,t);await n.delete(i)}break}}catch(s){console.error(`‚ùå Rollback fall√≥ para ${r}:`,s)}console.log("‚úÖ Rollback completado")}async clearBackups(){Object.keys(localStorage).filter(a=>a.startsWith(this.LOCALSTORAGE_PREFIX)).forEach(a=>localStorage.removeItem(a)),"caches"in window&&await caches.delete(this.CACHE_NAME),console.log("üßπ Todos los respaldos limpiados")}async getStorageStats(){const e={indexedDB:0,localStorage:0,cacheAPI:0,total:0};try{if(this.db&&this.db.getStats){const t=await this.db.getStats(),a=Object.values(t).reduce((r,s)=>r+(typeof s=="number"?s:0),0);e.indexedDB=a*1024}}catch(t){console.error("Fall√≥ obtener estad√≠sticas de IndexedDB:",t)}try{const a=Object.keys(localStorage).filter(r=>r.startsWith(this.LOCALSTORAGE_PREFIX));e.localStorage=a.reduce((r,s)=>{const n=localStorage.getItem(s)||"";return r+new Blob([n]).size},0)}catch(t){console.error("Fall√≥ obtener estad√≠sticas de LocalStorage:",t)}try{if("caches"in window){const a=await(await caches.open(this.CACHE_NAME)).keys();e.cacheAPI=a.length*1024}}catch(t){console.error("Fall√≥ obtener estad√≠sticas de Cache API:",t)}return e.total=e.indexedDB+e.localStorage+e.cacheAPI,e}}class w{constructor(e){this.sequenceCounter=0,this.lastHash="0".repeat(64),this.db=e,this.initializeSequence()}static getInstance(e){return w.instance||(w.instance=new w(e)),w.instance}setDatabase(e){this.db=e,this.initializeSequence()}async initializeSequence(){if(this.db)try{const e=await this.db.audit_log.orderBy("sequence").reverse().first();e&&(this.sequenceCounter=e.sequence,this.lastHash=e.hash)}catch(e){console.error("Fall√≥ inicializar secuencia de auditor√≠a:",e)}}async log(e){const t={tenant_id:e.tenant_id,user_id:e.user_id,device_id:e.device_id||"unknown-device",event_type:e.event_type,aggregate_type:e.aggregate_type,aggregate_id:e.aggregate_id,data:e.data,metadata:e.metadata};return this.logEvent(t)}async logEvent(e){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");this.sequenceCounter++;const t=await this.getCompleteMetadata(e.metadata),a={timestamp:Date.now(),sequence:this.sequenceCounter,tenant_id:e.tenant_id,user_id:e.user_id,device_id:e.device_id,event_type:e.event_type,aggregate_type:e.aggregate_type,aggregate_id:e.aggregate_id,data:e.data,metadata:t,previous_hash:this.lastHash,hash:""};a.hash=await this.calculateHash(a),this.lastHash=a.hash;try{return await this.db.audit_log.add(a),a}catch(r){throw console.error("Fall√≥ registrar evento de auditor√≠a:",r),r}}async calculateHash(e){const t=JSON.stringify({timestamp:e.timestamp,sequence:e.sequence,tenant_id:e.tenant_id,user_id:e.user_id,device_id:e.device_id,event_type:e.event_type,aggregate_type:e.aggregate_type,aggregate_id:e.aggregate_id,data:e.data,metadata:e.metadata,previous_hash:e.previous_hash}),r=new TextEncoder().encode(t),s=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(s)).map(c=>c.toString(16).padStart(2,"0")).join("")}async getCompleteMetadata(e){const a=(navigator.connection||navigator.mozConnection||navigator.webkitConnection)?.effectiveType||"unknown";let r=null;try{const s=await navigator.getBattery?.();s&&(r=Math.round(s.level*100))}catch{}return{ip_address:e?.ip_address||null,user_agent:typeof navigator<"u"?navigator.userAgent:"unknown",app_version:"1.0.0",latitude:e?.latitude||null,longitude:e?.longitude||null,connection_type:a,battery_level:r}}async verifyHashChain(){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");const e=[];let t="0".repeat(64);const a=await this.db.audit_log.orderBy("sequence").toArray();for(const r of a){r.previous_hash!==t&&e.push(`Evento ${r.sequence}: previous_hash no coincide. Esperado ${t}, obtenido ${r.previous_hash}`);const s=await this.calculateHash(r);s!==r.hash&&e.push(`Evento ${r.sequence}: hash no coincide. Esperado ${r.hash}, calculado ${s}`),t=r.hash}return{valid:e.length===0,errors:e}}async reconstructState(e,t,a){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");const r=await this.db.audit_log.where("aggregate_type").equals(e).toArray(),s=a||Date.now(),n=r.filter(c=>c.aggregate_id===t&&c.timestamp<=s).sort((c,d)=>c.timestamp-d.timestamp);let i=null;for(const c of n)switch(c.event_type){case"CREATE":i={...c.data};break;case"UPDATE":i&&(i={...i,...c.data});break;case"DELETE":i=null;break}return i}async detectFraudPatterns(e,t=36e5){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");const a=[],r=Date.now(),s=r-t,n=await this.db.audit_log.where("[user_id+timestamp]").between([e,s],[e,r]).toArray(),i=n.filter(o=>o.event_type==="CREATE"&&o.aggregate_type==="pago"&&o.timestamp>r-3e5);i.length>10&&a.push({type:"rapid_payments",severity:"high",description:`${i.length} pagos en 5 minutos`,events:i});const c=n.filter(o=>o.event_type==="CREATE"&&o.aggregate_type==="pago"&&o.metadata.latitude&&o.metadata.longitude).sort((o,l)=>o.timestamp-l.timestamp);for(let o=1;o<c.length;o++){const l=c[o-1],p=c[o],h=p.timestamp-l.timestamp,m=this.calculateDistance(l.metadata.latitude,l.metadata.longitude,p.metadata.latitude,p.metadata.longitude);m>100&&h<6e5&&a.push({type:"impossible_location",severity:"high",description:`Se movi√≥ ${m.toFixed(1)}km en ${(h/6e4).toFixed(1)} minutos`,events:[l,p]})}const d=n.filter(o=>o.event_type==="CREATE"&&o.aggregate_type==="pago");for(let o=0;o<d.length;o++)for(let l=o+1;l<d.length;l++){const p=d[o],h=d[l];p.data&&h.data&&p.data.cliente_id===h.data.cliente_id&&p.data.monto===h.data.monto&&Math.abs(p.timestamp-h.timestamp)<6e4&&a.push({type:"duplicate_payment",severity:"medium",description:`Pago duplicado de ${p.data.monto} para el mismo cliente`,events:[p,h]})}const u=d.filter(o=>o.data&&o.data.monto&&o.data.monto>1e6);return u.length>0&&a.push({type:"suspicious_amount",severity:"medium",description:`${u.length} pago(s) sobre 1M`,events:u}),a}calculateDistance(e,t,a,r){const n=this.toRad(a-e),i=this.toRad(r-t),c=Math.sin(n/2)*Math.sin(n/2)+Math.cos(this.toRad(e))*Math.cos(this.toRad(a))*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}toRad(e){return e*(Math.PI/180)}async getEventsForAggregate(e,t){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");return this.db.audit_log.where("[aggregate_type+aggregate_id+timestamp]").between([e,t,0],[e,t,Date.now()]).toArray()}async getEventsForUser(e,t=100){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");return this.db.audit_log.where("user_id").equals(e).reverse().limit(t).toArray()}async getRecentEvents(e=100){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");return this.db.audit_log.orderBy("timestamp").reverse().limit(e).toArray()}async countEventsByType(){if(!this.db)throw new Error("Base de datos no configurada en AuditLogger");const e=await this.db.audit_log.toArray(),t={};for(const a of e)t[a.event_type]=(t[a.event_type]||0)+1;return t}}class y{constructor(){this.encryptionKey=null,this.userPin=null}static getInstance(){return y.instance||(y.instance=new y),y.instance}async initializeWithPin(e,t={}){if(!e||e.length<4)throw new Error("El PIN debe tener al menos 4 caracteres");this.userPin=e;const a=crypto.getRandomValues(new Uint8Array(16)),r=t.iterations||1e5;this.encryptionKey=await this.deriveKeyFromPin(e,a,r),console.log("üîê Servicio de encriptaci√≥n inicializado")}async deriveKeyFromPin(e,t,a){const r=await crypto.subtle.importKey("raw",new TextEncoder().encode(e),"PBKDF2",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:new Uint8Array(t),iterations:a,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async encrypt(e){if(!this.encryptionKey)throw new Error("Servicio de encriptaci√≥n no inicializado. Llama initializeWithPin() primero.");if(!e||typeof e!="string")throw new Error("Los datos deben ser un string no vac√≠o");const t=crypto.getRandomValues(new Uint8Array(12)),a=crypto.getRandomValues(new Uint8Array(16)),r=await this.deriveKeyFromPin(this.userPin,a,1e5),s=new TextEncoder().encode(e),n=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},r,s);return{data:this.arrayBufferToBase64(n),iv:this.arrayBufferToBase64(t.buffer),salt:this.arrayBufferToBase64(a.buffer)}}async decrypt(e){if(!this.userPin)throw new Error("Servicio de encriptaci√≥n no inicializado. Llama initializeWithPin() primero.");if(!e||!e.data||!e.iv||!e.salt)throw new Error("Formato de datos encriptados inv√°lido");try{const t=this.base64ToArrayBuffer(e.data),a=this.base64ToArrayBuffer(e.iv),r=this.base64ToArrayBuffer(e.salt),s=await this.deriveKeyFromPin(this.userPin,new Uint8Array(r),1e5),n=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(a)},s,new Uint8Array(t));return new TextDecoder().decode(n)}catch(t){throw new Error(`Desencriptaci√≥n fall√≥: ${t instanceof Error?t.message:"Error desconocido"}`)}}async encryptSensitiveFields(e){if(!e||typeof e!="object")return e;const t={...e};for(const a of y.SENSITIVE_FIELDS)if(t[a]&&typeof t[a]=="string")try{t[a]=await this.encrypt(t[a])}catch(r){console.error(`Fall√≥ encriptar campo ${a}:`,r)}return t}async decryptSensitiveFields(e){if(!e||typeof e!="object")return e;const t={...e};for(const a of y.SENSITIVE_FIELDS)if(t[a]&&typeof t[a]=="object"&&t[a].data)try{t[a]=await this.decrypt(t[a])}catch(r){console.error(`Fall√≥ desencriptar campo ${a}:`,r)}return t}static isSensitiveField(e){return y.SENSITIVE_FIELDS.includes(e)}static isEncrypted(e){return!!(e&&typeof e=="object"&&typeof e.data=="string"&&typeof e.iv=="string"&&typeof e.salt=="string")}clearEncryptionKey(){this.encryptionKey=null,this.userPin=null,console.log("üßπ Clave de encriptaci√≥n limpiada de la memoria")}isInitialized(){return this.encryptionKey!==null&&this.userPin!==null}static getSensitiveFields(){return[...y.SENSITIVE_FIELDS]}arrayBufferToBase64(e){const t=new Uint8Array(e);let a="";for(let r=0;r<t.byteLength;r++)a+=String.fromCharCode(t[r]);return btoa(a)}base64ToArrayBuffer(e){const t=atob(e),a=new Uint8Array(t.length);for(let r=0;r<t.length;r++)a[r]=t.charCodeAt(r);return a.buffer}}y.SENSITIVE_FIELDS=["numero_documento","telefono","telefono_2","telefono_fiador","direccion","barrio","referencia","nombre_fiador"];class b{constructor(e){this.config=e,this.supabase=null,this.currentUser=null,this.currentSession=null,this.initialized=!1}async initialize(){if(!this.initialized)try{this.supabase=k(this.config.supabaseUrl,this.config.supabaseKey);const{data:{session:e},error:t}=await this.supabase.auth.getSession();t?console.warn("Error obteniendo sesi√≥n:",t.message):e&&(this.currentSession=e,this.currentUser=e.user,console.log("‚úÖ Sesi√≥n existente restaurada")),this.supabase.auth.onAuthStateChange((a,r)=>{console.log("üîê Auth state change:",a),this.currentSession=r,this.currentUser=r?.user||null}),this.initialized=!0,console.log("‚úÖ AuthService inicializado")}catch(e){throw console.error("‚ùå Error inicializando AuthService:",e),e}}async signIn(e,t){if(!this.supabase)throw new Error("AuthService no est√° inicializado");try{const{data:a,error:r}=await this.supabase.auth.signInWithPassword({email:e,password:t});return r?{user:null,session:null,error:new Error(r.message)}:(this.currentUser=a.user,this.currentSession=a.session,{user:a.user,session:a.session,error:null})}catch(a){return{user:null,session:null,error:a instanceof Error?a:new Error("Error desconocido en signIn")}}}async signUp(e,t,a){if(!this.supabase)throw new Error("AuthService no est√° inicializado");try{const{data:r,error:s}=await this.supabase.auth.signUp({email:e,password:t,options:a});return s?{user:null,session:null,error:new Error(s.message)}:(this.currentUser=r.user,this.currentSession=r.session,{user:r.user,session:r.session,error:null})}catch(r){return{user:null,session:null,error:r instanceof Error?r:new Error("Error desconocido en signUp")}}}async signOut(){if(!this.supabase)throw new Error("AuthService no est√° inicializado");try{const{error:e}=await this.supabase.auth.signOut();return e?{error:new Error(e.message)}:(this.currentUser=null,this.currentSession=null,{error:null})}catch(e){return{error:e instanceof Error?e:new Error("Error desconocido en signOut")}}}getCurrentUser(){return this.currentUser}getCurrentSession(){return this.currentSession}isAuthenticated(){return this.currentUser!==null&&this.currentSession!==null}getAccessToken(){return this.currentSession?.access_token||null}async refreshSession(){if(!this.supabase)throw new Error("AuthService no est√° inicializado");try{const{data:e,error:t}=await this.supabase.auth.refreshSession();return t?{user:null,session:null,error:new Error(t.message)}:(this.currentUser=e.user,this.currentSession=e.session,{user:e.user,session:e.session,error:null})}catch(e){return{user:null,session:null,error:e instanceof Error?e:new Error("Error desconocido en refreshSession")}}}isInitialized(){return this.initialized}getSupabaseClient(){return this.supabase}}class P{async calculateChecksum(e){try{const t=JSON.stringify(this.canonicalize(e)),r=new TextEncoder().encode(t),s=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(s)).map(c=>c.toString(16).padStart(2,"0")).join("")}catch(t){throw console.error("Error calculando checksum:",t),new Error(`Fall√≥ el c√°lculo de checksum: ${t}`)}}canonicalize(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(r=>this.canonicalize(r));const t={},a=Object.keys(e).sort();for(const r of a)r!=="checksum"&&(t[r]=this.canonicalize(e[r]));return t}async calculatePagoChecksum(e){const t={id:e.id,tenant_id:e.tenant_id,credito_id:e.credito_id,cliente_id:e.cliente_id,cobrador_id:e.cobrador_id,monto:e.monto,fecha:e.fecha,latitud:e.latitud,longitud:e.longitud,observaciones:e.observaciones,created_at:e.created_at,created_by:e.created_by,device_id:e.device_id};return this.calculateChecksum(t)}async calculateCreditoChecksum(e){const t={id:e.id,tenant_id:e.tenant_id,cliente_id:e.cliente_id,producto_id:e.producto_id,monto_original:e.monto_original,interes_porcentaje:e.interes_porcentaje,total_a_pagar:e.total_a_pagar,numero_cuotas:e.numero_cuotas,fecha_desembolso:e.fecha_desembolso,created_at:e.created_at,created_by:e.created_by};return this.calculateChecksum(t)}async calculateClienteChecksum(e){const t={id:e.id,tenant_id:e.tenant_id,numero_documento:e.numero_documento,nombre:e.nombre,created_at:e.created_at,created_by:e.created_by};return this.calculateChecksum(t)}async verifyPagoChecksum(e){const t=e.checksum,a=await this.calculatePagoChecksum(e);return{valid:t===a,expected:t,actual:a,corrupted:t!==a}}async verifyCreditoChecksum(e){const t=e.checksum,a=await this.calculateCreditoChecksum(e);return{valid:t===a,expected:t,actual:a,corrupted:t!==a}}async verifyClienteChecksum(e){const t=e.checksum,a=await this.calculateClienteChecksum(e);return{valid:t===a,expected:t,actual:a,corrupted:t!==a}}async storeChecksum(e,t,a,r){if(!r)throw new Error("Base de datos requerida para almacenar checksum");const s={record_key:`${e}:${t}`,checksum:a,timestamp:Date.now()};await r.checksums.put(s)}async getStoredChecksum(e,t,a){if(!a)throw new Error("Base de datos requerida para recuperar checksum");return(await a.checksums.get(`${e}:${t}`))?.checksum||null}async performIntegrityCheck(e){if(!e)throw new Error("Base de datos requerida para verificaci√≥n de integridad");const t={total:0,valid:0,corrupted:0,missing:0,repaired:0,errors:[]};try{const a=await this.checkPagosIntegrity(e);t.total+=a.total,t.valid+=a.valid,t.corrupted+=a.corrupted,t.missing+=a.missing,t.repaired+=a.repaired,t.errors.push(...a.errors);const r=await this.checkCreditosIntegrity(e);t.total+=r.total,t.valid+=r.valid,t.corrupted+=r.corrupted,t.missing+=r.missing,t.repaired+=r.repaired,t.errors.push(...r.errors);const s=await this.checkClientesIntegrity(e);t.total+=s.total,t.valid+=s.valid,t.corrupted+=s.corrupted,t.missing+=s.missing,t.repaired+=s.repaired,t.errors.push(...s.errors),console.log("‚úÖ Verificaci√≥n de integridad completada:",t)}catch(a){console.error("‚ùå Verificaci√≥n de integridad fall√≥:",a),t.errors.push({recordType:"system",recordId:"integrity_check",error:`Verificaci√≥n de integridad fall√≥: ${a}`,timestamp:Date.now()})}return t}async checkPagosIntegrity(e){const t={total:0,valid:0,corrupted:0,missing:0,repaired:0,errors:[]},a=await e.pagos.toArray();t.total=a.length;for(const r of a)try{if(!r.checksum){t.missing++;const n=await this.calculatePagoChecksum(r);await e.pagos.update(r.id,{checksum:n}),t.repaired++;continue}const s=await this.verifyPagoChecksum(r);s.valid?t.valid++:(t.corrupted++,t.errors.push({recordType:"pago",recordId:r.id,error:`Checksum no coincide: esperado ${s.expected}, obtenido ${s.actual}`,timestamp:Date.now()}))}catch(s){t.errors.push({recordType:"pago",recordId:r.id,error:`Verificaci√≥n fall√≥: ${s}`,timestamp:Date.now()})}return t}async checkCreditosIntegrity(e){const t={total:0,valid:0,corrupted:0,missing:0,repaired:0,errors:[]},a=await e.creditos.toArray();t.total=a.length;for(const r of a)try{if(!r.checksum){t.missing++;const n=await this.calculateCreditoChecksum(r);await e.creditos.update(r.id,{checksum:n}),t.repaired++;continue}const s=await this.verifyCreditoChecksum(r);s.valid?t.valid++:(t.corrupted++,t.errors.push({recordType:"credito",recordId:r.id,error:`Checksum no coincide: esperado ${s.expected}, obtenido ${s.actual}`,timestamp:Date.now()}))}catch(s){t.errors.push({recordType:"credito",recordId:r.id,error:`Verificaci√≥n fall√≥: ${s}`,timestamp:Date.now()})}return t}async checkClientesIntegrity(e){const t={total:0,valid:0,corrupted:0,missing:0,repaired:0,errors:[]},a=await e.clientes.toArray();t.total=a.length;for(const r of a)try{if(!r.checksum){t.missing++;const n=await this.calculateClienteChecksum(r);await e.clientes.update(r.id,{checksum:n}),t.repaired++;continue}const s=await this.verifyClienteChecksum(r);s.valid?t.valid++:(t.corrupted++,t.errors.push({recordType:"cliente",recordId:r.id,error:`Checksum no coincide: esperado ${s.expected}, obtenido ${s.actual}`,timestamp:Date.now()}))}catch(s){t.errors.push({recordType:"cliente",recordId:r.id,error:`Verificaci√≥n fall√≥: ${s}`,timestamp:Date.now()})}return t}startPeriodicChecks(e,t=300*1e3){return console.log(`üîç Iniciando verificaciones peri√≥dicas de integridad cada ${t/1e3} segundos`),setInterval(async()=>{console.log("üîç Ejecutando verificaci√≥n peri√≥dica de integridad...");const a=await this.performIntegrityCheck(e);a.corrupted>0&&console.warn(`‚ö†Ô∏è Se encontraron ${a.corrupted} registros corruptos`),a.repaired>0&&console.log(`‚úÖ Se repararon ${a.repaired} registros`)},t)}stopPeriodicChecks(e){clearInterval(e),console.log("üõë Se detuvieron las verificaciones peri√≥dicas de integridad")}}function M(g){const t={...{appName:"sync-app",encryptionEnabled:!0,auditEnabled:!0,syncInterval:3e4,databaseName:void 0,logLevel:"info"},...g},a=I(),r=new P,s=new v(a),n=new E,i=new S(a),c=new B(a),d=new D(a),u=w.getInstance(a),o=y.getInstance();let l;if(t.supabase?.url&&t.supabase?.anonKey)l=new b({supabaseUrl:t.supabase.url,supabaseKey:t.supabase.anonKey});else if(t.supabaseUrl&&t.supabaseKey)l=new b({supabaseUrl:t.supabaseUrl,supabaseKey:t.supabaseKey});else throw new Error("Configuraci√≥n de Supabase requerida para el servicio de autenticaci√≥n");c.setDatabase(a),d.setDatabase(a),u.setDatabase(a);const p={db:a,checksum:r,sync:c,syncQueue:s,conflictResolver:n,changeTracker:i,storage:d,audit:u,encryption:o,auth:l};let h=!1,m=null;const _={services:p,config:t,isStarted:!1,async start(){if(h){console.warn(`‚ö†Ô∏è ${t.appName} ya est√° iniciado`);return}try{console.log(`üöÄ Iniciando ${t.appName}...`),await a.initialize(),console.log("‚úÖ Base de datos inicializada"),await l.initialize(),console.log("‚úÖ Servicio de autenticaci√≥n inicializado"),t.encryptionEnabled&&console.log("üîê Encriptaci√≥n habilitada (requiere PIN del usuario)"),t.auditEnabled&&console.log("üìã Sistema de auditor√≠a habilitado"),(t.supabase?.url||t.supabaseUrl)&&t.syncInterval&&(m=setInterval(async()=>{try{c.isOnline()&&!c.isCurrentlySyncing()&&await c.sync()}catch(f){console.error("Error en sincronizaci√≥n autom√°tica:",f)}},t.syncInterval),console.log(`üîÑ Sincronizaci√≥n autom√°tica cada ${t.syncInterval}ms`)),h=!0,_.isStarted=!0,console.log(`‚úÖ ${t.appName} iniciado exitosamente`)}catch(f){throw console.error(`‚ùå Error iniciando ${t.appName}:`,f),f}},async stop(){if(!h){console.warn(`‚ö†Ô∏è ${t.appName} no est√° iniciado`);return}try{console.log(`üõë Deteniendo ${t.appName}...`),m&&(clearInterval(m),m=null,console.log("üîÑ Sincronizaci√≥n autom√°tica detenida")),c.isCurrentlySyncing()&&(await c.cancelSync(),console.log("üö´ Sincronizaci√≥n en curso cancelada")),t.encryptionEnabled&&(o.clearEncryptionKey(),console.log("üßπ Claves de encriptaci√≥n limpiadas")),await a.close(),console.log("üóÑÔ∏è Base de datos cerrada"),h=!1,_.isStarted=!1,console.log(`‚úÖ ${t.appName} detenido exitosamente`)}catch(f){throw console.error(`‚ùå Error deteniendo ${t.appName}:`,f),f}},async getStatus(){const f=await s.getQueueSize(),C=await a.getStats();return{isStarted:h,isOnline:c.isOnline(),isSyncing:c.isCurrentlySyncing(),queueSize:f,lastSync:c.getLastSyncTimestamp(),encryptionReady:o.isInitialized(),dbStats:C}},async clearData(){if(h)throw new Error("No se puede limpiar datos mientras la aplicaci√≥n est√° iniciada");console.log("üßπ Limpiando todos los datos..."),await a.clearAll(),await d.clearBackups(),console.log("‚úÖ Todos los datos limpiados")}};return _}export{M as c};
