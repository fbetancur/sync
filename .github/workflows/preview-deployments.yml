name: Preview Deployments

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  # Job 1: Detectar cambios en PR
  detect-pr-changes:
    name: Detect PR Changes
    runs-on: ubuntu-latest
    outputs:
      credisync: ${{ steps.changes.outputs.credisync }}
      packages: ${{ steps.changes.outputs.packages }}
      should_deploy: ${{ steps.should_deploy.outputs.result }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            credisync:
              - 'apps/credisync/**'
            packages:
              - 'packages/@sync/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'

      - name: Should deploy?
        id: should_deploy
        run: |
          if [ "${{ steps.changes.outputs.credisync }}" = "true" ] || [ "${{ steps.changes.outputs.packages }}" = "true" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  # Job 2: Preview deployment de CrediSync
  preview-credisync:
    name: Preview CrediSync
    runs-on: ubuntu-latest
    needs: detect-pr-changes
    if: needs.detect-pr-changes.outputs.should_deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build:packages

      - name: Test CrediSync
        run: pnpm test:credisync

      - name: Build CrediSync
        run: pnpm build:credisync

      - name: Comment PR with preview info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üöÄ Preview Deployment')
            );

            const body = `üöÄ **Preview Deployment Ready!**

            üì± **CrediSync Preview**: Vercel will automatically deploy this PR

            **Changes detected:**
            ${{ needs.detect-pr-changes.outputs.credisync == 'true' && '‚úÖ CrediSync app changes' || '' }}
            ${{ needs.detect-pr-changes.outputs.packages == 'true' && '‚úÖ Shared packages changes' || '' }}

            **Status:**
            ‚úÖ Tests passed
            ‚úÖ Build successful  
            ‚úÖ Ready for review

            The preview URL will be available once Vercel completes the deployment.`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # Job 3: No deployment needed
  no-deployment:
    name: No Deployment Needed
    runs-on: ubuntu-latest
    needs: detect-pr-changes
    if: needs.detect-pr-changes.outputs.should_deploy == 'false'

    steps:
      - name: Comment PR - No deployment needed
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment')
            );

            const body = `‚è≠Ô∏è **No Preview Deployment Needed**

            This PR doesn't contain changes that affect CrediSync or shared packages.

            **Files changed:** Documentation, configuration, or other non-app files

            ‚úÖ No deployment required`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
